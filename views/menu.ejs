<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Menu - Panda Express</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
      }
      .sidebar {
        width: 200px;
        background: #f4f4f4;
        padding: 20px;
        height: 100vh;
        border-right: 1px solid #ddd;
      }
      .sidebar h2 {
        margin-top: 0;
        font-size: 1.5em;
        color: #d32f2f;
      }
      .sidebar ul {
        list-style: none;
        padding: 0;
      }
      .sidebar li {
        margin: 15px 0;
      }
      .sidebar a {
        text-decoration: none;
        color: #333;
        font-weight: bold;
        font-size: 1.1em;
        cursor: pointer;
        padding: 8px 12px;
        display: block;
        border-radius: 4px;
        transition: background 0.2s;
      }
      .sidebar a:hover,
      .sidebar a.active {
        background: #d32f2f;
        color: white;
      }
      .content {
        flex: 1;
        padding: 30px;
      }
      .category-section {
        display: none;
      }
      .category-section.active {
        display: block;
      }

      /* ---------- NEW GRID & CUBE BUTTONS ---------- */
      .menu-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }
      .cube-btn {
        background: #fff;
        border: 1px solid #eee;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
        text-align: center;
        display: flex;
        flex-direction: column;
        height: 100%; /* fill grid cell */
      }
      .cube-btn:hover {
        transform: translateY(-4px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      }
      .cube-img {
        width: 100%;
        height: 120px;
        object-fit: cover;
        display: block;
        background:
                /* fallback SVG – shows instantly, no file needed */ url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'%3E%3Crect width='120' height='120' fill='%23f0f0f0'/%3E%3Ctext x='60' y='70' font-family='Arial' font-size='16' text-anchor='middle' fill='%23999'%3ENo Image%3C/text%3E%3C/svg%3E")
          center / contain no-repeat;
      }
      .cube-info {
        padding: 10px 8px;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }
      .cube-name {
        font-weight: bold;
        font-size: 1em;
        color: #333;
      }
      .cube-price {
        color: #d32f2f;
        font-weight: bold;
        margin-top: 4px;
      }
      .back-link {
        margin-top: 30px;
        display: inline-block;
        padding: 10px 20px;
        background: #333;
        color: white;
        text-decoration: none;
        border-radius: 4px;
      }
      .back-link:hover {
        background: #555;
      }
    </style>
  </head>
  <body>
    <!-- Sidebar (unchanged) -->
    <div class="sidebar">
      <h2>Panda Express</h2>
      <ul>
        <li><a data-category="entrees" class="active">Entrees</a></li>
        <li><a data-category="a_la_carte">A La Carte</a></li>
        <li><a data-category="sides">Sides</a></li>
        <li><a data-category="appetizers">Appetizers</a></li>
      </ul>
    </div>

    <!-- Main Content -->
    <div class="content">
      <h1 id="category-title">Entrees</h1>

      <!-- Entrees -->
      <div id="entrees" class="category-section active">
        <div class="menu-grid">
          <% menu.entrees.forEach(item => { %>
          <button class="cube-btn" data-name="<%= item.name %>">
            <img
              src="/images/<%= item.name.toLowerCase().replace(/ /g,'-') %>.jpg"
              alt="<%= item.name %>"
              class="cube-img"
            />
            <div class="cube-info">
              <div class="cube-name"><%= item.name %></div>
              <div class="cube-price">$<%= item.price.toFixed(2) %></div>
            </div>
          </button>
          <% }); %>
        </div>
      </div>

      <!-- A La Carte -->
      <div id="a_la_carte" class="category-section">
        <div class="menu-grid">
          <% menu.a_la_carte.forEach(item => { %>
          <button class="cube-btn" data-name="<%= item.name %>">
            <img
              src="/images/<%= item.name.toLowerCase().replace(/ /g,'-') %>.jpg"
              alt="<%= item.name %>"
              class="cube-img"
            />
            <div class="cube-info">
              <div class="cube-name"><%= item.name %></div>
              <div class="cube-price">$<%= item.price.toFixed(2) %></div>
            </div>
          </button>
          <% }); %>
        </div>
      </div>

      <!-- Sides -->
      <div id="sides" class="category-section">
        <div class="menu-grid">
          <% menu.sides.forEach(item => { %>
          <button class="cube-btn" data-name="<%= item.name %>">
            <img
              src="/images/<%= item.name.toLowerCase().replace(/ /g,'-') %>.jpg"
              alt="<%= item.name %>"
              class="cube-img"
            />
            <div class="cube-info">
              <div class="cube-name"><%= item.name %></div>
              <div class="cube-price">$<%= item.price.toFixed(2) %></div>
            </div>
          </button>
          <% }); %>
        </div>
      </div>

      <!-- Appetizers -->
      <div id="appetizers" class="category-section">
        <div class="menu-grid">
          <% menu.appetizers.forEach(item => { %>
          <button class="cube-btn" data-name="<%= item.name %>">
            <img
              src="/images/<%= item.name.toLowerCase().replace(/ /g,'-') %>.jpg"
              alt="<%= item.name %>"
              class="cube-img"
            />
            <div class="cube-info">
              <div class="cube-name"><%= item.name %></div>
              <div class="cube-price">$<%= item.price.toFixed(2) %></div>
            </div>
          </button>
          <% }); %>
        </div>
      </div>

      <a href="/order" class="back-link">Next</a>
    </div>

    <script>
      // ---------- TAB SWITCHING (unchanged) ----------
      document.querySelectorAll(".sidebar a").forEach((link) => {
        link.addEventListener("click", function (e) {
          e.preventDefault();
          document
            .querySelectorAll(".sidebar a")
            .forEach((a) => a.classList.remove("active"));
          document
            .querySelectorAll(".category-section")
            .forEach((sec) => sec.classList.remove("active"));
          this.classList.add("active");
          const cat = this.getAttribute("data-category");
          document.getElementById(cat).classList.add("active");
          const titles = {
            entrees: "Entrees",
            a_la_carte: "A La Carte",
            sides: "Sides",
            appetizers: "Appetizers",
          };
          document.getElementById("category-title").textContent = titles[cat];
        });
      });

    </script>
    <%- include('partials/cart-modal') %>

    <!-- Fixed cart widget (bottom-right) -->
    <div id="cart-widget" style="position:fixed;bottom:20px;right:20px;background:#d32f2f;color:#fff;padding:12px 18px;border-radius:50px;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.2);font-weight:bold;z-index:1000;">
      <span id="cart-count">0</span> items – $<span id="cart-total">0.00</span>
    </div>

    <!-- Toast notification -->
    <div id="toast" style="position:fixed;bottom:80px;right:20px;background:#333;color:#fff;padding:12px 20px;border-radius:4px;opacity:0;transition:opacity .3s;z-index:1001;pointer-events:none;">
      <span id="toast-msg"></span>
    </div>

    <script>
      // -------------------------------------------------
      // CART LOGIC (client side)
      // -------------------------------------------------
      const cartWidget = document.getElementById('cart-widget');
      const cartCount   = document.getElementById('cart-count');
      const cartTotal   = document.getElementById('cart-total');
      const toast       = document.getElementById('toast');
      const toastMsg    = document.getElementById('toast-msg');

      // Show toast for 2 s
      function showToast(message) {
        toastMsg.textContent = message;
        toast.style.opacity = 1;
        setTimeout(() => toast.style.opacity = 0, 2000);
      }

      // Update widget numbers
      async function refreshCartWidget() {
        const res = await fetch('/api/cart');
        const {cart} = await res.json();
        const count = cart.reduce((s,i)=>s+i.quantity,0);
        const total = cart.reduce((s,i)=>s+i.price*i.quantity,0).toFixed(2);
        cartCount.textContent = count;
        cartTotal.textContent = total;
      }

      // Add item (called from every cube button)
      async function addToCart(name, price) {
        const res = await fetch('/api/cart/add', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({name, price})
        });
        const data = await res.json();
        if (data.success) {
          showToast(`${name} added to cart`);
          refreshCartWidget();
        }
      }

      // -------------------------------------------------
      // BUTTON CLICK → add to cart (instead of redirect)
      // -------------------------------------------------
      document.querySelectorAll('.cube-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const name = btn.dataset.name;
          const priceText = btn.querySelector('.cube-price').textContent; // "$12.30"
          const price = parseFloat(priceText.replace('$',''));
          addToCart(name, price);
        });
      });

      // -------------------------------------------------
      // CART WIDGET → open modal
      // -------------------------------------------------
      const modal = document.getElementById('cart-modal');
      const closeBtn = modal.querySelector('.close');

      cartWidget.addEventListener('click', async () => {
        const res = await fetch('/api/cart');
        const {cart} = await res.json();

        const itemsDiv = document.getElementById('cart-items');
        itemsDiv.innerHTML = '';

        let subtotal = 0;
        cart.forEach(itm => {
          const line = document.createElement('div');
          line.className = 'cart-item';
          line.innerHTML = `
            <span>${itm.name} <span class="qty">×${itm.quantity}</span></span>
            <span>$${(itm.price*itm.quantity).toFixed(2)}</span>
          `;
          itemsDiv.appendChild(line);
          subtotal += itm.price * itm.quantity;
        });


        document.getElementById('cart-totals').innerHTML = `
          <strong>Total: $${subtotal.toFixed(2)}</strong>
        `;

        modal.style.display = 'flex';
      });

      closeBtn.onclick = () => modal.style.display = 'none';
      window.onclick = (e) => { if (e.target === modal) modal.style.display = 'none'; };

      // Continue button → go to the old /order page (you can change the URL)
      document.getElementById('cart-continue').onclick = () => {
        location.href = '/order';
      };

      // Clear cart
      document.getElementById('cart-clear').onclick = async () => {
        await fetch('/api/cart/clear', {method:'DELETE'});
        refreshCartWidget();
        modal.style.display = 'none';
        showToast('Cart cleared');
      };

      // Initial load
      refreshCartWidget();
    </script>
  </body>
</html>
