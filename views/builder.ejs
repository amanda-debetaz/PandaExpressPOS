<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Build Your Meal</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>



<style>
  /* Large text size (default) */
  html.text-size-large {
    font-size: 19px !important;
  }
  html.text-size-large button {
    font-size: 1.6rem !important;
    padding: 1rem 1.5rem !important;
  }
  html.text-size-large .text-xs { font-size: 1.1rem !important; }
  html.text-size-large .text-sm { font-size: 1.4rem !important; }
  html.text-size-large .text-base { font-size: 1.6rem !important; }
  html.text-size-large .text-lg { font-size: 2rem !important; }
  html.text-size-large .text-xl { font-size: 2.6rem !important; }
  html.text-size-large .text-2xl { font-size: 3.2rem !important; }
  html.text-size-large .text-3xl { font-size: 4rem !important; }
  html.text-size-large #side-total,
  html.text-size-large #entree-count { font-size: 2.6rem !important; }
  html.text-size-large header h1 { font-size: 4rem !important; line-height: 1.2 !important; }
  html.text-size-large section > div:first-child { font-size: 2.4rem !important; }
  html.text-size-large #side-hint { font-size: 1.6rem !important; }
  html.text-size-large footer button { padding: 1.6rem 3rem !important; font-size: 1.9rem !important; }

  /* Medium text size */
  html.text-size-medium {
    font-size: 16px !important;
  }
  html.text-size-medium button {
    font-size: 1.3rem !important;
    padding: 0.8rem 1.2rem !important;
  }
  html.text-size-medium .text-xs { font-size: 0.9rem !important; }
  html.text-size-medium .text-sm { font-size: 1.1rem !important; }
  html.text-size-medium .text-base { font-size: 1.3rem !important; }
  html.text-size-medium .text-lg { font-size: 1.6rem !important; }
  html.text-size-medium .text-xl { font-size: 2rem !important; }
  html.text-size-medium .text-2xl { font-size: 2.5rem !important; }
  html.text-size-medium .text-3xl { font-size: 3rem !important; }
  html.text-size-medium #side-total,
  html.text-size-medium #entree-count { font-size: 2rem !important; }
  html.text-size-medium header h1 { font-size: 3rem !important; line-height: 1.2 !important; }
  html.text-size-medium section > div:first-child { font-size: 1.9rem !important; }
  html.text-size-medium #side-hint { font-size: 1.3rem !important; }
  html.text-size-medium footer button { padding: 1.3rem 2.5rem !important; font-size: 1.5rem !important; }

  /* Small text size */
  html.text-size-small {
    font-size: 12px !important;
  }
  html.text-size-small button {
    font-size: 1rem !important;
    padding: 0.6rem 0.9rem !important;
  }
  html.text-size-small .text-xs { font-size: 0.7rem !important; }
  html.text-size-small .text-sm { font-size: 0.85rem !important; }
  html.text-size-small .text-base { font-size: 1rem !important; }
  html.text-size-small .text-lg { font-size: 1.2rem !important; }
  html.text-size-small .text-xl { font-size: 1.5rem !important; }
  html.text-size-small .text-2xl { font-size: 1.9rem !important; }
  html.text-size-small .text-3xl { font-size: 2.3rem !important; }
  html.text-size-small #side-total,
  html.text-size-small #entree-count { font-size: 1.6rem !important; }
  html.text-size-small header h1 { font-size: 2.3rem !important; line-height: 1.2 !important; }
  html.text-size-small section > div:first-child { font-size: 1.4rem !important; }
  html.text-size-small #side-hint { font-size: 1rem !important; }
  html.text-size-small footer button { padding: 1rem 2rem !important; font-size: 1.2rem !important; }
</style>

<style>
  /* Prevent content bleeding over footer */
  main {
    padding-bottom: 100px;
  }
  footer {
    z-index: 50;
  }
  /* Ensure badges don't overlap footer */
  .relative button {
    position: relative;
    z-index: 1;
  }
</style>

<body class="min-h-screen bg-neutral-50 text-black">
  <header class="w-full bg-red-700 text-white border-b border-red-800">
    <div class="max-w-6xl mx-auto px-6 py-5 flex items-center justify-between">
      <div class="flex items-center gap-4">
        <img src="/images/panda_logo.png" alt="Panda Express" class="w-20 h-20">
        <div>
        <div class="text-xs uppercase tracking-[0.25em] text-red-100 font-semibold" data-original="Panda Express">Panda Express</div>
        <h1 id="builder-title" class="text-2xl font-semibold mt-1">
          <%= (typeof isEdit !== 'undefined' && isEdit) ? 'Edit' : 'Build' %> Your 
          <%= type === 'bowl' ? 'Bowl' : (type === 'bigger-plate' ? 'Bigger Plate' : 'Plate') %>
        </h1>
        </div>
      </div>
      <a href="#" onclick="localStorage.setItem('kiosk_from_builder', 'true'); window.location.href='/kiosk'; return false;" class="text-sm text-red-100 hover:text-white" data-original="Back to Menu">Back to Menu</a>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-2 gap-8">
    <section>
      <div class="text-sm uppercase tracking-[0.2em] text-red-700 font-bold mb-3" 
           data-original="Side (total 1)">Side (total 1)</div>
      
      <div id="side-hint" class="text-xs text-neutral-700 mb-2" 
           data-original="Select one full side.">Select one full side.</div>

      <div id="sides" class="grid grid-cols-2 gap-4"></div>
      
      <div class="mt-3 text-xs text-neutral-700">
        <span data-original="Selected:">Selected:</span> 
        <span id="side-total" class="font-bold text-red-700">0</span>/1
      </div>
    </section>

    <section>
      <div class="text-sm uppercase tracking-[0.2em] text-red-700 font-bold mb-3" 
           data-original="Entrees">Entrees</div>
      
      <div class="text-xs text-neutral-700 mb-2">
        <span data-original="Choose up to">Choose up to</span> 
        <span id="entree-max">1</span> ‚Ä¢ 
        <span class="text-yellow-600 font-semibold" 
              data-original="Premium entrees +$1.50">Premium entrees +$1.50</span>
      </div>
      
      <div id="entrees" class="grid grid-cols-2 gap-4"></div>
      
      <div class="mt-3 text-xs text-neutral-700">
        <span data-original="Selected:">Selected:</span> 
        <span id="entree-count" class="font-bold text-red-700">0</span>/<span id="entree-max-2">1</span>
      </div>
    </section>
  </main>

  <!-- Still There Modal -->
  <div id="still-there-modal" class="hidden fixed inset-0 items-center justify-center bg-black/70 backdrop-blur-sm z-90">
    <div class="bg-white text-black w-full max-w-md rounded-2xl overflow-hidden shadow-2xl">
      <div class="bg-gradient-to-r from-red-700 to-red-600 text-white px-8 py-6 text-center">
        <h3 class="text-2xl font-bold mb-2">Are You Still There?</h3>
        <p class="text-red-100 text-sm">Your session will expire soon</p>
      </div>
      
      <div class="p-8 text-center space-y-6">
        <div class="flex justify-center">
          <div class="relative w-40 h-40 flex items-center justify-center">
            <svg class="absolute inset-0 w-full h-full transform -rotate-90" viewBox="0 0 160 160">
              <circle cx="80" cy="80" r="72" stroke="#fee2e2" stroke-width="8" fill="none" />
              <circle id="countdown-circle" cx="80" cy="80" r="72" stroke="#dc2626" stroke-width="8" fill="none" 
                      stroke-dasharray="452" stroke-dashoffset="0" stroke-linecap="round" />
            </svg>
            <div class="relative z-10">
              <div id="still-there-countdown" class="text-6xl font-black text-red-700">10</div>
              <div class="text-sm text-neutral-600 font-medium mt-1">seconds</div>
            </div>
          </div>
        </div>
        
        <p class="text-neutral-700 text-base leading-relaxed">
          We haven't detected any activity. Your order will be cleared if you don't respond.
        </p>
        
        <button id="still-there-continue" class="w-full bg-gradient-to-r from-red-700 to-red-600 hover:from-red-800 hover:to-red-700 text-white font-bold py-4 px-8 rounded-xl text-lg shadow-lg hover:shadow-xl transition-all">
          Continue Building
        </button>
      </div>
    </div>
  </div>

  <!-- Item Info Modal -->
  <div id="item-info-modal" class="fixed inset-0 hidden items-center justify-center bg-black/60 z-[100]">
    <div class="bg-white text-black w-full max-w-md border border-neutral-200 rounded-xl overflow-hidden shadow-2xl">
      <div class="bg-red-700 text-white px-6 py-4 flex items-center justify-between">
        <h3 class="text-lg font-bold" id="info-modal-title" data-original="Item Information">Item Information</h3>
        <button id="info-modal-close" aria-label="Close" class="text-white/90 hover:text-white text-3xl font-light leading-none transition-colors"><span aria-hidden="true">&times;</span></button>
      </div>
      <div class="p-6 space-y-4">
        <div class="text-center pb-4 border-b border-neutral-200">
          <h4 id="info-item-name" class="text-xl font-bold text-neutral-800 mb-1"></h4>
        </div>
        
        <div class="space-y-3">
          <div class="bg-red-50 border-l-4 border-red-700 p-4 rounded">
            <div class="flex items-start gap-3">
              <span class="text-2xl">‚ö†Ô∏è</span>
              <div class="flex-1">
                <h5 class="font-bold text-red-900 mb-1" data-original="Allergens">Allergens</h5>
                <p id="info-allergens" class="text-sm text-red-800"></p>
              </div>
            </div>
          </div>
          
          <div class="bg-neutral-50 border border-neutral-200 p-4 rounded">
            <div class="flex items-start gap-3">
              <span class="text-2xl">üìä</span>
              <div class="flex-1">
                <h5 class="font-bold text-neutral-800 mb-2" data-original="Nutritional Information">Nutritional Information</h5>
                <div class="grid grid-cols-2 gap-2 text-sm">
                  <div class="flex justify-between">
                    <span class="text-neutral-700" data-original="Calories:">Calories:</span>
                    <span id="info-calories" class="font-semibold">--</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-neutral-700" data-original="Protein:">Protein:</span>
                    <span id="info-protein" class="font-semibold">--</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-neutral-700" data-original="Fat:">Fat:</span>
                    <span id="info-fat" class="font-semibold">--</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-neutral-700" data-original="Carbs:">Carbs:</span>
                    <span id="info-carbs" class="font-semibold">--</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer class="sticky bottom-0 w-full bg-white border-t border-neutral-200 shadow-lg">
    <div class="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <span class="text-sm text-neutral-700" data-original="Total:">Total:</span>
        <span class="text-3xl font-bold text-red-700">$<span id="price"><%= Number(price).toFixed(2) %></span></span>
      </div>
      <div class="flex items-center gap-3">
        <button id="cancel" data-original="Cancel" class="px-4 py-2 text-sm border border-neutral-300 bg-white hover:bg-neutral-100 rounded">Cancel</button>
        <button id="save" data-original="Add to Cart" class="px-5 py-2 text-sm font-semibold bg-red-700 text-white border border-red-700 hover:bg-red-800 rounded disabled:opacity-40 disabled:cursor-not-allowed" disabled>Add to Cart</button>
      </div>
    </div>
  </footer>

  <script>
    // Text size initialization - load from localStorage
    function initTextSize() {
      const savedSize = localStorage.getItem('kiosk_text_size') || 'large';
      document.documentElement.classList.remove('text-size-small', 'text-size-medium', 'text-size-large');
      document.documentElement.classList.add(`text-size-${savedSize}`);
    }
    initTextSize();

    // Inactivity warning system
    let inactivityTimer = null;
    let warningTimer = null;
    let countdownTimer = null;
    const INACTIVITY_WARNING_TIMEOUT = 30000; // 30 seconds
    const WARNING_COUNTDOWN = 10; // 10 seconds
    const stillThereModal = document.getElementById('still-there-modal');
    const stillThereCountdown = document.getElementById('still-there-countdown');
    let countdownValue = WARNING_COUNTDOWN;

    function showStillThereModal() {
      stillThereModal.classList.remove('hidden');
      stillThereModal.classList.add('flex');
      countdownValue = WARNING_COUNTDOWN;
      stillThereCountdown.textContent = countdownValue;
      startCountdown();
    }

    function hideStillThereModal() {
      stillThereModal.classList.add('hidden');
      stillThereModal.classList.remove('flex');
      clearInterval(countdownTimer);
      clearTimeout(warningTimer);
      resetInactivityTimer();
    }

    function startCountdown() {
      const circle = document.getElementById('countdown-circle');
      const circumference = 2 * Math.PI * 72;
      
      countdownTimer = setInterval(() => {
        countdownValue--;
        stillThereCountdown.textContent = countdownValue;
        
        const offset = circumference - (countdownValue / WARNING_COUNTDOWN) * circumference;
        circle.style.strokeDashoffset = offset;
        
        if (countdownValue <= 0) {
          clearInterval(countdownTimer);
          clearCartAndReturnToKiosk();
        }
      }, 1000);
    }

    function clearCartAndReturnToKiosk() {
      localStorage.removeItem('panda_cart');
      localStorage.setItem('kiosk_from_builder', 'true');
      window.location.href = '/kiosk';
    }

    function resetInactivityTimer() {
      clearTimeout(inactivityTimer);
      clearTimeout(warningTimer);
      clearInterval(countdownTimer);
      inactivityTimer = setTimeout(() => {
        showStillThereModal();
      }, INACTIVITY_WARNING_TIMEOUT);
    }

    // Continue button in still there modal
    document.getElementById('still-there-continue').addEventListener('click', hideStillThereModal);
    stillThereModal.addEventListener('click', (e) => {
      if (e.target === stillThereModal) {
        hideStillThereModal();
      }
    });

    // Track user activity to reset timer
    ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(event => {
      document.addEventListener(event, () => {
        if (stillThereModal.classList.contains('hidden')) {
          resetInactivityTimer();
        }
      }, true);
    });

    // Start inactivity timer when page loads
    resetInactivityTimer();

    // Data from server
    const builderData = JSON.parse('<%- JSON.stringify({ menu, type, price, premiumSurcharge }) %>');
    console.log('Builder Data:', builderData);

    // LocalStorage cart helpers
    const CART_KEY = 'kiosk_cart';
    function loadCart() {
      try { return JSON.parse(localStorage.getItem(CART_KEY)) || []; } catch { return []; }
    }
    function saveCart(cart) { localStorage.setItem(CART_KEY, JSON.stringify(cart)); }

    // Parse query for edit mode (idx & type)
    const params = new URLSearchParams(location.search);
    const editIdx = params.has('idx') ? Number(params.get('idx')) : null;
    const mode = editIdx !== null ? 'edit' : 'create';
    const mealType = (builderData.type || 'plate').toLowerCase();
    console.log('Meal Type:', mealType, 'Mode:', mode, 'Edit Index:', editIdx);

    // Config
    const cfg = { entreeSlots: 1, allowHalf: false };
    if (mealType.includes('plate') && !mealType.includes('bigger')) { cfg.entreeSlots = 2; cfg.allowHalf = true; }
    if (mealType.includes('bigger')) { cfg.entreeSlots = 3; cfg.allowHalf = true; }
    if (mealType.includes('bowl')) { cfg.entreeSlots = 1; cfg.allowHalf = false; }

    document.getElementById('entree-max').textContent = cfg.entreeSlots;
    document.getElementById('entree-max-2').textContent = cfg.entreeSlots;

    // UPDATED: Set text content AND data-original for translation
    const hintText = cfg.allowHalf 
      ? 'Select sides up to a total of 1 (halves allowed).'
      : 'Select one full side.';
    const sideHintEl = document.getElementById('side-hint');
    sideHintEl.textContent = hintText;
    sideHintEl.setAttribute('data-original', hintText);

    const proteins = (builderData.menu.entrees || []);
    const sides = builderData.menu.sides || [];

    let translationMap = {
      names: {},     // "Orange Chicken" -> "Pollo a la Naranja"
      allergens: {}  // "Wheat, Soy" -> "Trigo, Soja"
    };
    let currentLang = 'en';

    // Image map
    const imageMap = {
      'Beijing Beef': 'beijing-beef.jpg',
      'Black Pepper Chicken': 'black-pepper-chicken.jpg',
      'Black Pepper Sirloin Steak': 'black-pepper-sirloin-steak.jpg',
      'Broccoli Beef': 'broccoli-beef.jpg',
      'Grilled Teriyaki Chicken': 'grilled-teriyaki-chicken.jpg',
      'Honey Sesame Chicken Breast': 'honey-sesame-chicken-breast.jpg',
      'Honey Walnut Shrimp': 'honey-walnut-shrimp.jpg',
      'Kung Pao Chicken': 'kung-pao-chicken.jpg',
      'Mushroom Chicken': 'mushroom-chicken.jpg',
      'String Bean Chicken Breast': 'string-bean-chicken-breast.jpg',
      'The Original Orange Chicken': 'the-original-orange-chicken.jpg',
      'Fried Rice': 'fried-rice.jpg',
      'Chow Mein': 'chow-mein.jpg',
      'White Steamed Rice': 'white-steamed-rice.jpg',
      'Super Greens': 'super-greens.jpg',
      'Super Greens (Entree)': 'super-greens-(entree).jpg'
    };

    // State
    const sideCounts = {}; sides.forEach(s => sideCounts[s.name] = 0);
    const entreeCounts = {}; proteins.forEach(p => entreeCounts[p.name] = 0);

    // If editing, preload from cart
    if (mode === 'edit') {
      const cart = loadCart();
      const it = cart[editIdx];
      if (it && it.type === 'meal' && it.details) {
        const d = it.details;
        if (d.sides) {
          if (d.sides.type === 'full' && d.sides.name) { sideCounts[d.sides.name] = 1; }
          else if (d.sides.type === 'halves' && Array.isArray(d.sides.items)) {
            d.sides.items.forEach(n => { if (n in sideCounts) sideCounts[n] = Math.min(1, sideCounts[n] + 0.5); });
          }
        }
        if (Array.isArray(d.entrees)) { d.entrees.forEach(e => { if (e.name in entreeCounts) entreeCounts[e.name] = e.count; }); }
      }
    }

    const sidesEl = document.getElementById('sides');
    const sidesTotalEl = document.getElementById('side-total');
    const entreesEl = document.getElementById('entrees');
    const entreeCountEl = document.getElementById('entree-count');
    const saveBtn = document.getElementById('save');
    const cancelBtn = document.getElementById('cancel');

    function totalSides() { return Object.values(sideCounts).reduce((s,v)=>s+v,0); }
    function totalEntrees() { return Object.values(entreeCounts).reduce((s,v)=>s+v,0); }
    function calculatePrice() {
      let p = Number(builderData.price);
      proteins.forEach(pr => {
        if (pr.isPremium && entreeCounts[pr.name] > 0) {
          p += entreeCounts[pr.name] * Number(builderData.premiumSurcharge);
        }
      });
      return p.toFixed(2);
    }

    function renderSides() {
      sidesEl.innerHTML = '';
      sides.forEach(s => {
        const val = sideCounts[s.name] || 0;
        const isSelected = val > 0;
        
        // Resolve Text
        const displayName = (currentLang !== 'en' && translationMap.names[s.name]) ? translationMap.names[s.name] : s.name;
        
        // Resolve Allergens for display
        const rawAllergens = (s.allergens || []).join(', ');
        const displayAllergens = (currentLang !== 'en' && translationMap.allergens[rawAllergens]) ? translationMap.allergens[rawAllergens] : rawAllergens;
        const allergenText = displayAllergens || 'None';
        
        // Add nutrition data
        const nutritionData = s.nutrition ? JSON.stringify(s.nutrition) : '{}';
        const allergenBadge = `<div class="flex items-center gap-1"><span class="text-xs font-medium text-neutral-700 bg-white px-2 py-1 rounded shadow" data-original="More Info">More Info</span><button class="info-badge w-6 h-6 rounded-full bg-red-700 text-white text-xs font-bold flex items-center justify-center hover:bg-red-800 transition" aria-label="More info for ${s.name}" data-item-name="${s.name}" data-allergens="${allergenText}" data-nutrition='${nutritionData}'>i</button></div>`;

        const card = document.createElement('button');
        card.className = `relative w-full bg-white border-2 ${isSelected ? 'border-red-600' : 'border-neutral-300'} rounded-lg text-left hover:border-red-600 transition overflow-hidden`;
        
        const img = imageMap[s.name] ? `/images/${imageMap[s.name]}` : '/images/placeholder.jpg';
        const statusLabel = val === 1 ? 'Full' : (val === 0.5 ? 'Half' : '');
        const statusBadge = isSelected ? `<span class="px-2 py-1 text-xs font-bold bg-red-600 text-white rounded">${statusLabel}</span>` : '';
        
        card.innerHTML = `
          <div class="absolute top-0 left-0 right-0 flex items-start justify-between p-2 z-10">
            <div>${statusBadge}</div>
            <div>${allergenBadge}</div>
          </div>
          <div class="aspect-square bg-neutral-100 flex items-center justify-center p-2">
            <img src="${img}" alt="${s.name}" class="w-full h-full object-contain" />
          </div>
          <div class="px-3 py-2">
            <div class="text-sm font-semibold" data-original="${s.name}">${displayName}</div>
          </div>
        `;

        card.addEventListener('mouseenter', () => {
           if (ttsEnabled) speak(displayName);
        });
        
        card.addEventListener('click', () => {
          if (!cfg.allowHalf) {
            Object.keys(sideCounts).forEach(k => sideCounts[k] = 0);
            sideCounts[s.name] = 1;
          } else {
            const selectedSides = Object.entries(sideCounts).filter(([_,v]) => v > 0);
            if (val === 0) {
              if (selectedSides.length === 0) {
                sideCounts[s.name] = 1;
              } else if (selectedSides.length === 1) {
                Object.keys(sideCounts).forEach(k => { if (sideCounts[k] === 1) sideCounts[k] = 0.5; });
                sideCounts[s.name] = 0.5;
              }
            } else {
              sideCounts[s.name] = 0;
              const remaining = Object.entries(sideCounts).filter(([_,v]) => v > 0);
              if (remaining.length === 1 && remaining[0][1] === 0.5) {
                sideCounts[remaining[0][0]] = 1;
              }
            }
          }
          update();
        });
        sidesEl.appendChild(card);
      });
    }

    function renderEntrees() {
      entreesEl.innerHTML = '';
      proteins.forEach(p => {
        const count = entreeCounts[p.name] || 0;
        const isSelected = count > 0;
        
        // Resolve Text
        const displayName = (currentLang !== 'en' && translationMap.names[p.name]) ? translationMap.names[p.name] : p.name;
        
        // Resolve Allergens for display
        const rawAllergens = (p.allergens || []).join(', ');
        const displayAllergens = (currentLang !== 'en' && translationMap.allergens[rawAllergens]) ? translationMap.allergens[rawAllergens] : rawAllergens;
        const allergenText = displayAllergens || 'None';

        // Add nutrition data
        const nutritionData = p.nutrition ? JSON.stringify(p.nutrition) : '{}';
        const allergenBadge = `<div class="flex items-center gap-1"><span class="text-xs font-medium text-neutral-700 bg-white px-2 py-1 rounded shadow" data-original="More Info">More Info</span><button class="info-badge w-6 h-6 rounded-full bg-red-700 text-white text-xs font-bold flex items-center justify-center hover:bg-red-800 transition" aria-label="More info for ${p.name}" data-item-name="${p.name}" data-allergens="${allergenText}" data-nutrition='${nutritionData}'>i</button></div>`;
          
        const card = document.createElement('button');
        card.className = `relative w-full bg-white border-2 ${isSelected ? 'border-red-600' : 'border-neutral-300'} rounded-lg text-left hover:border-red-600 transition overflow-hidden`;
        const premiumBadge = p.isPremium ? `<span class="px-2 py-1 text-xs font-bold bg-yellow-400 text-black rounded">+$${builderData.premiumSurcharge}</span>` : '';
        const countBadge = isSelected ? `<span class="w-8 h-8 rounded-full bg-red-600 text-white text-sm font-bold flex items-center justify-center">${count}</span>` : '';
        const img = imageMap[p.name] ? `/images/${imageMap[p.name]}` : '/images/placeholder.jpg';
        
        card.innerHTML = `
          <div class="absolute top-0 left-0 right-0 flex items-start justify-between p-2 z-10">
            <div>${premiumBadge}</div>
            <div>${allergenBadge}</div>
          </div>
          <div class="aspect-square bg-neutral-100 flex items-center justify-center p-2">
              <img src="${img}" alt="${p.name}" class="w-full h-full object-contain" />
            </div>
            <div class="px-3 py-2">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold" data-original="${p.name}">${displayName}</div>
                ${countBadge}
              </div>
            </div>
          `;
          
        card.addEventListener('mouseenter', () => {
           if (ttsEnabled) speak(displayName);
        });

        card.addEventListener('click', () => {
          const currentTotal = totalEntrees();
          if (count === 0) {
            if (currentTotal < cfg.entreeSlots) entreeCounts[p.name] = 1;
          } else {
            if (currentTotal < cfg.entreeSlots) entreeCounts[p.name] = count + 1;
            else entreeCounts[p.name] = 0;
          }
          update();
        });
        entreesEl.appendChild(card);
      });
    }

    function valid() {
      const sidesOk = Math.abs(totalSides() - 1) < 1e-6;
      const entreesOk = totalEntrees() === cfg.entreeSlots;
      return sidesOk && entreesOk;
    }

    function update() {
      renderSides();
      renderEntrees();
      sidesTotalEl.textContent = String(totalSides());
      entreeCountEl.textContent = String(totalEntrees());
      const newPrice = calculatePrice();
      // Update footer price
      const priceEl = document.getElementById('price');
      if (priceEl) priceEl.textContent = newPrice;
      saveBtn.disabled = !valid();
    }

    function buildDetails() {
      const sEntries = Object.entries(sideCounts).filter(([_,v]) => v>0).sort((a,b)=>b[1]-a[1]);
      let sidesDetail = null;
      if (sEntries.length === 1 && sEntries[0][1] === 1) {
        sidesDetail = { type: 'full', name: sEntries[0][0] };
      } else {
        const items = [];
        sEntries.forEach(([n,v]) => { if (v === 1) { items.push(n,n); } else if (v === 0.5) { items.push(n); } });
        sidesDetail = { type: 'halves', items };
      }
      const entreesDetail = Object.entries(entreeCounts).filter(([_,c]) => c>0).map(([name,count]) => ({ name, count }));
      return { sides: sidesDetail, entrees: entreesDetail };
    }

    saveBtn.addEventListener('click', () => {
      const cart = loadCart();
      const details = buildDetails();
      const mealName = mealType === 'bowl' ? 'Bowl' : (mealType === 'bigger-plate' ? 'Bigger Plate' : 'Plate');
      const finalPrice = Number(calculatePrice());
      const itemObj = { name: mealName, price: finalPrice, quantity: 1, type: 'meal', details };
      if (mode === 'edit' && cart[editIdx]) {
        cart[editIdx] = { ...cart[editIdx], name: mealName, price: finalPrice, details };
      } else {
        cart.push(itemObj);
      }
      saveCart(cart);
      localStorage.setItem('kiosk_from_builder', 'true');
      window.location.href = '/kiosk';
    });

    cancelBtn.addEventListener('click', () => {
      localStorage.setItem('kiosk_from_builder', 'true');
      window.location.href = '/kiosk';
    });

    // Info modal functionality
    const infoModal = document.getElementById('item-info-modal');
    const infoModalTitle = document.getElementById('info-item-name');
    const infoModalAllergens = document.getElementById('info-allergens');
    const infoModalCalories = document.getElementById('info-calories');
    const infoModalProtein = document.getElementById('info-protein');
    const infoModalFat = document.getElementById('info-fat');
    const infoModalCarbs = document.getElementById('info-carbs');
    const infoModalClose = document.getElementById('info-modal-close');

    function openInfoModal(itemName, allergens, nutrition = null) {
      infoModalTitle.textContent = itemName;
      infoModalAllergens.textContent = allergens || 'None';
      
      // Display nutrition data if available
      if (nutrition && typeof nutrition === 'object') {
        infoModalCalories.textContent = nutrition.calories || '--';
        infoModalProtein.textContent = nutrition.protein ? `${nutrition.protein}g` : '--';
        infoModalFat.textContent = nutrition.fat ? `${nutrition.fat}g` : '--';
        infoModalCarbs.textContent = nutrition.carbs ? `${nutrition.carbs}g` : '--';
      } else {
        infoModalCalories.textContent = '--';
        infoModalProtein.textContent = '--';
        infoModalFat.textContent = '--';
        infoModalCarbs.textContent = '--';
      }
      
      infoModal.classList.remove('hidden');
      infoModal.classList.add('flex');
    }

    function closeInfoModal() {
      infoModal.classList.add('hidden');
      infoModal.classList.remove('flex');
    }

    infoModalClose.addEventListener('click', closeInfoModal);
    infoModal.addEventListener('click', (e) => {
      if (e.target === infoModal) closeInfoModal();
    });

    // Add click handlers for info badges
    document.addEventListener('click', (e) => {
      const infoBadge = e.target.closest('.info-badge');
      if (infoBadge) {
        e.stopPropagation();
        e.preventDefault();
        const itemName = infoBadge.getAttribute('data-item-name');
        const allergens = infoBadge.getAttribute('data-allergens');
        const nutritionStr = infoBadge.getAttribute('data-nutrition');
        let nutrition = null;
        try {
          nutrition = nutritionStr ? JSON.parse(nutritionStr) : null;
        } catch (err) {
          console.error('Failed to parse nutrition data:', err);
        }
        if (ttsEnabled) {
            let speakText = `Information for ${itemName}. `;
            
            if (allergens && allergens !== 'None' && allergens.trim() !== '') {
              speakText += `Allergens: ${allergens}. `;
            } else {
              speakText += `No allergens listed. `;
            }

            if (nutrition) {
              speakText += `Nutrition facts: `;
              if (nutrition.calories) speakText += `${nutrition.calories} calories, `;
              if (nutrition.protein) speakText += `${nutrition.protein} grams of protein, `;
              if (nutrition.fat) speakText += `${nutrition.fat} grams of fat, `;
              if (nutrition.carbs) speakText += `${nutrition.carbs} grams of carbs.`;
            }
            speak(speakText);
          }
        openInfoModal(itemName, allergens, nutrition);
      }
    });

    // Initial render
    update();

    // Text-to-Speech Logic
      let ttsEnabled = false;
      let currentUtterance = null;
      const synth = window.speechSynthesis;

      function initTTS() {
        const savedTTS = localStorage.getItem('kiosk_tts_enabled');
        if (savedTTS === 'true') {
          ttsEnabled = true;
        }
        updateTTSUI();
      }

      function updateTTSUI() {
        const icon = document.getElementById('tts-icon');
        const status = document.getElementById('tts-status');
        const toggle = document.getElementById('tts-toggle');
        
        if (ttsEnabled) {
          icon.textContent = 'üîä';
          status.textContent = 'On';
          status.setAttribute('data-original', 'On');
          toggle.classList.remove('bg-neutral-800');
          toggle.classList.add('bg-green-700');
        } else {
          icon.textContent = 'üîá';
          status.textContent = 'Off';
          status.setAttribute('data-original', 'Off');
          toggle.classList.remove('bg-green-700');
          toggle.classList.add('bg-neutral-800');
        }
      }

      function speak(text) {
        if (!ttsEnabled || !text) return;
        
        // Cancel any ongoing speech
        synth.cancel();
        
        const utterance = new SpeechSynthesisUtterance(text);
        const lang = localStorage.getItem('kiosk_lang') || 'en';
        
        // Map language codes to speech synthesis language codes
        const langMap = {
          'en': 'en-US',
          'es': 'es-ES',
          'zh-CN': 'zh-CN',
          'fr': 'fr-FR',
          'de': 'de-DE'
        };
        
        utterance.lang = langMap[lang] || 'en-US';
        utterance.rate = 1.0;
        utterance.pitch = 1.0;
        utterance.volume = 1.0;
        
        currentUtterance = utterance;
        synth.speak(utterance);
      }
        
      if (ttsEnabled) {
        speak('Text to speech enabled');
      } else {
        synth.cancel();
      }
      

      // Add TTS to navigation buttons
      document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('mouseenter', () => speak(link.textContent.trim()));
      });

      document.addEventListener('mouseenter', (e) => {
        if (!ttsEnabled) return;
        const target = e.target;

        // Item Cards (Kiosk Grid)
        if (target.closest('.item-card')) {
          const card = target.closest('.item-card');
          const name = card.querySelector('[data-translate-type="item-name"]')?.textContent || card.dataset.name;
          if (name) speak(name);
          return;
        }

        // Cart Items
        if (target.closest('#cart-drawer-items > div')) {
          const name = target.querySelector('.font-medium')?.textContent;
          if (name) speak(name);
          return;
        }

        // Generic Buttons (except the TTS toggle itself)
        if (target.tagName === 'BUTTON' && target.id !== 'tts-toggle') {
          const text = target.getAttribute('aria-label') || target.textContent.trim();
          if (text && text.length < 50) speak(text);
        }
      }, true);

    document.addEventListener('DOMContentLoaded', initTTS);

    // TRANSLATION LOGIC
    document.addEventListener('DOMContentLoaded', () => {
      const titleEl = document.getElementById('builder-title');
      if (titleEl && !titleEl.hasAttribute('data-original')) {
        titleEl.setAttribute('data-original', titleEl.textContent.trim());
      }
      
      const savedLang = localStorage.getItem('kiosk_lang');
      if (savedLang && savedLang !== 'en') {
        currentLang = savedLang;
        initTranslation(savedLang);
      }
    });

    async function initTranslation(lang) {
      if (lang === 'en') return;

      const namesToTranslate = [...new Set([...sides.map(s=>s.name), ...proteins.map(p=>p.name)])];
      const allergensToTranslate = [...new Set([...sides.map(s=>(s.allergens||[]).join(', ')), ...proteins.map(p=>(p.allergens||[]).join(', '))])].filter(Boolean);
      
      const staticElements = Array.from(document.querySelectorAll('[data-original]'));
      const staticTexts = staticElements.map(el => el.getAttribute('data-original'));

      const allTexts = [...namesToTranslate, ...allergensToTranslate, ...staticTexts];
      
      if (allTexts.length === 0) return;

      try {
        const res = await fetch('/api/translate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: allTexts, target: lang })
        });
        const data = await res.json();
        
        if (data.success && Array.isArray(data.translatedText)) {
          let cursor = 0;
          
          namesToTranslate.forEach(original => {
            translationMap.names[original] = data.translatedText[cursor++];
          });
          
          allergensToTranslate.forEach(original => {
            translationMap.allergens[original] = data.translatedText[cursor++];
          });

          staticElements.forEach(el => {
            el.textContent = data.translatedText[cursor++];
          });

          update();
        }
      } catch (e) { console.error(e); }
    }
  </script>
</body>
</html>