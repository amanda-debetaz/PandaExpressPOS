<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Build Your Meal</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>


<!-- LARGER TEXT
<style>
  html {
    font-size: 19px !important; /* ~+20% larger base */
  }

  /* Buttons & key numbers */
  button {
    font-size: 1.6rem !important;
    padding: 1rem 1.5rem !important;   /* ← fixed line */
  }

  #cart-total,
  #cart-drawer-total,
  #success-total {
    font-size: 3.8rem !important;
    font-weight: 900 !important;
  }

  #success-order-number {
    font-size: 5rem !important;
    font-weight: 900 !important;
  }

  /* Text classes – all bumped up */
  .text-xs   { font-size: 1.1rem !important; }
  .text-sm   { font-size: 1.4rem !important; }
  .text-base { font-size: 1.6rem !important; }
  .text-lg   { font-size: 2rem   !important; }
  .text-xl   { font-size: 2.6rem !important; }
  .text-2xl  { font-size: 3.2rem !important; }
  .text-3xl  { font-size: 4rem   !important; }

  /* Cart drawer items & modal buttons */
  #cart-drawer-items > div,
  .payment-method-btn,
  .dine-option-btn,
  #success-done-btn {
    padding: 1.8rem 1.2rem !important;
    font-weight: 700 !important;
    font-size: 1.8rem !important;
  }

  /* Success modal title */
  #order-success-modal h2 {
    font-size: 4.5rem !important;
  }

  /* Bottom bar total – huge and clear */
  #cart-total {
    font-size: 4.2rem !important;
    font-weight: 900 !important;
  }
  /* ——— BUILDER: BIGGER, AIRIER HEADINGS ——— */
  header h1 {
    font-size: 4rem !important;
    line-height: 1.2 !important;
    margin-bottom: 1rem !important;
  }

  header .text-sm {
    font-size: 2rem !important;
    opacity: 0.95;
  }

  /* Section titles (Side, Entrees) */
  section > div:first-child {
    font-size: 2.4rem !important;
    margin-bottom: 1.8rem !important;
    letter-spacing: 0.05em !important;
  }

  /* Hints and counters */
  #side-hint,
  .text-xs.text-neutral-600 {
    font-size: 1.6rem !important;
    margin-bottom: 2rem !important;
  }

  #side-total,
  #entree-count {
    font-size: 2.6rem !important;
  }

  /* Footer buttons */
  footer button {
    padding: 1.6rem 3rem !important;
    font-size: 1.9rem !important;
  }
</style> -->


<body class="min-h-screen bg-neutral-50 text-black">
  <header class="w-full bg-red-700 text-white border-b border-red-800">
    <div class="max-w-6xl mx-auto px-6 py-5 flex items-center justify-between">
      <div>
        <div class="text-xs uppercase tracking-[0.25em] text-red-100 font-semibold" data-original="Panda Express">Panda Express</div>
        <h1 id="builder-title" class="text-2xl font-semibold mt-1">
          <%= (typeof isEdit !== 'undefined' && isEdit) ? 'Edit' : 'Build' %> Your 
          <%= type === 'bowl' ? 'Bowl' : (type === 'bigger-plate' ? 'Bigger Plate' : 'Plate') %>
        </h1>
        <div class="text-sm text-red-100">
          <span data-original="Price:">Price:</span> 
          $<span id="price"><%= Number(price).toFixed(2) %></span>
        </div>
      </div>
      <a href="/kiosk" class="text-sm text-red-100 hover:text-white" data-original="Back to Menu">Back to Menu</a>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-2 gap-8">
    <section>
      <div class="text-sm uppercase tracking-[0.2em] text-red-700 font-bold mb-3" 
           data-original="Side (total 1)">Side (total 1)</div>
      
      <div id="side-hint" class="text-xs text-neutral-600 mb-2" 
           data-original="Select one full side.">Select one full side.</div>

      <div id="sides" class="grid grid-cols-2 gap-4"></div>
      
      <div class="mt-3 text-xs text-neutral-600">
        <span data-original="Selected:">Selected:</span> 
        <span id="side-total" class="font-bold text-red-700">0</span>/1
      </div>
    </section>

    <section>
      <div class="text-sm uppercase tracking-[0.2em] text-red-700 font-bold mb-3" 
           data-original="Entrees">Entrees</div>
      
      <div class="text-xs text-neutral-600 mb-2">
        <span data-original="Choose up to">Choose up to</span> 
        <span id="entree-max">1</span> • 
        <span class="text-yellow-600 font-semibold" 
              data-original="Premium entrees +$1.50">Premium entrees +$1.50</span>
      </div>
      
      <div id="entrees" class="grid grid-cols-2 gap-4"></div>
      
      <div class="mt-3 text-xs text-neutral-600">
        <span data-original="Selected:">Selected:</span> 
        <span id="entree-count" class="font-bold text-red-700">0</span>/<span id="entree-max-2">1</span> • 
        <span data-original="Total:">Total:</span> $<span id="calculated-price" class="font-bold text-red-700">0.00</span>
      </div>
    </section>
  </main>

  <footer class="sticky bottom-0 w-full bg-white border-t border-neutral-200 shadow-lg">
    <div class="max-w-6xl mx-auto px-6 py-4 flex items-center justify-end gap-3">
      <button id="cancel" data-original="Cancel" class="px-4 py-2 text-sm border border-neutral-300 bg-white hover:bg-neutral-100 rounded">Cancel</button>
      <button id="save" data-original="Add to Cart" class="px-5 py-2 text-sm font-semibold bg-red-700 text-white border border-red-700 hover:bg-red-800 rounded disabled:opacity-40 disabled:cursor-not-allowed" disabled>Add to Cart</button>
    </div>
  </footer>

  <script>
    // Data from server
    const builderData = JSON.parse('<%- JSON.stringify({ menu, type, price, premiumSurcharge }) %>');
    console.log('Builder Data:', builderData);

    // LocalStorage cart helpers
    const CART_KEY = 'kiosk_cart';
    function loadCart() {
      try { return JSON.parse(localStorage.getItem(CART_KEY)) || []; } catch { return []; }
    }
    function saveCart(cart) { localStorage.setItem(CART_KEY, JSON.stringify(cart)); }

    // Parse query for edit mode (idx & type)
    const params = new URLSearchParams(location.search);
    const editIdx = params.has('idx') ? Number(params.get('idx')) : null;
    const mode = editIdx !== null ? 'edit' : 'create';
    const mealType = (builderData.type || 'plate').toLowerCase();

    // Config
    const cfg = { entreeSlots: 1, allowHalf: false };
    if (mealType.includes('plate') && !mealType.includes('bigger')) { cfg.entreeSlots = 2; cfg.allowHalf = true; }
    if (mealType.includes('bigger')) { cfg.entreeSlots = 3; cfg.allowHalf = true; }
    if (mealType.includes('bowl')) { cfg.entreeSlots = 1; cfg.allowHalf = false; }

    document.getElementById('entree-max').textContent = cfg.entreeSlots;
    document.getElementById('entree-max-2').textContent = cfg.entreeSlots;

    // UPDATED: Set text content AND data-original for translation
    const hintText = cfg.allowHalf 
      ? 'Select sides up to a total of 1 (halves allowed).'
      : 'Select one full side.';
    const sideHintEl = document.getElementById('side-hint');
    sideHintEl.textContent = hintText;
    sideHintEl.setAttribute('data-original', hintText);

    const proteins = (builderData.menu.entrees || []);
    const sides = builderData.menu.sides || [];

    let translationMap = {
      names: {},     // "Orange Chicken" -> "Pollo a la Naranja"
      allergens: {}  // "Wheat, Soy" -> "Trigo, Soja"
    };
    let currentLang = 'en';

    // Image map
    const imageMap = {
      'Beijing Beef': 'beijing-beef.jpg',
      'Black Pepper Chicken': 'black-pepper-chicken.jpg',
      'Black Pepper Sirloin Steak': 'black-pepper-sirloin-steak.jpg',
      'Broccoli Beef': 'broccoli-beef.jpg',
      'Grilled Teriyaki Chicken': 'grilled-teriyaki-chicken.jpg',
      'Honey Sesame Chicken Breast': 'honey-sesame-chicken-breast.jpg',
      'Honey Walnut Shrimp': 'honey-walnut-shrimp.jpg',
      'Kung Pao Chicken': 'kung-pao-chicken.jpg',
      'Mushroom Chicken': 'mushroom-chicken.jpg',
      'String Bean Chicken Breast': 'string-bean-chicken-breast.jpg',
      'The Original Orange Chicken': 'the-original-orange-chicken.jpg',
      'Fried Rice': 'fried-rice.jpg',
      'Chow Mein': 'chow-mein.jpg',
      'White Steamed Rice': 'white-steamed-rice.jpg',
      'Super Greens': 'super-greens.jpg',
      'Super Greens (Entree)': 'super-greens-(entree).jpg'
    };

    // State
    const sideCounts = {}; sides.forEach(s => sideCounts[s.name] = 0);
    const entreeCounts = {}; proteins.forEach(p => entreeCounts[p.name] = 0);

    // If editing, preload from cart
    if (mode === 'edit') {
      const cart = loadCart();
      const it = cart[editIdx];
      if (it && it.type === 'meal' && it.details) {
        const d = it.details;
        if (d.sides) {
          if (d.sides.type === 'full' && d.sides.name) { sideCounts[d.sides.name] = 1; }
          else if (d.sides.type === 'halves' && Array.isArray(d.sides.items)) {
            d.sides.items.forEach(n => { if (n in sideCounts) sideCounts[n] = Math.min(1, sideCounts[n] + 0.5); });
          }
        }
        if (Array.isArray(d.entrees)) { d.entrees.forEach(e => { if (e.name in entreeCounts) entreeCounts[e.name] = e.count; }); }
      }
    }

    const sidesEl = document.getElementById('sides');
    const sidesTotalEl = document.getElementById('side-total');
    const entreesEl = document.getElementById('entrees');
    const entreeCountEl = document.getElementById('entree-count');
    const calculatedPriceEl = document.getElementById('calculated-price');
    const saveBtn = document.getElementById('save');
    const cancelBtn = document.getElementById('cancel');

    function totalSides() { return Object.values(sideCounts).reduce((s,v)=>s+v,0); }
    function totalEntrees() { return Object.values(entreeCounts).reduce((s,v)=>s+v,0); }
    function calculatePrice() {
      let p = Number(builderData.price);
      proteins.forEach(pr => {
        if (pr.isPremium && entreeCounts[pr.name] > 0) {
          p += entreeCounts[pr.name] * Number(builderData.premiumSurcharge);
        }
      });
      return p.toFixed(2);
    }

    function renderSides() {
      sidesEl.innerHTML = '';
      sides.forEach(s => {
        const val = sideCounts[s.name] || 0;
        const isSelected = val > 0;
        
        // Resolve Text
        const displayName = (currentLang !== 'en' && translationMap.names[s.name]) ? translationMap.names[s.name] : s.name;
        
        // Resolve Allergens Tooltip
        const rawAllergens = (s.allergens || []).join(', ');
        const displayAllergens = (currentLang !== 'en' && translationMap.allergens[rawAllergens]) ? translationMap.allergens[rawAllergens] : rawAllergens;
        
        const allergenBadge = s.allergens && s.allergens.length 
          ? `<span class="absolute top-2 right-2 w-6 h-6 rounded-full bg-red-700 text-white text-xs font-bold flex items-center justify-center" title="Allergens: ${displayAllergens}">i</span>` 
          : '';

        const card = document.createElement('button');
        card.className = `relative w-full bg-white border-2 ${isSelected ? 'border-red-600' : 'border-neutral-300'} rounded-lg overflow-hidden text-left hover:border-red-600 transition`;
        
        const img = imageMap[s.name] ? `/images/${imageMap[s.name]}` : '/images/placeholder.jpg';
        const statusLabel = val === 1 ? 'Full' : (val === 0.5 ? 'Half' : '');
        const statusBadge = isSelected ? `<span class="absolute top-2 left-2 px-2 py-1 text-xs font-bold bg-red-600 text-white rounded z-10">${statusLabel}</span>` : '';
        
        card.innerHTML = `
          ${statusBadge}
          ${allergenBadge}
          <div class="aspect-square bg-neutral-100 flex items-center justify-center p-2">
            <img src="${img}" alt="${s.name}" class="w-full h-full object-contain" />
          </div>
          <div class="px-3 py-2">
            <div class="text-sm font-semibold" data-original="${s.name}">${displayName}</div>
          </div>
        `;
        
        card.addEventListener('click', () => {
          if (!cfg.allowHalf) {
            Object.keys(sideCounts).forEach(k => sideCounts[k] = 0);
            sideCounts[s.name] = 1;
          } else {
            const selectedSides = Object.entries(sideCounts).filter(([_,v]) => v > 0);
            if (val === 0) {
              if (selectedSides.length === 0) {
                sideCounts[s.name] = 1;
              } else if (selectedSides.length === 1) {
                Object.keys(sideCounts).forEach(k => { if (sideCounts[k] === 1) sideCounts[k] = 0.5; });
                sideCounts[s.name] = 0.5;
              }
            } else {
              sideCounts[s.name] = 0;
              const remaining = Object.entries(sideCounts).filter(([_,v]) => v > 0);
              if (remaining.length === 1 && remaining[0][1] === 0.5) {
                sideCounts[remaining[0][0]] = 1;
              }
            }
          }
          update();
        });
        sidesEl.appendChild(card);
      });
    }

    function renderEntrees() {
      entreesEl.innerHTML = '';
      proteins.forEach(p => {
        const count = entreeCounts[p.name] || 0;
        const isSelected = count > 0;
        
        // Resolve Text
        const displayName = (currentLang !== 'en' && translationMap.names[p.name]) ? translationMap.names[p.name] : p.name;
        
        // Resolve Allergens Tooltip
        const rawAllergens = (p.allergens || []).join(', ');
        const displayAllergens = (currentLang !== 'en' && translationMap.allergens[rawAllergens]) ? translationMap.allergens[rawAllergens] : rawAllergens;

        const allergenBadge = p.allergens && p.allergens.length 
          ? `<span class="absolute top-2 right-2 w-6 h-6 rounded-full bg-red-700 text-white text-xs font-bold flex items-center justify-center z-10" title="Allergens: ${displayAllergens}">i</span>` 
          : '';
          
        const card = document.createElement('button');
        card.className = `relative w-full bg-white border-2 ${isSelected ? 'border-red-600' : 'border-neutral-300'} rounded-lg overflow-hidden text-left hover:border-red-600 transition`;
        const premiumBadge = p.isPremium ? `<span class="absolute top-2 left-2 px-2 py-1 text-xs font-bold bg-yellow-400 text-black rounded z-10">+$${builderData.premiumSurcharge}</span>` : '';
        const countBadge = isSelected ? `<span class="absolute bottom-2 right-2 w-8 h-8 rounded-full bg-red-600 text-white text-sm font-bold flex items-center justify-center z-10">${count}</span>` : '';
        const img = imageMap[p.name] ? `/images/${imageMap[p.name]}` : '/images/placeholder.jpg';
        
        card.innerHTML = `
          ${allergenBadge}
          ${premiumBadge}
          ${countBadge}
          <div class="aspect-square bg-neutral-100 flex items-center justify-center p-2">
              <img src="${img}" alt="${p.name}" class="w-full h-full object-contain" />
            </div>
            <div class="px-3 py-2">
              <div class="text-sm font-semibold" data-original="${p.name}">${displayName}</div>
            </div>
          `;
        
        card.addEventListener('click', () => {
          const currentTotal = totalEntrees();
          if (count === 0) {
            if (currentTotal < cfg.entreeSlots) entreeCounts[p.name] = 1;
          } else {
            if (currentTotal < cfg.entreeSlots) entreeCounts[p.name] = count + 1;
            else entreeCounts[p.name] = 0;
          }
          update();
        });
        entreesEl.appendChild(card);
      });
    }

    function valid() {
      const sidesOk = Math.abs(totalSides() - 1) < 1e-6;
      const entreesOk = totalEntrees() === cfg.entreeSlots;
      return sidesOk && entreesOk;
    }

    function update() {
      renderSides();
      renderEntrees();
      sidesTotalEl.textContent = String(totalSides());
      entreeCountEl.textContent = String(totalEntrees());
      calculatedPriceEl.textContent = calculatePrice();
      saveBtn.disabled = !valid();
    }

    function buildDetails() {
      const sEntries = Object.entries(sideCounts).filter(([_,v]) => v>0).sort((a,b)=>b[1]-a[1]);
      let sidesDetail = null;
      if (sEntries.length === 1 && sEntries[0][1] === 1) {
        sidesDetail = { type: 'full', name: sEntries[0][0] };
      } else {
        const items = [];
        sEntries.forEach(([n,v]) => { if (v === 1) { items.push(n,n); } else if (v === 0.5) { items.push(n); } });
        sidesDetail = { type: 'halves', items };
      }
      const entreesDetail = Object.entries(entreeCounts).filter(([_,c]) => c>0).map(([name,count]) => ({ name, count }));
      return { sides: sidesDetail, entrees: entreesDetail };
    }

    saveBtn.addEventListener('click', () => {
      const cart = loadCart();
      const details = buildDetails();
      const mealName = mealType === 'bowl' ? 'Bowl' : (mealType === 'bigger-plate' ? 'Bigger Plate' : 'Plate');
      const finalPrice = Number(calculatePrice());
      const itemObj = { name: mealName, price: finalPrice, quantity: 1, type: 'meal', details };
      if (mode === 'edit' && cart[editIdx]) {
        cart[editIdx] = { ...cart[editIdx], name: mealName, price: finalPrice, details };
      } else {
        cart.push(itemObj);
      }
      saveCart(cart);
      window.location.href = '/kiosk';
    });

    cancelBtn.addEventListener('click', () => { window.location.href = '/kiosk'; });

    // Initial render
    update();

    // TRANSLATION LOGIC
    document.addEventListener('DOMContentLoaded', () => {
      const titleEl = document.getElementById('builder-title');
      if (titleEl && !titleEl.hasAttribute('data-original')) {
        titleEl.setAttribute('data-original', titleEl.textContent.trim());
      }
      
      const savedLang = localStorage.getItem('kiosk_lang');
      if (savedLang && savedLang !== 'en') {
        currentLang = savedLang;
        initTranslation(savedLang);
      }
    });

    async function initTranslation(lang) {
      if (lang === 'en') return;

      const namesToTranslate = [...new Set([...sides.map(s=>s.name), ...proteins.map(p=>p.name)])];
      const allergensToTranslate = [...new Set([...sides.map(s=>(s.allergens||[]).join(', ')), ...proteins.map(p=>(p.allergens||[]).join(', '))])].filter(Boolean);
      
      const staticElements = Array.from(document.querySelectorAll('[data-original]'));
      const staticTexts = staticElements.map(el => el.getAttribute('data-original'));

      const allTexts = [...namesToTranslate, ...allergensToTranslate, ...staticTexts];
      
      if (allTexts.length === 0) return;

      try {
        const res = await fetch('/api/translate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: allTexts, target: lang })
        });
        const data = await res.json();
        
        if (data.success && Array.isArray(data.translatedText)) {
          let cursor = 0;
          
          namesToTranslate.forEach(original => {
            translationMap.names[original] = data.translatedText[cursor++];
          });
          
          allergensToTranslate.forEach(original => {
            translationMap.allergens[original] = data.translatedText[cursor++];
          });

          staticElements.forEach(el => {
            el.textContent = data.translatedText[cursor++];
          });

          update();
        }
      } catch (e) { console.error(e); }
    }
  </script>
</body>
</html>