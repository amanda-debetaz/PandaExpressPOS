<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panda Express Kiosk</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <!--LARGER TEXT---->
  <style>
    html {
      font-size: 19px !important; /* ~+20% larger base */
    }

    /* Buttons & key numbers */
    button {
      font-size: 1.6rem !important;
      padding: 1rem 1.5rem !important;   /* ← fixed line */
    }

    #cart-total,
    #cart-drawer-total,
    #success-total {
      font-size: 3.8rem !important;
      font-weight: 900 !important;
    }

    #success-order-number {
      font-size: 5rem !important;
      font-weight: 900 !important;
    }

    /* Text classes – all bumped up */
    .text-xs   { font-size: 1.1rem !important; }
    .text-sm   { font-size: 1.4rem !important; }
    .text-base { font-size: 1.6rem !important; }

    /* Cart drawer items & modal buttons */
    #cart-drawer-items > div,
    .payment-method-btn,
    .dine-option-btn,
    #success-done-btn {
      padding: 1.8rem 1.2rem !important;
      font-weight: 700 !important;
      font-size: 1.8rem !important;
    }

    /* Success modal title */
    #order-success-modal h2 {
      font-size: 4.5rem !important;
    }

    /* Bottom bar total – huge and clear */
    #cart-total {
      font-size: 4.2rem !important;
      font-weight: 900 !important;
    }
    
  </style>

  <body class="h-screen flex bg-black text-white overflow-hidden">
    <script>
      // Pass server-side menu data to JavaScript
      const menuData = JSON.parse('<%- JSON.stringify(menu || {}) %>');
    </script>
    <!-- Sidebar -->
    <aside class="w-72 bg-black border-r border-red-900 flex flex-col h-screen">
      <div class="px-6 pt-8 pb-4 flex-shrink-0">
        <div class="text-xs tracking-[0.25em] uppercase text-red-500 font-bold">
          Panda Express
        </div>
        <div class="mt-1 text-[11px] tracking-[0.3em] uppercase text-neutral-400">
          Self-Service Kiosk
        </div>
      </div>

      <nav class="flex-shrink-0">
        <ul class="flex flex-col text-sm">
          <li>
            <button data-category="entrees" class="nav-link active w-full text-left">
              Entrees
            </button>
          </li>
          <li>
            <button data-category="a_la_carte" class="nav-link w-full text-left">
              A La Carte
            </button>
          </li>
          <li>
            <button data-category="sides" class="nav-link w-full text-left">
              Sides
            </button>
          </li>
          <li>
            <button data-category="appetizers" class="nav-link w-full text-left">
              Appetizers
            </button>
          </li>
        </ul>
      </nav>

      <!-- Spacer (cart moved to right drawer) -->
      <div class="flex-1 border-t border-neutral-800 min-h-0"></div>

      <div class="px-6 py-4 text-[11px] text-neutral-500 border-t border-neutral-800 flex-shrink-0">
        Tap items to add them to your order.
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col bg-white text-black h-screen">
      <!-- Header -->
      <header class="flex items-center justify-between px-10 py-6 border-b border-neutral-200 flex-shrink-0">
        <div>
          <h1 id="category-title" class="text-3xl font-semibold tracking-tight">
            Entrees
          </h1>
          <p class="mt-1 text-sm text-neutral-500">
            Choose your main dish to start your order.
          </p>
        </div>

        <div class="flex items-center gap-3">
          <div class="flex items-center px-4 py-2 border border-black bg-black text-white text-xs uppercase tracking-[0.22em]">
            <span class="h-2 w-2 mr-2 bg-green-500 rounded-full animate-pulse"></span>
            Ready to order
          </div>
        </div>
      </header>

      <!-- Scrollable Content Area -->
      <section class="flex-1 overflow-y-auto px-10 py-8 bg-neutral-50">
        <!-- Entrees -->
        <div id="entrees" class="category-section">
          <div class="grid gap-6 grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>

        <!-- A La Carte -->
        <div id="a_la_carte" class="category-section hidden">
          <div class="grid gap-6 grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>

        <!-- Sides -->
        <div id="sides" class="category-section hidden">
          <div class="grid gap-6 grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>

        <!-- Appetizers -->
        <div id="appetizers" class="category-section hidden">
          <div class="grid gap-6 grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>
      </section>

      <!-- Fixed Bottom Cart Bar -->
      <div class="border-t border-neutral-300 bg-white shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] flex-shrink-0">
        <div class="px-10 py-5 flex items-center justify-between">
          <div class="text-xs uppercase tracking-[0.25em] text-neutral-500 font-medium">
            Order Summary
          </div>
          <div class="flex items-center gap-6">
            <div class="flex items-baseline gap-4 text-sm">
              <span class="text-neutral-500 text-xs">
                Items: <span id="cart-count" class="font-semibold text-black">0</span>
              </span>
              <span class="font-bold text-red-700 text-xl">
                $<span id="cart-total">0.00</span>
              </span>
            </div>

            <button
              id="cart-open-drawer"
              class="px-8 py-2.5 text-xs font-semibold uppercase tracking-[0.22em] bg-red-700 text-white border-2 border-red-700 hover:bg-red-800 hover:border-red-800 transition-all"
            >
              View Cart
            </button>
          </div>
        </div>
      </div>
    </main>

    <!-- Right-side cart drawer + backdrop -->
    <div id="cart-drawer-backdrop" class="fixed inset-0 bg-black/30 z-30 hidden"></div>
    <aside id="cart-drawer" 
      class="fixed top-0 right-0 h-screen w-[570px] max-w-full bg-white text-black shadow-2xl border-l border-neutral-200 z-40 
            transform translate-x-full transition-transform duration-400 ease-out 
            flex flex-col">
      
      <!-- Rest of your drawer content stays exactly the same -->
      <div class="flex items-center justify-between px-6 py-5 border-b border-neutral-200">
        <div class="text-lg font-bold tracking-wider uppercase text-neutral-800">Your Cart</div>
        <button id="cart-drawer-close" class="text-sm uppercase tracking-wider text-neutral-500 hover:text-black font-medium">Close</button>
      </div>
      <div id="cart-drawer-items" class="flex-1 overflow-y-auto p-5 space-y-3 text-sm">
        <div class="text-neutral-500 italic">No items yet</div>
      </div>
      <div class="p-5 border-t border-neutral-200">
        <div class="flex items-center justify-between mb-3">
          <div class="text-lg font-bold">Total: $<span id="cart-drawer-total">0.00</span></div>
        </div>
        <div class="flex gap-2">
          <button id="cart-clear" class="flex-1 px-4 py-2 text-xs font-medium uppercase tracking-[0.18em] border border-neutral-400 bg-white text-black hover:bg-neutral-100">Clear Cart</button>
          <button id="cart-go-checkout" class="flex-1 px-4 py-2 text-xs font-semibold uppercase tracking-[0.2em] bg-red-700 text-white border border-red-700 hover:bg-red-800">Checkout</button>
        </div>
      </div>
    </aside>

        <!-- Meal builder modal (Bowl/Plate/Bigger Plate) -->
        <div id="meal-modal" class="fixed inset-0 hidden items-center justify-center bg-black/60 z-50">
          <div class="bg-white text-black w-full max-w-3xl border border-neutral-200 rounded-lg overflow-hidden shadow-xl flex flex-col">
            <div class="px-6 py-4 border-b border-neutral-200 flex items-center justify-between">
              <div>
                <div class="text-lg font-semibold" id="meal-modal-title">Build Your Meal</div>
                <div class="text-sm text-neutral-600">Price: $<span id="meal-modal-price">0.00</span></div>
              </div>
              <button id="meal-modal-close" class="text-sm text-neutral-500 hover:text-black">Close</button>
            </div>
            <div class="px-6 py-5 grid grid-cols-1 lg:grid-cols-2 gap-6 overflow-y-auto max-h-[70vh]">
              <!-- Sides -->
              <section>
                <div class="text-sm uppercase tracking-[0.18em] text-neutral-700 font-semibold mb-3">Side (total 1)</div>
                <div class="text-xs text-neutral-500 mb-2" id="meal-side-hint">Select one full side.</div>
                <div id="meal-sides" class="grid grid-cols-2 gap-2"></div>
                <div class="mt-2 text-xs text-neutral-600">Selected: <span id="meal-side-count">0</span>/1</div>
              </section>
              <!-- Entrees -->
              <section>
                <div class="text-sm uppercase tracking-[0.18em] text-neutral-700 font-semibold mb-3">Entrees</div>
                <div class="text-xs text-neutral-500 mb-2">Choose up to <span id="meal-entree-max">1</span></div>
                <div id="meal-entrees" class="space-y-2 overflow-y-auto"></div>
                <div class="mt-2 text-xs text-neutral-600">Selected: <span id="meal-entree-count">0</span>/<span id="meal-entree-max-2">1</span></div>
              </section>
            </div>
            <div class="px-6 py-4 border-t border-neutral-200 flex items-center justify-end gap-3 bg-neutral-50">
              <button id="meal-modal-cancel" class="px-4 py-2 text-sm border border-neutral-300 bg-white hover:bg-neutral-100">Cancel</button>
              <button id="meal-add" class="px-5 py-2 text-sm font-semibold bg-red-700 text-white border border-red-700 hover:bg-red-800 disabled:opacity-40 disabled:cursor-not-allowed" disabled>Add to Cart</button>
            </div>
          </div>
        </div>

        <!-- Item details modal for adding to cart -->
        <div id="item-modal" class="fixed inset-0 hidden items-center justify-center bg-black/60 z-50">
          <div class="bg-white text-black w-full max-w-md border border-neutral-200 rounded-lg overflow-hidden shadow-xl">
            <div class="px-6 py-4 border-b border-neutral-200 flex items-center justify-between">
              <div class="text-lg font-semibold" id="item-modal-title">Item</div>
              <button id="item-modal-close" class="text-sm text-neutral-500 hover:text-black">Close</button>
            </div>
            <div class="px-6 py-5 space-y-4">
              <div class="text-neutral-600">Price: $<span id="item-modal-price">0.00</span></div>
              <div class="text-sm">
                <span class="text-neutral-600">Allergens:</span>
                <span id="item-modal-allergens" class="font-medium text-red-700">None</span>
              </div>
              <div class="flex items-center gap-3">
                <span class="text-sm text-neutral-600">Quantity</span>
                <div class="flex items-center gap-2">
                  <button id="item-qty-minus" class="px-3 py-2 border border-neutral-300">-</button>
                  <div id="item-qty" class="w-10 text-center font-semibold">1</div>
                  <button id="item-qty-plus" class="px-3 py-2 border border-neutral-300">+</button>
                </div>
              </div>
            </div>
            <div class="px-6 py-4 border-t border-neutral-200 flex items-center justify-end gap-3 bg-neutral-50">
              <button id="item-modal-cancel" class="px-4 py-2 text-sm border border-neutral-300 bg-white hover:bg-neutral-100">Cancel</button>
              <button id="item-add" class="px-5 py-2 text-sm font-semibold bg-red-700 text-white border border-red-700 hover:bg-red-800">Add to Cart</button>
            </div>
          </div>
        </div>

    <!-- Dine Option Selection Modal -->
    <div id="dine-option-modal" class="fixed inset-0 hidden items-center justify-center bg-black/70 z-50">
      <div class="bg-white text-black w-full max-w-md border border-neutral-200 rounded-lg overflow-hidden shadow-xl">
        <div class="px-6 py-4 border-b border-neutral-200 bg-red-700 text-white">
          <div class="text-lg font-semibold">Dine In or Takeout?</div>
          <div class="text-sm mt-1">Please select your dining preference</div>
        </div>
        <div class="px-6 py-6 grid grid-cols-2 gap-4">
          <button data-dine-option="dine_in" class="dine-option-btn flex flex-col items-center justify-center p-8 border-2 border-neutral-300 rounded-lg hover:border-red-600 hover:bg-red-50 transition-all">
            <svg class="w-16 h-16 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
            </svg>
            <span class="font-semibold text-lg">Dine In</span>
          </button>
          <button data-dine-option="takeout" class="dine-option-btn flex flex-col items-center justify-center p-8 border-2 border-neutral-300 rounded-lg hover:border-red-600 hover:bg-red-50 transition-all">
            <svg class="w-16 h-16 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
            </svg>
            <span class="font-semibold text-lg">Takeout</span>
          </button>
        </div>
        <div class="px-6 py-4 border-t border-neutral-200 flex justify-end">
          <button id="dine-option-cancel" class="px-4 py-2 text-sm border border-neutral-300 bg-white hover:bg-neutral-100 rounded">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Payment Method Selection Modal -->
    <div id="payment-modal" class="fixed inset-0 hidden items-center justify-center bg-black/70 z-50">
      <div class="bg-white text-black w-full max-w-md border border-neutral-200 rounded-lg overflow-hidden shadow-xl">
        <div class="px-6 py-4 border-b border-neutral-200 bg-red-700 text-white">
          <div class="text-lg font-semibold">Select Payment Method</div>
          <div class="text-sm mt-1">Total: $<span id="payment-total">0.00</span></div>
        </div>
        <div class="px-6 py-6 grid grid-cols-2 gap-3">
          <button data-method="card" class="payment-method-btn flex flex-col items-center justify-center p-6 border-2 border-neutral-300 rounded-lg hover:border-red-600 hover:bg-red-50 transition-all">
            <svg class="w-12 h-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
            </svg>
            <span class="font-semibold">Card</span>
          </button>
          <button data-method="cash" class="payment-method-btn flex flex-col items-center justify-center p-6 border-2 border-neutral-300 rounded-lg hover:border-red-600 hover:bg-red-50 transition-all">
            <svg class="w-12 h-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
            </svg>
            <span class="font-semibold">Cash</span>
          </button>
          <button data-method="giftcard" class="payment-method-btn flex flex-col items-center justify-center p-6 border-2 border-neutral-300 rounded-lg hover:border-red-600 hover:bg-red-50 transition-all">
            <svg class="w-12 h-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"></path>
            </svg>
            <span class="font-semibold">Gift Card</span>
          </button>
          <button data-method="dining_dollars" class="payment-method-btn flex flex-col items-center justify-center p-6 border-2 border-neutral-300 rounded-lg hover:border-red-600 hover:bg-red-50 transition-all">
            <svg class="w-12 h-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span class="font-semibold text-sm">Dining Dollars</span>
          </button>
          <button data-method="meal_swipe" class="payment-method-btn col-span-2 flex flex-col items-center justify-center p-6 border-2 border-neutral-300 rounded-lg hover:border-red-600 hover:bg-red-50 transition-all">
            <svg class="w-12 h-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0a2 2 0 104 0m-5 8a2 2 0 100-4 2 2 0 000 4zm0 0c1.306 0 2.417.835 2.83 2M9 14a3.001 3.001 0 00-2.83 2M15 11h3m-3 4h2"></path>
            </svg>
            <span class="font-semibold">Meal Swipe</span>
          </button>
        </div>
        <div class="px-6 py-4 border-t border-neutral-200 flex justify-end">
          <button id="payment-cancel" class="px-4 py-2 text-sm border border-neutral-300 bg-white hover:bg-neutral-100 rounded">Cancel</button>
        </div>
      </div>
    </div>

    <!-- ORDER SUCCESS MODAL -->
    <div id="order-success-modal" class="fixed inset-0 hidden items-center justify-center bg-black/70 z-50">
      <div class="bg-white text-black w-full max-w-lg border border-neutral-200 rounded-lg overflow-hidden shadow-2xl">
        <div class="px-8 py-10 text-center">
          <div class="mx-auto w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mb-6">
            <svg class="w-16 h-16 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
            </svg>
          </div>

          <h2 class="text-3xl font-bold text-neutral-900 mb-3">Order Placed!</h2>
          <p class="text-lg text-neutral-600 mb-6">
            Your order has been sent to the kitchen.
          </p>

          <div class="bg-neutral-50 rounded-lg px-6 py-5 mb-8 text-left">
            <div class="flex justify-between text-sm mb-2">
              <span class="text-neutral-600">Order Number</span>
              <span class="font-bold text-xl" id="success-order-number">#0000</span>
            </div>
            <div class="flex justify-between text-sm mb-2">
              <span class="text-neutral-600">Total Paid</span>
              <span class="font-bold text-xl" id="success-total">$0.00</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-neutral-600">Dine Option</span>
              <span class="font-medium capitalize" id="success-dine-option">—</span>
            </div>
          </div>

          <p class="text-sm text-neutral-500 mb-8">
            Please wait at the counter or take a seat.<br>
            We'll call your number when it's ready!
          </p>

          <button id="success-done-btn" class="px-10 py-4 text-lg font-semibold uppercase tracking-wider bg-red-700 text-white rounded-lg hover:bg-red-800 transition-all">
            Done
          </button>
        </div>
      </div>
    </div>

    <style>
      .nav-link {
        display: block;
        padding: 1rem 1.5rem;
        border-left: 4px solid transparent;
        background: #000;
        color: #d4d4d4;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }
      .nav-link:hover {
        background: #1f1f1f;
        color: #ffffff;
      }
      .nav-link.active {
        background: #b91c1c;
        border-left-color: #ef4444;
        color: #ffffff;
      }

      .item-card {
        display: flex;
        flex-direction: column;
        background: white;
        border: 2px solid #e5e5e5;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        transition: all 0.2s ease;
        text-align: left;
        overflow: hidden;
        cursor: pointer;
      }

      .item-card:hover {
        border-color: #dc2626;
        box-shadow: 0 4px 12px rgba(220, 38, 38, 0.15);
        transform: translateY(-2px);
      }

      .item-card:active {
        transform: translateY(0) scale(0.98);
      }

      .item-card .item-image {
        aspect-ratio: 1;
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0.5rem;
        overflow: hidden;
      }

      .item-card .item-img {
        width: 100%;
        height: 100%;
        max-width: 540px;
        max-height: 810px;
        object-fit: contain;
        border-radius: 8px;
        display: block;
        margin: 0 auto;
      }

      .item-card .item-placeholder {
        width: 100%;
        height: 100%;
        max-width: 160px;
        max-height: 160px;
        background: linear-gradient(135deg, #e5e5e5 0%, #d4d4d4 100%);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #737373;
        font-size: 0.75rem;
        font-weight: 500;
        text-align: center;
        padding: 1rem;
      }

      /* Cart drawer scrollbar */
      #cart-drawer-items::-webkit-scrollbar {
        width: 4px;
      }
      #cart-drawer-items::-webkit-scrollbar-track {
        background: #171717;
      }
      #cart-drawer-items::-webkit-scrollbar-thumb {
        background: #404040;
        border-radius: 2px;
      }
      #cart-drawer-items::-webkit-scrollbar-thumb:hover {
        background: #525252;
      }
    </style>

    <script>
      // Populate menu items from server data
      function populateMenu() {
        const categories = ['entrees', 'a_la_carte', 'sides', 'appetizers'];
        
        // Map item names to image filenames
        const imageMap = {
          'Bowl': 'bowl.jpg',
          'Plate': 'plate.jpg',
          'Bigger Plate': 'bigger-plate.jpg',
          'Beijing Beef': 'beijing-beef.jpg',
          'Black Pepper Chicken': 'black-pepper-chicken.jpg',
          'Black Pepper Sirloin Steak': 'black-pepper-sirloin-steak.jpg',
          'Broccoli Beef': 'broccoli-beef.jpg',
          'Grilled Teriyaki Chicken': 'grilled-teriyaki-chicken.jpg',
          'Honey Sesame Chicken Breast': 'honey-sesame-chicken-breast.jpg',
          'Honey Walnut Shrimp': 'honey-walnut-shrimp.jpg',
          'Kung Pao Chicken': 'kung-pao-chicken.jpg',
          'Mushroom Chicken': 'mushroom-chicken.jpg',
          'String Bean Chicken Breast': 'string-bean-chicken-breast.jpg',
          'The Original Orange Chicken': 'the-original-orange-chicken.jpg',
          'Fried Rice': 'fried-rice.jpg',
          'Chow Mein': 'chow-mein.jpg',
          'White Steamed Rice': 'white-steamed-rice.jpg',
          'Super Greens': 'super-greens.jpg',
          'Super Greens (Entree)': 'super-greens-(entree).jpg',
          'Super Greens (entree)': 'super-greens-(entree).jpg',
          'Chicken Egg Roll': 'chicken-egg-roll.jpg',
          'Veggie Spring Roll': 'veggie-spring-roll.jpg',
          'Cream Cheese Rangoon': 'cream-cheese-rangoon.jpg'
        };
        
        categories.forEach(category => {
          const container = document.querySelector(`#${category} .grid`);
          if (!container) return;
          
          container.innerHTML = '';
          
          const items = menuData[category] || [];
          
          items.forEach(item => {
            const card = document.createElement('button');
            card.className = 'item-card relative';
            card.dataset.name = item.name;
            card.dataset.price = item.price.toFixed(2);
            const allergensList = item.allergens || [];
            card.dataset.allergens = allergensList.join(', ');
            if (allergensList.length) {
              card.title = `Allergens: ${allergensList.join(', ')}`;
            }
            card.dataset.category = category;
            
            const imageSrc = imageMap[item.name] ? `/images/${imageMap[item.name]}` : '/images/placeholder.jpg';
            
            card.innerHTML = `
              ${allergensList.length ? `<span class="absolute top-2 right-2 w-5 h-5 rounded-full bg-red-700 text-white text-[10px] font-bold flex items-center justify-center" title="Allergens: ${allergensList.join(', ')}">i</span>` : ''}
              <div class="item-image">
                <img src="${imageSrc}" alt="${item.name}" class="item-img" />
              </div>
              <div class="px-4 py-4 flex flex-col gap-2">
                <div class="text-sm font-semibold leading-snug">${item.name}</div>
                <div class="text-base font-bold text-red-700">$${item.price.toFixed(2)}</div>
              </div>
            `;
            
            container.appendChild(card);
          });
        });
      }

      // Initialize menu on page load
      populateMenu();

      // Category titles and descriptions
      const categoryInfo = {
        entrees: {
          title: "Entrees",
          description: "Choose your main dish to start your order."
        },
        a_la_carte: {
          title: "A La Carte",
          description: "Individual entrees and sides."
        },
        sides: {
          title: "Sides",
          description: "Choose from fried rice, chow mein, or super greens."
        },
        appetizers: {
          title: "Appetizers",
          description: "Start your meal with delicious appetizers."
        }
      };

      // Navigation between categories
      document.querySelectorAll(".nav-link").forEach((link) => {
        link.addEventListener("click", function () {
          // Remove active class from all links and sections
          document.querySelectorAll(".nav-link").forEach((a) => a.classList.remove("active"));
          document.querySelectorAll(".category-section").forEach((sec) => {
            sec.classList.add("hidden");
          });
          
          // Add active class to clicked link
          this.classList.add("active");
          
          // Show the corresponding category section
          const cat = this.dataset.category;
          const section = document.getElementById(cat);
          if (section) {
            section.classList.remove("hidden");
          }
          
          // Update header with category info
          const info = categoryInfo[cat];
          if (info) {
            document.getElementById("category-title").textContent = info.title;
            document.querySelector("header p").textContent = info.description;
          }
        });
      });

      // Cart state (persist across pages)
      const CART_KEY = 'kiosk_cart';
      function loadCart() { try { return JSON.parse(localStorage.getItem(CART_KEY)) || []; } catch { return []; } }
      function saveCart(c) { localStorage.setItem(CART_KEY, JSON.stringify(c)); }
      let cart = loadCart();

      // Convert meal details (sides + entrees) into a flat list of options
      function extractOptionsForItem(item) {
        const opts = [];
        if (!item || !item.details) return opts;
        const { sides, entrees } = item.details;

        // Sides
        if (sides) {
          if (sides.type === 'full' && sides.name) {
            // one full side
            opts.push({ name: sides.name, qty: 1, kind: 'side' });
          } else if (Array.isArray(sides.items)) {
            // halves / doubles: count occurrences
            const counts = {};
            sides.items.forEach((n) => {
              if (!n) return;
              counts[n] = (counts[n] || 0) + 1;
            });
            Object.entries(counts).forEach(([name, qty]) => {
              opts.push({ name, qty, kind: 'side' });
            });
          }
        }

        // Entrees
        if (Array.isArray(entrees)) {
          entrees.forEach((e) => {
            if (!e || !e.name) return;
            const qty = e.count || 1;
            opts.push({ name: e.name, qty, kind: 'entree' });
          });
        }

        return opts;
      }

      function renderCartDrawer() {
        const count = cart.reduce((s, i) => s + i.quantity, 0);
        const total = cart.reduce((s, i) => s + (i.price * i.quantity), 0).toFixed(2);
        
        document.getElementById("cart-count").textContent = count;
        document.getElementById("cart-total").textContent = total;
        const itemsEl = document.getElementById('cart-drawer-items');
        const totalEl = document.getElementById('cart-drawer-total');
        totalEl.textContent = total;
        if (cart.length === 0) {
          itemsEl.innerHTML = '<div class="text-neutral-500 italic">No items yet</div>';
        } else {
          itemsEl.innerHTML = cart.map((item, idx) => {
            if (item.type === 'meal' && item.details) {
              // Tree format for meals
              const maybeEdit = `<button data-idx="${idx}" class="edit-meal px-2 py-1 text-xs border border-neutral-300">Edit</button>`;
              let childrenHtml = '';
              // Sides
              if (item.details.sides) {
                if (item.details.sides.type === 'full') {
                  childrenHtml += `<div class="ml-4 pl-3 border-l-2 border-neutral-300 text-xs text-neutral-700">Side: ${item.details.sides.name} (Full)</div>`;
                } else if (Array.isArray(item.details.sides.items)) {
                  childrenHtml += `<div class="ml-4 pl-3 border-l-2 border-neutral-300 text-xs text-neutral-700">Sides: ${item.details.sides.items.join(' + ')} (Halves)</div>`;
                }
              }
              // Entrees
              if (Array.isArray(item.details.entrees) && item.details.entrees.length) {
                const entreesLines = item.details.entrees.map(e => {
                  const countLabel = e.count > 1 ? ` x${e.count}` : '';
                  return `<div class="ml-4 pl-3 border-l-2 border-neutral-300 text-xs text-neutral-700">Entree: ${e.name}${countLabel}</div>`;
                }).join('');
                childrenHtml += entreesLines;
              }
              return `
              <div class="border-b border-neutral-200 pb-3 last:border-b-0">
                <div class="flex items-start justify-between gap-3">
                  <div class="flex-1">
                    <div class="font-medium">${item.name}</div>
                  </div>
                  <div class="flex items-center gap-2">
                    ${maybeEdit}
                    <button data-idx="${idx}" class="delete-item px-2 py-1 text-xs text-red-700 border border-red-300 hover:bg-red-50">Delete</button>
                    <div class="w-16 text-right font-semibold">$${(item.price * item.quantity).toFixed(2)}</div>
                  </div>
                </div>
                ${childrenHtml}
              </div>`;
            } else {
              // Simple item
              return `
              <div class="flex items-start justify-between gap-3 border-b border-neutral-200 pb-3 last:border-b-0">
                <div class="flex-1">
                  <div class="font-medium">${item.name}</div>
                  <div class="text-xs text-neutral-500 mt-1">Qty: ${item.quantity}</div>
                </div>
                <div class="flex items-center gap-2">
                  <button data-idx="${idx}" class="qty-minus px-2 py-1 text-xs border border-neutral-300">-</button>
                  <button data-idx="${idx}" class="qty-plus px-2 py-1 text-xs border border-neutral-300">+</button>
                  <button data-idx="${idx}" class="delete-item px-2 py-1 text-xs text-red-700 border border-red-300 hover:bg-red-50">Delete</button>
                  <div class="w-16 text-right font-semibold">$${(item.price * item.quantity).toFixed(2)}</div>
                </div>
              </div>`;
            }
          }).join('');
        }
        // persist cart
        saveCart(cart);
      }

      function openCartDrawer() {
        document.getElementById('cart-drawer').classList.remove('translate-x-full');
        document.getElementById('cart-drawer-backdrop').classList.remove('hidden');
      }

      function closeCartDrawer() {
        document.getElementById('cart-drawer').classList.add('translate-x-full');
        document.getElementById('cart-drawer-backdrop').classList.add('hidden');
      }

      function addToCart(name, price, qty = 1) {
        const existing = cart.find(i => i.name === name);
        if (existing) {
          existing.quantity += qty;
        } else {
          cart.push({ name, price: parseFloat(price), quantity: qty });
        }
        renderCartDrawer();
        saveCart(cart);
        openCartDrawer();
      }

      // Add click handlers to all item cards
      document.addEventListener('click', (e) => {
        const card = e.target.closest('.item-card');
        if (card) {
          const name = card.dataset.name;
          const price = card.dataset.price;
          // If selection is a meal type, open meal builder instead of item modal
          const mealNames = new Set(['Bowl','Plate','Bigger Plate']);
          if (mealNames.has(name)) {
            const slug = name === 'Bowl' ? 'bowl' : (name === 'Bigger Plate' ? 'bigger-plate' : 'plate');
            window.location.href = `/builder/${slug}`;
            return;
          }
          const allergens = (card.dataset.allergens || '')
            .split(',')
            .map(t => t.trim())
            .filter(Boolean);
          openItemModal(name, price, allergens);
        }
      });

      // Item details modal logic
      const itemModal = document.getElementById('item-modal');
      const itemModalTitle = document.getElementById('item-modal-title');
      const itemModalPrice = document.getElementById('item-modal-price');
      const itemModalAllergens = document.getElementById('item-modal-allergens');
      const itemQtyEl = document.getElementById('item-qty');
      const itemQtyMinus = document.getElementById('item-qty-minus');
      const itemQtyPlus = document.getElementById('item-qty-plus');
      const itemModalClose = document.getElementById('item-modal-close');
      const itemModalCancel = document.getElementById('item-modal-cancel');
      const itemAddBtn = document.getElementById('item-add');

      let selectedItemName = '';
      let selectedItemPrice = 0;
      let selectedQty = 1;
      let selectedAllergens = [];

      function openItemModal(name, price, allergens = []) {
        selectedItemName = name;
        selectedItemPrice = parseFloat(price);
        selectedQty = 1;
        selectedAllergens = Array.isArray(allergens) ? allergens : [];
        itemModalTitle.textContent = name;
        itemModalPrice.textContent = selectedItemPrice.toFixed(2);
        itemQtyEl.textContent = String(selectedQty);
        itemModalAllergens.textContent = selectedAllergens.length ? selectedAllergens.join(', ') : 'None';
        itemModal.classList.remove('hidden');
        itemModal.classList.add('flex');
      }

      function closeItemModal() {
        itemModal.classList.add('hidden');
        itemModal.classList.remove('flex');
      }

      itemQtyMinus.addEventListener('click', (e) => {
        e.stopPropagation();
        if (selectedQty > 1) {
          selectedQty -= 1;
          itemQtyEl.textContent = String(selectedQty);
        }
      });

      itemQtyPlus.addEventListener('click', (e) => {
        e.stopPropagation();
        selectedQty += 1;
        itemQtyEl.textContent = String(selectedQty);
      });

      itemModalClose.addEventListener('click', () => closeItemModal());
      itemModalCancel.addEventListener('click', () => closeItemModal());
      itemModal.addEventListener('click', (e) => {
        if (e.target === itemModal) closeItemModal();
      });

      itemAddBtn.addEventListener('click', () => {
        if (selectedItemName) {
          addToCart(selectedItemName, selectedItemPrice, selectedQty);
        }
        closeItemModal();
      });

      // -------- Meal builder logic ---------
      const mealModal = document.getElementById('meal-modal');
      const mealTitle = document.getElementById('meal-modal-title');
      const mealPriceEl = document.getElementById('meal-modal-price');
      const mealSidesEl = document.getElementById('meal-sides');
      const mealEntreesEl = document.getElementById('meal-entrees');
      const mealSideCountEl = document.getElementById('meal-side-count');
      const mealEntreeCountEl = document.getElementById('meal-entree-count');
      const mealEntreeMaxEl = document.getElementById('meal-entree-max');
      const mealEntreeMax2El = document.getElementById('meal-entree-max-2');
      const mealSideHint = document.getElementById('meal-side-hint');
      const mealAddBtn = document.getElementById('meal-add');
      const mealClose = document.getElementById('meal-modal-close');
      const mealCancel = document.getElementById('meal-modal-cancel');

      let mealConfig = null; // {type, price, entreeSlots, allowHalfSide}
      let sideCounts = {};   // name -> 0, 0.5, 1
      let entreeCounts = {}; // name -> int
      let editingMealIndex = null; // if editing existing cart item

      const proteins = (menuData.entrees || []).filter(i => !['Bowl','Plate','Bigger Plate'].includes(i.name));
      const sides = (menuData.sides || []);

      function openMealModal(typeName, price, existing = null, editIndex = null) {
        editingMealIndex = editIndex;
        const type = typeName.toLowerCase();
        const cfg = { type: type, price: Number(price), entreeSlots: 1, allowHalfSide: false };
        if (type.includes('plate') && !type.includes('bigger')) { cfg.entreeSlots = 2; cfg.allowHalfSide = true; }
        if (type.includes('bigger')) { cfg.entreeSlots = 3; cfg.allowHalfSide = true; }
        if (type.includes('bowl')) { cfg.entreeSlots = 1; cfg.allowHalfSide = false; }
        mealConfig = cfg;

        mealTitle.textContent = `${typeName}`;
        mealPriceEl.textContent = cfg.price.toFixed(2);
        mealEntreeMaxEl.textContent = String(cfg.entreeSlots);
        mealEntreeMax2El.textContent = String(cfg.entreeSlots);
        mealSideHint.textContent = cfg.allowHalfSide ? 'Select sides up to a total of 1 (halves allowed).' : 'Select one full side.';

        // Reset counts
        sideCounts = {};
        entreeCounts = {};
        sides.forEach(s => sideCounts[s.name] = 0);
        proteins.forEach(p => entreeCounts[p.name] = 0);

        // If editing, preload existing selections
        if (existing && existing.details) {
          const d = existing.details;
          if (d.sides) {
            if (d.sides.type === 'full' && d.sides.name) {
              sideCounts[d.sides.name] = 1;
            } else if (d.sides.type === 'halves' && Array.isArray(d.sides.items)) {
              d.sides.items.forEach(n => { if (n && n in sideCounts) sideCounts[n] = Math.min(1, sideCounts[n] + 0.5); });
            }
          }
          if (Array.isArray(d.entrees)) {
            d.entrees.forEach(e => { if (e.name in entreeCounts) entreeCounts[e.name] = e.count; });
          }
        }

        renderMealSides();
        renderMealEntrees();
        updateMealValidity();

        mealModal.classList.remove('hidden');
        mealModal.classList.add('flex');
      }

      function closeMealModal() {
        mealModal.classList.add('hidden');
        mealModal.classList.remove('flex');
        editingMealIndex = null;
      }

      function totalSide() { return Object.values(sideCounts).reduce((s,v)=>s+v,0); }
      function totalEntrees() { return Object.values(entreeCounts).reduce((s,v)=>s+v,0); }

      function renderMealSides() {
        mealSidesEl.innerHTML = '';
        sides.forEach(s => {
          const val = sideCounts[s.name] || 0;
          const btn = document.createElement('button');
          btn.className = 'w-full text-left border border-neutral-300 px-3 py-2 flex items-center justify-between hover:bg-neutral-50';
          btn.innerHTML = `
            <span>${s.name}</span>
            <span class="text-xs text-neutral-600">${val === 1 ? 'Full' : val === 0.5 ? 'Half' : ''}</span>
          `;
          btn.addEventListener('click', () => {
            if (!mealConfig.allowHalfSide) {
              // set this side to 1 and others to 0
              Object.keys(sideCounts).forEach(k => sideCounts[k] = 0);
              sideCounts[s.name] = 1;
            } else {
              // cycle 0 -> 0.5 -> 1 -> 0 constrained by total ≤ 1
              const next = val === 0 ? 0.5 : (val === 0.5 ? 1 : 0);
              const newTotal = totalSide() - val + next;
              if (newTotal <= 1) sideCounts[s.name] = next;
            }
            mealSideCountEl.textContent = String(totalSide());
            renderMealSides();
            updateMealValidity();
          });
          mealSidesEl.appendChild(btn);
        });
        mealSideCountEl.textContent = String(totalSide());
      }

      function renderMealEntrees() {
        mealEntreesEl.innerHTML = '';
        proteins.forEach(p => {
          const count = entreeCounts[p.name] || 0;
          const row = document.createElement('div');
          row.className = 'border border-neutral-300 px-3 py-2 flex items-center justify-between';
          row.innerHTML = `
            <div class="font-medium">${p.name}</div>
            <div class="flex items-center gap-2">
              <button class="dec px-2 py-1 border border-neutral-300">-</button>
              <div class="w-6 text-center">${count}</div>
              <button class="inc px-2 py-1 border border-neutral-300">+</button>
            </div>
          `;
          row.querySelector('.inc').addEventListener('click', () => {
            const current = entreeCounts[p.name] || 0;
            if (totalEntrees() < mealConfig.entreeSlots) {
              entreeCounts[p.name] = current + 1;
              renderMealEntrees();
              updateMealValidity();
            }
          });
          row.querySelector('.dec').addEventListener('click', () => {
            const current = entreeCounts[p.name] || 0;
            if (current > 0) {
              entreeCounts[p.name] = current - 1;
              renderMealEntrees();
              updateMealValidity();
            }
          });
          mealEntreesEl.appendChild(row);
        });
        mealEntreeCountEl.textContent = String(totalEntrees());
        mealEntreeMax2El.textContent = String(mealConfig.entreeSlots);
      }

      function updateMealValidity() {
        const okSides = Math.abs(totalSide() - 1) < 1e-6;
        const okEntrees = totalEntrees() === mealConfig.entreeSlots;
        mealAddBtn.disabled = !(okSides && okEntrees);
      }

      function buildMealDetails() {
        // sides
        const entries = Object.entries(sideCounts).filter(([_,v]) => v>0).sort((a,b)=>b[1]-a[1]);
        let sidesDetail = null;
        if (entries.length === 1 && entries[0][1] === 1) {
          sidesDetail = { type: 'full', name: entries[0][0] };
        } else {
          const items = [];
          entries.forEach(([n,v]) => {
            if (v === 1) { items.push(n, n); }
            else if (v === 0.5) { items.push(n); }
          });
          sidesDetail = { type: 'halves', items };
        }
        // entrees
        const entreesDetail = Object.entries(entreeCounts)
          .filter(([_,c]) => c>0)
          .map(([name,count]) => ({ name, count }));
        return { sides: sidesDetail, entrees: entreesDetail };
      }

      mealAddBtn.addEventListener('click', () => {
        const details = buildMealDetails();
        const mealName = mealTitle.textContent;
        const price = Number(mealPriceEl.textContent);
        const itemObj = { name: mealName, price, quantity: 1, type: 'meal', details };
        if (editingMealIndex !== null && cart[editingMealIndex]) {
          cart[editingMealIndex] = { ...cart[editingMealIndex], name: mealName, price, details };
        } else {
          cart.push(itemObj);
        }
        renderCartDrawer();
        openCartDrawer();
        closeMealModal();
      });

      mealClose.addEventListener('click', closeMealModal);
      mealCancel.addEventListener('click', closeMealModal);
      mealModal.addEventListener('click', (e) => { if (e.target === mealModal) closeMealModal(); });

      // Drawer events
      document.getElementById('cart-open-drawer').addEventListener('click', openCartDrawer);
      document.getElementById('cart-drawer-close').addEventListener('click', closeCartDrawer);
      document.getElementById('cart-drawer-backdrop').addEventListener('click', closeCartDrawer);

      // Delegate quantity buttons in drawer
      document.getElementById('cart-drawer-items').addEventListener('click', (e) => {
        const target = e.target;
        if (!(target instanceof Element)) return;
        const idxAttr = target.getAttribute('data-idx');
        const idx = Number(idxAttr);
        if (target.classList.contains('edit-meal')) {
          const i = Number(idxAttr);
          const it = cart[i];
          if (it && it.type === 'meal') {
            const slug = it.name === 'Bowl' ? 'bowl' : (it.name === 'Bigger Plate' ? 'bigger-plate' : 'plate');
            window.location.href = `/builder/edit?idx=${i}&type=${slug}`;
          }
          return;
        }

        if (!Number.isFinite(idx) || !cart[idx]) return;

        if (target.classList.contains('qty-minus')) {
          cart[idx].quantity -= 1;
          if (cart[idx].quantity <= 0) cart.splice(idx, 1);
          renderCartDrawer();
        } else if (target.classList.contains('qty-plus')) {
          cart[idx].quantity += 1;
          renderCartDrawer();
        } else if (target.classList.contains('delete-item')) {
          cart.splice(idx, 1);
          renderCartDrawer();
        }
      });

      // Optional: go to checkout from drawer
      let selectedDineOption = null; // Store the user's dine option choice
      
      document.getElementById('cart-go-checkout').addEventListener('click', () => {
        if (cart.length === 0) {
          alert("Please add items to your cart first");
          return;
        }
        // Show dine option modal first
        document.getElementById('dine-option-modal').classList.remove('hidden');
        document.getElementById('dine-option-modal').classList.add('flex');
        closeCartDrawer();
      });

      // Dine option modal handlers
      const dineOptionModal = document.getElementById('dine-option-modal');
      
      document.getElementById('dine-option-cancel').addEventListener('click', () => {
        dineOptionModal.classList.add('hidden');
        dineOptionModal.classList.remove('flex');
        openCartDrawer();
      });

      document.querySelectorAll('.dine-option-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          selectedDineOption = btn.getAttribute('data-dine-option');
          
          // Hide dine option modal and show payment modal
          dineOptionModal.classList.add('hidden');
          dineOptionModal.classList.remove('flex');
          
          const total = cart.reduce((s, i) => s + (i.price * i.quantity), 0).toFixed(2);
          document.getElementById('payment-total').textContent = total;
          document.getElementById('payment-modal').classList.remove('hidden');
          document.getElementById('payment-modal').classList.add('flex');
        });
      });

      // Payment modal handlers
      const paymentModal = document.getElementById('payment-modal');
      
      document.getElementById('payment-cancel').addEventListener('click', () => {
        paymentModal.classList.add('hidden');
        paymentModal.classList.remove('flex');
        // Go back to dine option modal
        selectedDineOption = null;
        dineOptionModal.classList.remove('hidden');
        dineOptionModal.classList.add('flex');
      });

      document.querySelectorAll('.payment-method-btn').forEach((btn) => {
        btn.addEventListener('click', async () => {
          const method = btn.getAttribute('data-method');

          const checkoutCart = cart.map((item) => {
            if (item.type === 'meal' && item.details) {
              const options = extractOptionsForItem(item);
              return { ...item, options };
            }
            return item;
          });

          if (!checkoutCart.length) {
            alert('Cart is empty.');
            return;
          }

          try {
            const response = await fetch('/api/checkout', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ cart: checkoutCart, paymentMethod: method, dineOption: selectedDineOption }),
            });

            const data = await response.json();

            if (data.success) {
              const total = checkoutCart.reduce((s, i) => s + i.price * i.quantity, 0).toFixed(2);

              // Fill success modal
              document.getElementById('success-order-number').textContent = `#${data.order_id}`;
              document.getElementById('success-total').textContent = `$${total}`;
              document.getElementById('success-dine-option').textContent = 
                selectedDineOption === 'dine_in' ? 'Dine In' : 'Takeout';

              // Clear cart
              cart = [];
              renderCartDrawer();
              saveCart(cart);

              // Hide payment modal
              paymentModal.classList.add('hidden');
              paymentModal.classList.remove('flex');

              // Show success modal
              document.getElementById('order-success-modal').classList.remove('hidden');
              document.getElementById('order-success-modal').classList.add('flex');
            } else {
              alert('Failed to place order: ' + (data.error || 'Unknown error'));
              paymentModal.classList.add('hidden');
              paymentModal.classList.remove('flex');
              openCartDrawer();
            }
          } catch (err) {
            console.error('Checkout error:', err);
            alert('Failed to place order. Please try again.');
            paymentModal.classList.add('hidden');
            paymentModal.classList.remove('flex');
            openCartDrawer();
          }
        });
      });

      // Close success modal and restart
      document.getElementById('success-done-btn').addEventListener('click', () => {
        document.getElementById('order-success-modal').classList.add('hidden');
        document.getElementById('order-success-modal').classList.remove('flex');
        setTimeout(() => window.location.reload(), 800);
      });
      

      document.getElementById("cart-clear").addEventListener("click", () => {
        if (cart.length === 0) return;
        if (confirm("Clear all items from cart?")) {
          cart = [];
          renderCartDrawer();
          saveCart(cart);
        }
      });

      // Initialize cart display
      renderCartDrawer();
    </script>
  </body>
</html>