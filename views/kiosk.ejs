<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panda Express Kiosk</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <style>
    html {
      font-size: 17px !important;
    }

    /* Buttons & key numbers */
    button {
      font-size: 1.6rem !important;
      padding: 1rem 1.5rem !important;   /* ‚Üê fixed line */
    }
    
    #call-staff-btn {
      padding: 0.5rem 1rem !important;
      width: fit-content !important;
    }

    /* Text classes ‚Äì all bumped up */
    .text-xs   { font-size: 1.1rem !important; }
    .text-sm   { font-size: 1.4rem !important; }
    .text-base { font-size: 1.6rem !important; }

    /* Cart drawer items & modal buttons */
    #cart-drawer-items > div,
    .payment-method-btn,
    .dine-option-btn,
    #success-done-btn {
      padding: 1.8rem 1.2rem !important;
      font-weight: 700 !important;
      font-size: 1.8rem !important;
    }

    /* Success modal title */
    #order-success-modal h2 {
      font-size: 2.5rem !important;
    }

    /* Bottom bar total ‚Äì huge and clear */
    #cart-total {
      font-size: 4.2rem !important;
      font-weight: 900 !important;
    }
    
  </style>

  <style id="text-size-styles">
    /* Text size configurations - Large (default) */
    html.text-size-large {
      font-size: 17px !important;
    }
    html.text-size-large button {
      font-size: 1.6rem !important;
      padding: 2rem 1.5rem !important;
    }
    html.text-size-large .nav-link {
      padding: 2rem 1.5rem !important;
    }
    html.text-size-large .text-xs { font-size: 1.1rem !important; }
    html.text-size-large .text-sm { font-size: 1.4rem !important; }
    html.text-size-large .text-base { font-size: 1.6rem !important; }
    html.text-size-large #cart-total,
    html.text-size-large #cart-drawer-total,
    html.text-size-large #success-total { font-size: 2rem !important; }
    html.text-size-large #success-order-number { font-size: 3rem !important; }
    html.text-size-large #item-qty { font-size: 4.5rem !important; }
    html.text-size-large #cart-drawer-items > div,
    html.text-size-large .payment-method-btn,
    html.text-size-large .dine-option-btn,
    html.text-size-large #success-done-btn { font-size: 1.8rem !important; padding: 1.8rem 1.2rem !important; }
    html.text-size-large #order-success-modal h2 { font-size: 4.5rem !important; }
    html.text-size-large #order-success-modal .text-lg { font-size: 2rem !important; }
    html.text-size-large #order-success-modal .text-sm { font-size: 1.4rem !important; }
    html.text-size-large #order-success-modal .font-medium { font-size: 1.6rem !important; }
    html.text-size-large #order-success-modal .font-bold { font-size: 1.8rem !important; }

    /* Medium text size */
    html.text-size-medium {
      font-size: 14px !important;
    }
    html.text-size-medium button {
      font-size: 1.4rem !important;
      padding: 2rem 1.2rem !important;
    }
    html.text-size-medium .nav-link {
      padding: 2rem 1.5rem !important;
    }
    html.text-size-medium .text-xs { font-size: 0.9rem !important; }
    html.text-size-medium .text-sm { font-size: 1.1rem !important; }
    html.text-size-medium .text-base { font-size: 1.3rem !important; }
    html.text-size-medium #cart-total,
    html.text-size-medium #cart-drawer-total,
    html.text-size-medium #success-total { font-size: 2rem !important; }
    html.text-size-medium #success-order-number { font-size: 3rem !important; }
    html.text-size-medium #item-qty { font-size: 3.5rem !important; }
    html.text-size-medium #cart-drawer-items > div,
    html.text-size-medium .payment-method-btn,
    html.text-size-medium .dine-option-btn,
    html.text-size-medium #success-done-btn { font-size: 1.5rem !important; padding: 1.5rem 1rem !important; }
    html.text-size-medium #order-success-modal h2 { font-size: 3.5rem !important; }
    html.text-size-medium #order-success-modal .text-lg { font-size: 1.6rem !important; }
    html.text-size-medium #order-success-modal .text-sm { font-size: 1.1rem !important; }
    html.text-size-medium #order-success-modal .font-medium { font-size: 1.3rem !important; }
    html.text-size-medium #order-success-modal .font-bold { font-size: 1.4rem !important; }

    /* Small text size */
    html.text-size-small {
      font-size: 12px !important;
    }
    html.text-size-small button {
      font-size: 1.2rem !important;
      padding: 0.6rem 1rem !important;
    }
    html.text-size-small .text-xs { font-size: 0.75rem !important; }
    html.text-size-small .text-sm { font-size: 0.9rem !important; }
    html.text-size-small .text-base { font-size: 1.1rem !important; }
    html.text-size-small #cart-total,
    html.text-size-small #cart-drawer-total,
    html.text-size-small #success-total { font-size: 2.5rem !important; }
    html.text-size-small #success-order-number { font-size: 3.2rem !important; }
    html.text-size-small #item-qty { font-size: 3rem !important; }
    html.text-size-small #cart-drawer-items > div,
    html.text-size-small .payment-method-btn,
    html.text-size-small .dine-option-btn,
    html.text-size-small #success-done-btn { font-size: 1.3rem !important; padding: 1.2rem 0.8rem !important; }
    html.text-size-small #order-success-modal h2 { font-size: 2.8rem !important; }
    html.text-size-small #order-success-modal .text-lg { font-size: 1.3rem !important; }
    html.text-size-small #order-success-modal .text-sm { font-size: 0.9rem !important; }
    html.text-size-small #order-success-modal .font-medium { font-size: 1.1rem !important; }
    html.text-size-small #order-success-modal .font-bold { font-size: 1.2rem !important; }
  </style>

<body class="h-screen flex bg-black text-white overflow-hidden">
    <script>
      const menuData = JSON.parse('<%- JSON.stringify(menu || {}) %>');
    </script>
    

    <!-- Landing Page / Screensaver -->
    <div id="landing-page" role="complementary" aria-label="Welcome Screen" class="fixed inset-0 z-[100] flex flex-col items-center justify-center cursor-pointer overflow-hidden">
      <!-- Background -->
      <div class="absolute inset-0 bg-gradient-to-br from-red-900 via-red-700 to-red-800"></div>
      
      <!-- Content overlay -->
      <div class="relative z-10 text-center">
        <img src="/images/panda_logo.png" alt="Panda Express" class="w-64 h-64 mx-auto mb-8 drop-shadow-2xl animate-pulse">
        <h1 class="text-6xl font-bold text-white mb-4 drop-shadow-2xl">Welcome to Panda Express</h1>
        <p class="text-3xl text-white/95 mb-12 drop-shadow-xl">Tap anywhere to start your order</p>
        <div class="text-white/80 text-xl">
          <svg class="w-16 h-16 mx-auto animate-bounce drop-shadow-lg" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
          </svg>
        </div>
      </div>
    </div>
    
    <aside class="w-72 bg-black border-r border-red-900 flex flex-col h-screen">
      <div class="px-6 pt-8 pb-4 flex-shrink-0">
        <img src="/images/panda_logo.png" alt="Panda Express" class="w-32 mb-4">
        <div class="text-xs tracking-[0.25em] uppercase text-red-500 font-bold" data-original="Panda Express">Panda Express</div>
        <div class="mt-1 text-sm tracking-[0.2em] uppercase text-neutral-300 font-semibold" data-original="Self-Service Kiosk">Self-Service Kiosk</div>
      </div>

      <div class="flex-1 overflow-y-auto">
        <nav aria-label="Main navigation" class="flex-shrink-0">
          <ul class="flex flex-col text-sm">
            <li>
              <button data-category="entrees" class="nav-link active w-full text-left" data-original="Entrees">Entrees</button>
            </li>
            <li>
              <button data-category="a_la_carte" class="nav-link w-full text-left" data-original="A La Carte">A La Carte</button>
            </li>
            <li>
              <button data-category="sides" class="nav-link w-full text-left" data-original="Sides">Sides</button>
            </li>
            <li>
              <button data-category="appetizers" class="nav-link w-full text-left" data-original="Appetizers">Appetizers</button>
            </li>
            <li>
              <button data-category="drinks" class="nav-link w-full text-left" data-original="Drinks">Drinks</button>
            </li>
          </ul>
        </nav>

        <div class="border-t border-neutral-800">
        <button id="accessibility-toggle" class="w-full px-6 py-4 text-left text-sm font-semibold text-neutral-300 hover:bg-neutral-900 transition flex items-center justify-between">
          <span><span class="no-translate">‚öôÔ∏è</span> <span data-original="Accessibility">Accessibility</span></span>
          <span id="accessibility-arrow" class="transform transition-transform no-translate">‚ñº</span>
        </button>
        
        <div id="accessibility-panel" class="hidden px-6 pb-4">
          <div class="mb-4">
            <div class="text-xs uppercase tracking-wide text-neutral-300 font-semibold mb-2" data-original="Language">Language</div>
            <div class="flex gap-2 flex-wrap">
              <button onclick="changeLanguage('en')" class="text-xs font-bold text-white bg-neutral-800 px-2 py-2 rounded hover:bg-red-700 transition flex flex-col items-center gap-1">
                <span class="text-base">üá∫üá∏</span>
                <span class="text-[0.6rem]">EN</span>
              </button>
              <button onclick="changeLanguage('es')" class="text-xs font-bold text-white bg-neutral-800 px-2 py-2 rounded hover:bg-red-700 transition flex flex-col items-center gap-1">
                <span class="text-base">üá™üá∏</span>
                <span class="text-[0.6rem]">ES</span>
              </button>
              <button onclick="changeLanguage('zh')" class="text-xs font-bold text-white bg-neutral-800 px-2 py-2 rounded hover:bg-red-700 transition flex flex-col items-center gap-1">
                <span class="text-base">üá®üá≥</span>
                <span class="text-[0.6rem]">ZH</span>
              </button>
              <button onclick="changeLanguage('fr')" class="text-xs font-bold text-white bg-neutral-800 px-2 py-2 rounded hover:bg-red-700 transition flex flex-col items-center gap-1">
                <span class="text-base">üá´üá∑</span>
                <span class="text-[0.6rem]">FR</span>
              </button>
              <button onclick="changeLanguage('de')" class="text-xs font-bold text-white bg-neutral-800 px-2 py-2 rounded hover:bg-red-700 transition flex flex-col items-center gap-1">
                <span class="text-base">üá©üá™</span>
                <span class="text-[0.6rem]">DE</span>
              </button>
            </div>
          </div>

          <div>
            <div class="text-xs uppercase tracking-wide text-neutral-300 font-semibold mb-2" data-original="Text Size">Text Size</div>
            <div class="flex gap-2 flex-wrap">
              <button onclick="changeTextSize('small')" class="text-size-btn text-white bg-neutral-800 px-3 py-2 rounded hover:bg-red-700 transition flex flex-col items-center gap-1" data-size="small">
                <span class="text-xs font-bold">Aa</span>
                <span class="text-[0.55rem] uppercase tracking-wide" data-original="Small">Small</span>
              </button>
              <button onclick="changeTextSize('medium')" class="text-size-btn text-white bg-neutral-800 px-3 py-2 rounded hover:bg-red-700 transition flex flex-col items-center gap-1" data-size="medium">
                <span class="text-sm font-bold">Aa</span>
                <span class="text-[0.55rem] uppercase tracking-wide" data-original="Medium">Medium</span>
              </button>
              <button onclick="changeTextSize('large')" class="text-size-btn text-white bg-red-700 px-3 py-2 rounded hover:bg-red-800 transition flex flex-col items-center gap-1" data-size="large">
                <span class="text-base font-bold">Aa</span>
                <span class="text-[0.55rem] uppercase tracking-wide" data-original="Large">Large</span>
              </button>
            </div>
          </div>

          <div class="mt-4">
            <div class="text-xs uppercase tracking-wide text-neutral-300 font-semibold mb-2" data-original="Screen Reader">Screen Reader</div>
            <button id="tts-toggle" class="flex items-center gap-3 px-4 py-3 bg-neutral-800 hover:bg-neutral-700 rounded text-white transition-colors w-full">
              <span class="text-2xl no-translate" id="tts-icon">üîá</span>
              <div class="text-left flex-1">
                <div class="text-sm font-semibold" data-original="Text-to-Speech">Text-to-Speech</div>
                <div class="text-xs text-neutral-400" data-original="Off" id="tts-status">Off</div>
              </div>
            </button>
          </div>
        </div>
      </div>
    </aside>

    <main role="main" aria-label="Menu and order area" class="flex-1 flex flex-col bg-white text-black h-screen">
      <header class="flex items-center justify-between px-10 py-6 border-b border-neutral-200 flex-shrink-0">
        <div>
          <h1 id="category-title" class="text-3xl font-semibold tracking-tight" data-original="Entrees">Entrees</h1>
          <p class="mt-1 text-sm text-neutral-700" data-original="Choose your main dish to start your order.">
            Choose your main dish to start your order.
          </p>
        </div>

        <div class="flex items-center gap-4">
          <button id="call-staff-btn"
            class="px-5 py-3 bg-red-600 hover:bg-red-700 active:bg-red-800
                  text-white font-bold text-base rounded-lg
                  shadow-lg transform transition-all duration-200
                  active:scale-95 flex items-center gap-2">
            <span class="text-xl">üÜò</span>
            <span data-original="Call Staff for Help">Call Staff for Help</span>
          </button>
          
          <div id="weather-widget" class="flex items-center gap-3 bg-neutral-100 px-4 py-2 rounded-lg hidden">
            <img id="weather-icon" src="" alt="Weather" class="w-10 h-10 object-contain">
            <div class="text-right">
              <div id="weather-temp" class="text-xl font-bold text-neutral-800">--¬∞</div>
              <div id="weather-desc" class="text-xs text-neutral-700 uppercase tracking-wider">Loading</div>
            </div>
          </div>
        </div>
      </header>

      <section class="flex-1 overflow-y-auto px-10 py-8 bg-neutral-50">
        <div id="entrees" class="category-section"><div class="grid gap-6 grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"></div></div>
        <div id="a_la_carte" class="category-section hidden"><div class="grid gap-6 grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"></div></div>
        <div id="sides" class="category-section hidden"><div class="grid gap-6 grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"></div></div>
        <div id="appetizers" class="category-section hidden"><div class="grid gap-6 grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"></div></div>
        <div id="drinks" class="category-section hidden"><div class="grid gap-6 grid-cols-2 lg:grid-cols-3 xl:grid-cols-4"></div></div>
      </section>

      <div class="border-t border-neutral-300 bg-white shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] flex-shrink-0">
        <div class="px-10 py-5 flex items-center justify-between">
          <div class="text-xs uppercase tracking-[0.25em] text-neutral-700 font-medium" data-original="Order Summary">Order Summary</div>
          <div class="flex items-center gap-6">
            <div class="flex items-baseline gap-4 text-sm">
              <span class="text-neutral-700 text-xs">
                <span data-original="Items:">Items:</span> <span id="cart-count" class="font-semibold text-black">0</span>
              </span>
              <span class="font-bold text-red-700 text-xl">
                $<span id="cart-total">0.00</span>
              </span>
            </div>
            <button id="cart-open-drawer" 
                    class="px-8 py-2.5 text-xs font-semibold uppercase tracking-[0.22em] bg-red-700 text-white border-2 border-red-700 hover:bg-red-800 hover:border-red-800 transition-all"
                    data-original="View Cart">
              View Cart
            </button>
          </div>
        </div>
      </div>
    </main>

  <div id="cart-drawer-backdrop" class="fixed inset-0 bg-black/30 z-30 hidden"></div>

  <aside id="cart-drawer" 
    class="fixed top-0 right-0 h-screen w-[570px] max-w-full bg-white text-black shadow-2xl border-l border-neutral-200 z-40 
          transform translate-x-full transition-transform duration-400 ease-out 
          flex flex-col">
    
    <div class="flex items-center justify-between px-6 py-5 border-b border-neutral-200">
      <div class="text-lg font-bold tracking-wider uppercase text-neutral-800" data-original="Your Cart">Your Cart</div>
      <button id="cart-drawer-close" class="text-sm uppercase tracking-wider text-neutral-700 hover:text-black font-medium border-2 border-neutral-300 hover:border-red-600 px-4 py-2 rounded-lg transition" data-original="Close">Close</button>
    </div>

    <div id="cart-drawer-items" class="flex-1 overflow-y-auto p-5 space-y-3 text-sm">
      <div class="text-neutral-700 italic" data-original="No items yet">No items yet</div>
    </div>

    <div class="p-5 border-t border-neutral-200">
      <div class="mb-3 space-y-1">
        <div class="flex items-center justify-between text-sm">
          <span data-original="Subtotal:">Subtotal:</span>
          <span id="cart-subtotal">$0.00</span>
        </div>
        <div class="flex items-center justify-between text-sm">
          <span data-original="Tax:">Tax:</span>
          <span id="cart-tax">$0.00</span>
        </div>
        <div class="flex items-center justify-between text-lg font-bold border-t pt-2">
          <span data-original="Total:">Total:</span>
          <span id="cart-drawer-total">$0.00</span>
        </div>
      </div>
      
      <div class="flex gap-2">
        <button id="cart-clear" class="flex-1 px-4 py-2 text-xs font-medium uppercase tracking-[0.18em] border border-neutral-400 bg-white text-black hover:bg-neutral-100" data-original="Clear Cart">Clear Cart</button>
        <button id="cart-go-checkout" class="flex-1 px-4 py-2 text-xs font-semibold uppercase tracking-[0.2em] bg-red-700 text-white border border-red-700 hover:bg-red-800" data-original="Checkout">Checkout</button>
      </div>
    </div>
  </aside>

    <!-- Item Info Modal -->
    <div id="item-info-modal" class="fixed inset-0 hidden items-center justify-center bg-black/60 z-50 backdrop-blur-sm">
      <div class="bg-white text-black w-full max-w-lg rounded-2xl overflow-hidden shadow-2xl">
        <div class="bg-gradient-to-r from-red-700 to-red-600 px-6 py-5 flex items-center justify-between">
          <h3 class="text-2xl font-bold text-white" id="info-item-name"></h3>
          <button id="info-modal-close" aria-label="Close" class="text-white hover:text-red-100 text-2xl font-bold"><span aria-hidden="true">&times;</span></button>
        </div>
        <div class="p-6 space-y-4">
          <div class="bg-gradient-to-br from-red-50 to-red-100/50 rounded-xl p-5">
            <div class="flex items-start gap-3">
              <div class="w-10 h-10 rounded-full bg-red-600 flex items-center justify-center flex-shrink-0">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
              </div>
              <div class="flex-1">
                <h5 class="font-semibold text-red-900 mb-2 text-lg" data-original="Allergen Information">Allergen Information</h5>
                <p id="info-allergens" class="text-base text-red-800 leading-relaxed"></p>
              </div>
            </div>
          </div>
          
          <div class="bg-neutral-50 rounded-xl p-5">
            <h5 class="font-semibold text-neutral-900 mb-4 text-lg flex items-center gap-2">
              <svg class="w-5 h-5 text-red-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
              </svg>
              <span data-original="Nutrition Facts">Nutrition Facts</span>
            </h5>
            <div class="grid grid-cols-2 gap-4">
              <div class="bg-white rounded-lg p-3 border border-neutral-200">
                <div class="text-xs text-neutral-500 uppercase tracking-wide mb-1" data-original="Calories">Calories</div>
                <div id="info-calories" class="text-2xl font-bold text-neutral-900">--</div>
              </div>
              <div class="bg-white rounded-lg p-3 border border-neutral-200">
                <div class="text-xs text-neutral-500 uppercase tracking-wide mb-1" data-original="Protein">Protein</div>
                <div id="info-protein" class="text-2xl font-bold text-neutral-900">--</div>
              </div>
              <div class="bg-white rounded-lg p-3 border border-neutral-200">
                <div class="text-xs text-neutral-500 uppercase tracking-wide mb-1" data-original="Fat">Fat</div>
                <div id="info-fat" class="text-2xl font-bold text-neutral-900">--</div>
              </div>
              <div class="bg-white rounded-lg p-3 border border-neutral-200">
                <div class="text-xs text-neutral-500 uppercase tracking-wide mb-1" data-original="Carbs">Carbs</div>
                <div id="info-carbs" class="text-2xl font-bold text-neutral-900">--</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="meal-modal" class="fixed inset-0 hidden items-center justify-center bg-black/60 z-50">
       <div class="bg-white text-black w-full max-w-3xl border border-neutral-200 rounded-lg overflow-hidden shadow-xl flex flex-col">
          <div class="px-6 py-4 border-b border-neutral-200 flex items-center justify-between">
             <div>
                <div class="text-lg font-semibold" id="meal-modal-title" data-original="Build Your Meal">Build Your Meal</div>
                <div class="text-sm text-neutral-700"><span data-original="Price:">Price:</span> $<span id="meal-modal-price">0.00</span></div>
             </div>
             <button id="meal-modal-close" class="text-sm text-neutral-700 hover:text-black" data-original="Close">Close</button>
          </div>
          <div class="px-6 py-5 grid grid-cols-1 lg:grid-cols-2 gap-6 overflow-y-auto max-h-[70vh]">
             <section>
                <div class="text-sm uppercase tracking-[0.18em] text-neutral-700 font-semibold mb-3" data-original="Side (total 1)">Side (total 1)</div>
                <div class="text-xs text-neutral-700 mb-2" id="meal-side-hint" data-original="Select one full side.">Select one full side.</div>
                <div id="meal-sides" class="grid grid-cols-2 gap-2"></div>
                <div class="mt-2 text-xs text-neutral-700"><span data-original="Selected:">Selected:</span> <span id="meal-side-count">0</span>/1</div>
             </section>
             <section>
                <div class="text-sm uppercase tracking-[0.18em] text-neutral-700 font-semibold mb-3" data-original="Entrees">Entrees</div>
                <div class="text-xs text-neutral-700 mb-2"><span data-original="Choose up to">Choose up to</span> <span id="meal-entree-max">1</span></div>
                <div id="meal-entrees" class="space-y-2 overflow-y-auto"></div>
                <div class="mt-2 text-xs text-neutral-700"><span data-original="Selected:">Selected:</span> <span id="meal-entree-count">0</span>/<span id="meal-entree-max-2">1</span></div>
             </section>
          </div>
          <div class="px-6 py-4 border-t border-neutral-200 flex items-center justify-end gap-3 bg-neutral-50">
             <button id="meal-modal-cancel" class="px-4 py-2 text-sm border border-neutral-300 bg-white hover:bg-neutral-100" data-original="Cancel">Cancel</button>
             <button id="meal-add" class="px-5 py-2 text-sm font-semibold bg-red-700 text-white border border-red-700 hover:bg-red-800 disabled:opacity-40 disabled:cursor-not-allowed" disabled data-original="Add to Cart">Add to Cart</button>
          </div>
       </div>
    </div>

    <div id="item-modal" class="fixed inset-0 hidden items-center justify-center bg-black/60 z-50">
      <div class="bg-white text-black w-full max-w-md border border-neutral-200 rounded-lg overflow-hidden shadow-xl">
        <div class="px-6 py-4 border-b border-neutral-200 flex items-center justify-between">
          <div class="text-lg font-semibold" id="item-modal-title">Item</div>
          <button id="item-modal-close" class="text-neutral-500 hover:text-neutral-700 border-2 border-neutral-300 rounded-full w-8 h-8 flex items-center justify-center hover:border-red-600" data-original="Close">‚úï</button>
        </div>
        <div class="px-6 py-5 space-y-4">
          <div class="text-5xl font-bold text-neutral-700 mb-4"><span data-original="Price:">Price:</span> $<span id="item-modal-price">0.00</span></div>
          <div class="text-sm">
            <span class="text-neutral-700" data-original="Allergens:">Allergens:</span>
            <span id="item-modal-allergens" class="font-medium text-red-700">None</span>
          </div>
          <div id="size-selection" class="hidden">
            <div class="text-sm text-neutral-700 mb-2" data-original="Size">Size</div>
            <div class="grid grid-cols-3 gap-2">
              <button class="size-btn px-4 py-3 border-2 border-neutral-300 rounded-lg font-semibold hover:border-red-600 transition" data-size="small" data-multiplier="1" data-original="Small">Small</button>
              <button class="size-btn px-4 py-3 border-2 border-neutral-300 rounded-lg font-semibold hover:border-red-600 transition" data-size="medium" data-multiplier="2" data-original="Medium">Medium</button>
              <button class="size-btn px-4 py-3 border-2 border-neutral-300 rounded-lg font-semibold hover:border-red-600 transition" data-size="large" data-multiplier="3" data-original="Large">Large</button>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <span class="text-sm text-neutral-700" data-original="Quantity">Quantity</span>
            <div class="flex items-center gap-2">
              <button id="item-qty-minus" class="px-3 py-2 border border-neutral-300">-</button>
              <div id="item-qty" class="min-w-[2.5rem] text-center font-semibold">1</div>
              <button id="item-qty-plus" class="px-3 py-2 border border-neutral-300">+</button>
            </div>
          </div>
        </div>
        <div class="px-6 py-4 border-t border-neutral-200 flex items-center justify-end gap-3 bg-neutral-50">
          <button id="item-modal-cancel" class="px-4 py-2 text-sm border border-neutral-300 bg-white hover:bg-neutral-100" data-original="Cancel">Cancel</button>
          <button id="item-add" class="px-5 py-2 text-sm font-semibold bg-red-700 text-white border border-red-700 hover:bg-red-800" data-original="Add to Cart">Add to Cart</button>
        </div>
      </div>
    </div>

    <div id="dine-option-modal" class="fixed inset-0 hidden items-center justify-center bg-black/70 z-50">
      <div class="bg-white text-black w-full max-w-md border border-neutral-200 rounded-lg overflow-hidden shadow-xl">
        <div class="px-6 py-4 border-b border-neutral-200 bg-red-700 text-white">
          <div class="text-lg font-semibold" data-original="Dine In or Takeout?">Dine In or Takeout?</div>
          <div class="text-sm mt-1" data-original="Please select your dining preference">Please select your dining preference</div>
        </div>
        <div class="px-6 py-6 grid grid-cols-2 gap-4">
          <button data-dine-option="dine_in" class="dine-option-btn flex flex-col items-center justify-center p-8 border-2 border-neutral-300 rounded-lg hover:border-red-600 hover:bg-red-50 transition-all">
            <svg class="w-16 h-16 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
            <span class="font-semibold text-lg" data-original="Dine In">Dine In</span>
          </button>
          <button data-dine-option="takeout" class="dine-option-btn flex flex-col items-center justify-center p-8 border-2 border-neutral-300 rounded-lg hover:border-red-600 hover:bg-red-50 transition-all">
            <svg class="w-16 h-16 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>
            <span class="font-semibold text-lg" data-original="Takeout">Takeout</span>
          </button>
        </div>
        <div class="px-6 py-4 border-t border-neutral-200 flex justify-end">
          <button id="dine-option-cancel" class="px-4 py-2 text-sm border border-neutral-300 bg-white hover:bg-neutral-100 rounded" data-original="Cancel">Cancel</button>
        </div>
      </div>
    </div>

    <div id="payment-modal" class="fixed inset-0 hidden items-center justify-center bg-black/70 z-50">
      <div class="bg-white text-black w-full max-w-md border border-neutral-200 rounded-lg overflow-hidden shadow-xl">
        <div class="px-6 py-4 border-b border-neutral-200 bg-red-700 text-white">
          <div class="text-lg font-semibold" data-original="Select Payment Method">Select Payment Method</div>
          <div class="text-sm mt-1"><span data-original="Total:">Total:</span> $<span id="payment-total">0.00</span></div>
        </div>
        <div class="px-6 py-6 grid grid-cols-2 gap-3">
          <button data-method="card" class="payment-method-btn flex flex-col items-center justify-center p-6 border-2 border-neutral-300 rounded-lg hover:border-red-600 hover:bg-red-50 transition-all">
            <svg class="w-12 h-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
            <span class="font-semibold" data-original="Card">Card</span>
          </button>
          <button data-method="cash" class="payment-method-btn flex flex-col items-center justify-center p-6 border-2 border-neutral-300 rounded-lg hover:border-red-600 hover:bg-red-50 transition-all">
            <svg class="w-12 h-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
            <span class="font-semibold" data-original="Cash">Cash</span>
          </button>
          <button data-method="giftcard" class="payment-method-btn flex flex-col items-center justify-center p-6 border-2 border-neutral-300 rounded-lg hover:border-red-600 hover:bg-red-50 transition-all">
            <svg class="w-12 h-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"></path></svg>
            <span class="font-semibold" data-original="Gift Card">Gift Card</span>
          </button>
          <button data-method="dining_dollars" class="payment-method-btn flex flex-col items-center justify-center p-6 border-2 border-neutral-300 rounded-lg hover:border-red-600 hover:bg-red-50 transition-all">
            <svg class="w-12 h-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <span class="font-semibold text-sm" data-original="Dining Dollars">Dining Dollars</span>
          </button>
          <button data-method="meal_swipe" class="payment-method-btn col-span-2 flex flex-col items-center justify-center p-6 border-2 border-neutral-300 rounded-lg hover:border-red-600 hover:bg-red-50 transition-all">
            <svg class="w-12 h-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0a2 2 0 104 0m-5 8a2 2 0 100-4 2 2 0 000 4zm0 0c1.306 0 2.417.835 2.83 2M9 14a3.001 3.001 0 00-2.83 2M15 11h3m-3 4h2"></path></svg>
            <span class="font-semibold" data-original="Meal Swipe">Meal Swipe</span>
          </button>
        </div>
        <div class="px-6 py-4 border-t border-neutral-200 flex justify-end">
          <button id="payment-cancel" class="px-4 py-2 text-sm border border-neutral-300 bg-white hover:bg-neutral-100 rounded" data-original="Cancel">Cancel</button>
        </div>
      </div>
    </div>
    <div id="clear-cart-modal" class="fixed inset-0 hidden items-center justify-center bg-black/70 z-50">
      <div class="bg-white text-black w-full max-w-md border border-neutral-200 rounded-lg overflow-hidden shadow-xl">
        <div class="px-6 py-4 border-b border-neutral-200 bg-red-700 text-white">
          <div class="text-xl font-semibold">Clear Cart?</div>
          <div class="text-sm mt-1">Are you sure you want to remove all items?</div>
        </div>

        <div class="px-6 py-6 flex flex-col gap-4">
          <button id="confirm-clear-cart"
            class="w-full px-6 py-3 bg-red-700 text-white font-semibold text-lg rounded hover:bg-red-800 transition">
            Yes, Clear Cart
          </button>

          <button id="cancel-clear-cart"
            class="w-full px-6 py-3 bg-neutral-300 text-black font-semibold text-lg rounded hover:bg-neutral-200 transition">
            Cancel
          </button>
        </div>
      </div>
    </div>
    <div id="order-success-modal" class="fixed inset-0 hidden items-center justify-center bg-black/70 z-50">
      <div class="bg-white text-black w-full max-w-lg border border-neutral-200 rounded-lg overflow-hidden shadow-2xl">
        <div class="px-8 py-10 text-center">
          <div class="mx-auto w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mb-6">
            <svg class="w-16 h-16 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
          </div>
          <h2 class="text-3xl font-bold text-neutral-900 mb-3" data-original="Order Placed!">Order Placed!</h2>
          <p class="text-lg text-neutral-700 mb-6" data-original="Your order has been sent to the kitchen.">Your order has been sent to the kitchen.</p>
          <div class="bg-neutral-50 rounded-lg px-6 py-5 mb-8 text-left">
            <div class="flex justify-between text-sm mb-2">
              <span class="text-neutral-700" data-original="Order Number">Order Number</span>
              <span class="font-bold text-xl" id="success-order-number">#0000</span>
            </div>
            <div class="flex justify-between text-sm mb-2">
              <span class="text-neutral-700" data-original="Total Paid">Total Paid</span>
              <span class="font-bold text-xl" id="success-total">$0.00</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-neutral-700" data-original="Dine Option">Dine Option</span>
              <span class="font-medium capitalize" id="success-dine-option">‚Äî</span>
            </div>
          </div>
          <p class="text-sm text-neutral-700 mb-8" data-original="Please wait at the counter or take a seat. We'll call your number when it's ready!">
            Please wait at the counter or take a seat.<br>We'll call your number when it's ready!
          </p>
          <button id="success-done-btn" class="px-10 py-4 text-lg font-semibold uppercase tracking-wider bg-red-700 text-white rounded-lg hover:bg-red-800 transition-all" data-original="Done">Done</button>
        </div>
      </div>
    </div>

    <!-- Are You Still There Modal -->
    <div id="still-there-modal" class="fixed inset-0 hidden items-center justify-center bg-black/70 z-[90] backdrop-blur-sm">
      <div class="bg-white text-black w-full max-w-xl rounded-2xl overflow-hidden shadow-2xl">
        <div class="bg-gradient-to-r from-red-700 to-red-600 px-8 py-6">
          <h2 class="text-3xl font-bold text-white text-center" data-original="Are You Still There?">Are You Still There?</h2>
        </div>
        <div class="px-10 py-10">
          <div class="flex items-center justify-center mb-8 p-4">
            <div class="relative w-40 h-40">
              <div class="absolute inset-2 rounded-full bg-red-50 flex items-center justify-center">
                <div id="still-there-countdown" class="text-6xl font-bold text-red-700">10</div>
              </div>
              <svg class="absolute inset-0 w-40 h-40 -rotate-90" viewBox="0 0 160 160">
                <circle cx="80" cy="80" r="72" stroke="#fecaca" stroke-width="8" fill="none"/>
                <circle id="countdown-circle" cx="80" cy="80" r="72" stroke="#dc2626" stroke-width="8" fill="none" stroke-dasharray="452" stroke-dashoffset="0" class="transition-all duration-1000 ease-linear"/>
              </svg>
            </div>
          </div>
          <p class="text-xl text-center text-neutral-600 mb-8" data-original="Your session will timeout soon. Tap continue to keep ordering.">Your session will timeout soon. Tap continue to keep ordering.</p>
          <button id="still-there-continue" class="w-full px-8 py-4 text-xl font-semibold bg-red-700 text-white rounded-lg hover:bg-red-800 transition-all shadow-md" data-original="Continue Ordering">Continue Ordering</button>
        </div>
      </div>
    </div>

    <style>
      .nav-link {
        display: block;
        padding: 2rem 1.5rem;
        border-left: 4px solid transparent;
        background: #000;
        color: #d4d4d4;
        font-weight: 600;
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.2s;
      }
      .nav-link:hover {
        background: #1f1f1f;
        color: #ffffff;
      }
      .nav-link.active {
        background: #b91c1c;
        border-left-color: #ef4444;
        color: #ffffff;
      }

      .item-card {
        display: flex;
        flex-direction: column;
        background: white;
        border: 2px solid #e5e5e5;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        transition: all 0.2s ease;
        text-align: left;
        overflow: hidden;
        cursor: pointer;
      }

      .item-card:hover {
        border-color: #dc2626;
        box-shadow: 0 4px 12px rgba(220, 38, 38, 0.15);
        transform: translateY(-2px);
      }

      .item-card:active {
        transform: translateY(0) scale(0.98);
      }

      .item-card .item-image {
        aspect-ratio: 1;
        background: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 0.5rem;
        overflow: hidden;
      }

      .item-card .item-img {
        width: 100%;
        height: 100%;
        max-width: 540px;
        max-height: 810px;
        object-fit: contain;
        border-radius: 8px;
        display: block;
        margin: 0 auto;
      }

      .item-card .item-placeholder {
        width: 100%;
        height: 100%;
        max-width: 160px;
        max-height: 160px;
        background: linear-gradient(135deg, #e5e5e5 0%, #d4d4d4 100%);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #737373;
        font-size: 0.75rem;
        font-weight: 500;
        text-align: center;
        padding: 1rem;
      }

      /* Cart drawer scrollbar */
      #cart-drawer-items::-webkit-scrollbar {
        width: 4px;
      }
      #cart-drawer-items::-webkit-scrollbar-track {
        background: #171717;
      }
      #cart-drawer-items::-webkit-scrollbar-thumb {
        background: #404040;
        border-radius: 2px;
      }
      #cart-drawer-items::-webkit-scrollbar-thumb:hover {
        background: #525252;
      }
    </style>

    <script>
      // ==================================================================
      // BLOCKING POPUP: More than 10 of one item ‚Üí ONLY Cancel or Call Staff
      // ==================================================================
      function showTooManyItemsWarning(itemName, attemptedQty) {
        return new Promise((resolve) => {
          const overlay = document.createElement('div');
          overlay.className = 'fixed inset-0 bg-black/90 flex items-center justify-center z-[60]';

          overlay.innerHTML = `
            <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-6 p-10 text-center">
              <h2 class="text-5xl font-black text-red-700 mb-8">Too Many Items</h2>
              
              <p class="text-3xl leading-relaxed mb-10 text-neutral-800">
                You are trying to order <strong>${attemptedQty}</strong> √ó <br><em>${itemName}</em>
              </p>

              <p class="text-2xl text-neutral-700 mb-12">
                For orders this large, please speak with a staff member.
              </p>

              <div class="flex flex-col gap-6 max-w-md mx-auto">
                <button id="too-many-cancel"
                        class="px-10 py-6 bg-neutral-200 text-black font-bold text-2xl rounded-xl hover:bg-neutral-300 transition">
                  Cancel
                </button>

                <button id="too-many-call-staff"
                        class="px-10 py-6 bg-red-600 hover:bg-red-700 active:bg-red-800
                              text-white font-bold text-3xl rounded-xl shadow-2xl transition-all">
                  Call Staff for Help
                </button>
              </div>
            </div>
          `;

          document.body.appendChild(overlay);

          overlay.querySelector('#too-many-cancel').onclick = () => {
            document.body.removeChild(overlay);
            resolve(false); // blocked
          };

          const staffBtn = overlay.querySelector('#too-many-call-staff');
          staffBtn.onclick = async () => {
            staffBtn.disabled = true;
            staffBtn.textContent = 'Help Requested‚Ä¶';

            try {
              await fetch('/api/call-staff', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
              });
            } catch (e) {
              console.error('Call staff failed', e);
            }

            setTimeout(() => {
              staffBtn.disabled = false;
              staffBtn.textContent = 'Call Staff for Help';
            }, 15000);
          };

          overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
              document.body.removeChild(overlay);
              resolve(false);
            }
          });
        });
      }

      // ==================================================================
      // ORIGINAL addToCart (save before override)
      // ==================================================================
      const originalAddToCart = function(name, price, qty = 1) {
        const existing = cart.find(i => i.name === name);
        if (existing) {
          existing.quantity += qty;
        } else {
          cart.push({ name, price: parseFloat(price), quantity: qty });
        }
        renderCartDrawer();
        saveCart(cart);
        openCartDrawer();
      };

      // ==================================================================
      // NEW addToCart ‚Äî BLOCK >10 of one item
      // ==================================================================
      async function addToCart(name, price, qty = 1) {
        const existing = cart.find(i => i.name === name);
        const newQty = (existing ? existing.quantity : 0) + qty;

        if (newQty > 10) {
          await showTooManyItemsWarning(name, newQty);
          return; // BLOCKED ‚Äî user cannot proceed
        }

        // Safe to add
        originalAddToCart(name, price, qty);
      }
      
      // Add cart item with size information
      async function addToCartWithSize(itemData) {
        const existing = cart.find(i => i.name === itemData.name);
        const newQty = (existing ? existing.quantity : 0) + itemData.quantity;

        if (newQty > 10) {
          await showTooManyItemsWarning(itemData.name, newQty);
          return;
        }

        if (existing) {
          existing.quantity += itemData.quantity;
        } else {
          cart.push({
            name: itemData.name,
            baseName: itemData.baseName,
            price: itemData.price,
            quantity: itemData.quantity,
            size: itemData.size,
            multiplier: itemData.multiplier
          });
        }
        renderCartDrawer();
        saveCart(cart);
        openCartDrawer();
      }
      // Populate menu items from server data
      function populateMenu() {
        const categories = ['entrees', 'a_la_carte', 'sides', 'appetizers', "drinks"];
        
        // Map item names to image filenames
        const imageMap = {
          'Bowl': 'bowl.jpg',
          'Plate': 'plate.jpg',
          'Bigger Plate': 'bigger-plate.jpg',
          'Beijing Beef': 'beijing-beef.jpg',
          'Black Pepper Chicken': 'black-pepper-chicken.jpg',
          'Black Pepper Sirloin Steak': 'black-pepper-sirloin-steak.jpg',
          'Broccoli Beef': 'broccoli-beef.jpg',
          'Grilled Teriyaki Chicken': 'grilled-teriyaki-chicken.jpg',
          'Honey Sesame Chicken Breast': 'honey-sesame-chicken-breast.jpg',
          'Honey Walnut Shrimp': 'honey-walnut-shrimp.jpg',
          'Kung Pao Chicken': 'kung-pao-chicken.jpg',
          'Mushroom Chicken': 'mushroom-chicken.jpg',
          'String Bean Chicken Breast': 'string-bean-chicken-breast.jpg',
          'The Original Orange Chicken': 'the-original-orange-chicken.jpg',
          'Fried Rice': 'fried-rice.jpg',
          'Chow Mein': 'chow-mein.jpg',
          'White Steamed Rice': 'white-steamed-rice.jpg',
          'Super Greens': 'super-greens.jpg',
          'Super Greens (Entree)': 'super-greens-(entree).jpg',
          'Super Greens (entree)': 'super-greens-(entree).jpg',
          'Chicken Egg Roll': 'chicken-egg-roll.jpg',
          'Veggie Spring Roll': 'veggie-spring-roll.jpg',
          'Cream Cheese Rangoon': 'cream-cheese-rangoon.jpg',
          'Fountain Drink': 'afcd896b29a94935ae1ecdc641b5bcdf.png'
        };
        
        categories.forEach(category => {
          const container = document.querySelector(`#${category} .grid`);
          if (!container) return;
          
          container.innerHTML = '';
          
          const items = menuData[category] || [];
          
          items.forEach(item => {
            const card = document.createElement('button');
            card.className = 'item-card relative';
            card.dataset.name = item.name;
            card.dataset.price = item.price.toFixed(2);
            const allergensList = item.allergens || [];
            card.dataset.allergens = allergensList.join(', ');
            card.dataset.category = category;
            
            // Store nutrition data
            if (item.nutrition) {
              card.dataset.nutrition = JSON.stringify(item.nutrition);
            }
            
            // Store size pricing data
            if (item.sizePricing) {
              card.dataset.sizePricing = JSON.stringify(item.sizePricing);
            }
            
            const imageSrc = imageMap[item.name] ? `/images/${imageMap[item.name]}` : '/images/placeholder.jpg';
            const isMeal = ['Bowl', 'Plate', 'Bigger Plate'].includes(item.name);
            const priceDisplay = isMeal ? `$${item.price.toFixed(2)}+` : `$${item.price.toFixed(2)}`;
            
            // Check if item is premium
            const isPremiumItem = item.name.toLowerCase().includes('honey walnut') || 
                                  item.name.toLowerCase().includes('black pepper sirloin');
            
            // Meal descriptions and calorie ranges
            let mealDescription = '';
            let calorieRange = '';
            if (item.name === 'Bowl') {
              mealDescription = '1 Side & 1 Entree';
              calorieRange = '400-900 cal';
            } else if (item.name === 'Plate') {
              mealDescription = '1 Side & 2 Entrees';
              calorieRange = '600-1400 cal';
            } else if (item.name === 'Bigger Plate') {
              mealDescription = '1 Side & 3 Entrees';
              calorieRange = '800-1900 cal';
            }
            
            // Only show info badge for non-meal items
            const nutritionData = item.nutrition ? JSON.stringify(item.nutrition) : '{}';
            const premiumBadge = isPremiumItem ? `<div class="absolute top-2 left-2 z-10"><span class="text-xs font-bold bg-yellow-500 text-black px-2 py-1 rounded shadow">PREMIUM</span></div>` : '';
            const infoBadge = isMeal ? '' : `<div class="absolute top-2 right-2 flex items-center gap-1 z-10"><span class="text-xs font-medium text-neutral-700 bg-white px-2 py-1 rounded shadow" data-original="More Info">More Info</span><button class="info-badge w-6 h-6 rounded-full bg-red-700 text-white text-xs font-bold flex items-center justify-center hover:bg-red-800 transition" aria-label="More info for ${item.name}" data-item-name="${item.name}" data-allergens="${allergensList.join(', ') || 'None'}" data-nutrition='${nutritionData}'>i</button></div>`;
            const mealInfo = isMeal ? `<div class="text-xs text-neutral-600 leading-tight">${mealDescription}</div><div class="text-xs text-neutral-500">${calorieRange}</div>` : '';
            card.innerHTML = `
              ${premiumBadge}
              ${infoBadge}
              <div class="item-image">
                <img src="${imageSrc}" alt="${item.name}" class="item-img" />
              </div>
              <div class="px-4 py-4 flex flex-col gap-2">
                <div class="text-sm font-semibold leading-snug" 
                     data-translate-type="item-name" 
                     data-original="${item.name}">${item.name}</div>
                <div class="text-base font-bold text-red-700">${priceDisplay}</div>
                ${mealInfo}
              </div>
            `;
            
            container.appendChild(card);
          });
        });
      }

      // Initialize menu on page load
      populateMenu();

      // Category titles and descriptions
      const categoryInfo = {
        entrees: {
          title: "Entrees",
          description: "Choose your main dish to start your order."
        },
        a_la_carte: {
          title: "A La Carte",
          description: "Individual entrees and sides."
        },
        sides: {
          title: "Sides",
          description: "Choose from fried rice, chow mein, or super greens."
        },
        appetizers: {
          title: "Appetizers",
          description: "Start your meal with delicious appetizers."
        },
        drinks: {
          title: "Drinks",
          description: "Order a refreshing beverage with your meal."
        }
      };

      // Navigation between categories
      document.querySelectorAll(".nav-link").forEach((link) => {
        link.addEventListener("click", function () {
          // Remove active class from all links and sections
          document.querySelectorAll(".nav-link").forEach((a) => a.classList.remove("active"));
          document.querySelectorAll(".category-section").forEach((sec) => {
            sec.classList.add("hidden");
          });
          
          // Add active class to clicked link
          this.classList.add("active");
          
          // Show the corresponding category section
          const cat = this.dataset.category;
          const section = document.getElementById(cat);
          if (section) {
            section.classList.remove("hidden");
          }
          
          // Update header with category info
          const info = categoryInfo[cat];
          if (info) {
            const titleEl = document.getElementById("category-title");
            const descEl = document.querySelector("header p");

            titleEl.textContent = info.title;
            descEl.textContent = info.description;

            titleEl.setAttribute('data-original', info.title);
            descEl.setAttribute('data-original', info.description);
          
            const currentLang = localStorage.getItem('kiosk_lang') || 'en';
            if (currentLang !== 'en') {
              setTimeout(() => changeLanguage(currentLang), 20);
            }
          }
        });
      });

      // Tax rate (fetch from server)
      let TAX_RATE = 0.0825; // Default 8.25%
      fetch('/api/tax-rate')
        .then(res => res.json())
        .then(data => {
          TAX_RATE = data.rate;
          renderCartDrawer(); // Update cart display with correct tax
        })
        .catch(err => console.error('Failed to fetch tax rate:', err));

      // Cart state (persist across pages)
      const CART_KEY = 'kiosk_cart';
      function loadCart() { try { return JSON.parse(localStorage.getItem(CART_KEY)) || []; } catch { return []; } }
      function saveCart(c) { localStorage.setItem(CART_KEY, JSON.stringify(c)); }
      let cart = loadCart();

      // Convert meal details (sides + entrees) into a flat list of options
      function extractOptionsForItem(item) {
        const opts = [];
        if (!item || !item.details) return opts;
        const { sides, entrees } = item.details;

        // Sides
        if (sides) {
          if (sides.type === 'full' && sides.name) {
            // one full side
            opts.push({ name: sides.name, qty: 1, kind: 'side' });
          } else if (Array.isArray(sides.items)) {
            // halves / doubles: count occurrences
            const counts = {};
            sides.items.forEach((n) => {
              if (!n) return;
              counts[n] = (counts[n] || 0) + 1;
            });
            Object.entries(counts).forEach(([name, qty]) => {
              opts.push({ name, qty, kind: 'side' });
            });
          }
        }

        // Entrees
        if (Array.isArray(entrees)) {
          entrees.forEach((e) => {
            if (!e || !e.name) return;
            const qty = e.count || 1;
            opts.push({ name: e.name, qty, kind: 'entree' });
          });
        }

        return opts;
      }

      function renderCartDrawer() {
        const count = cart.reduce((s, i) => s + i.quantity, 0);
        const subtotal = cart.reduce((s, i) => s + (i.price * i.quantity), 0);
        const tax = subtotal * TAX_RATE;
        const total = subtotal + tax;
        
        document.getElementById("cart-count").textContent = count;
        document.getElementById("cart-total").textContent = total.toFixed(2);
        
        const itemsEl = document.getElementById('cart-drawer-items');
        document.getElementById('cart-subtotal').textContent = '$' + subtotal.toFixed(2);
        document.getElementById('cart-tax').textContent = '$' + tax.toFixed(2);
        document.getElementById('cart-drawer-total').textContent = '$' + total.toFixed(2);

        if (cart.length === 0) {
          itemsEl.innerHTML = '<div class="text-neutral-700 italic" data-original="No items yet">No items yet</div>';
        } else {
          itemsEl.innerHTML = cart.map((item, idx) => {
            let childrenHtml = '';
            
            // Handle Meal Details (Sides/Entrees)
            if (item.type === 'meal' && item.details) {
              const maybeEdit = `<button data-idx="${idx}" class="edit-meal px-2 py-1 text-xs border border-neutral-300" data-original="Edit">Edit</button>`;
              
              // Render Sides
              if (item.details.sides) {
                if (item.details.sides.type === 'full') {
                  childrenHtml += `<div class="ml-4 pl-3 border-l-2 border-neutral-300 text-xs text-neutral-700"><span data-original="Side:">Side:</span> <span data-translate-type="item-name" data-original="${item.details.sides.name}">${item.details.sides.name}</span> (<span data-original="Full">Full</span>)</div>`;
                } else if (Array.isArray(item.details.sides.items)) {
                  const sideNames = item.details.sides.items.map(s => `<span data-translate-type="item-name" data-original="${s}">${s}</span>`).join(' + ');
                  childrenHtml += `<div class="ml-4 pl-3 border-l-2 border-neutral-300 text-xs text-neutral-700"><span data-original="Sides:">Sides:</span> ${sideNames} (<span data-original="Halves">Halves</span>)</div>`;
                }
              }
              
              // Render Entrees
              if (Array.isArray(item.details.entrees) && item.details.entrees.length) {
                const entreesLines = item.details.entrees.map(e => {
                  const countLabel = e.count > 1 ? ` x${e.count}` : '';
                  return `<div class="ml-4 pl-3 border-l-2 border-neutral-300 text-xs text-neutral-700"><span data-original="Entree:">Entree:</span> <span data-translate-type="item-name" data-original="${e.name}">${e.name}</span>${countLabel}</div>`;
                }).join('');
                childrenHtml += entreesLines;
              }

              return `
              <div class="border-b border-neutral-200 pb-3 last:border-b-0">
                <div class="flex items-start justify-between gap-3">
                  <div class="flex-1">
                    <div class="font-medium" data-translate-type="item-name" data-original="${item.name}">${item.name}</div>
                  </div>
                  <div class="flex items-center gap-2">
                    ${maybeEdit}
                    <button data-idx="${idx}" class="delete-item px-2 py-1 text-xs text-red-700 border border-red-300 hover:bg-red-50" data-original="Delete" aria-label="Delete ${item.name}">Delete</button>
                    <div class="w-16 text-right font-semibold">$${(item.price * item.quantity).toFixed(2)}</div>
                  </div>
                </div>
                ${childrenHtml}
              </div>`;
            } else {
              // Simple item
              return `
              <div class="flex items-start justify-between gap-3 border-b border-neutral-200 pb-3 last:border-b-0">
                <div class="flex-1">
                  <div class="font-medium" data-translate-type="item-name" data-original="${item.name}">${item.name}</div>
                  <div class="text-xs text-neutral-700 mt-1"><span data-original="Qty:">Qty:</span> <span class="inline-block max-w-[3rem] truncate align-bottom">${item.quantity}</span></div>
                </div>
                <div class="flex items-center gap-2">
                  <button data-idx="${idx}" class="qty-minus px-2 py-1 text-xs border border-neutral-300">-</button>
                  <button data-idx="${idx}" class="qty-plus px-2 py-1 text-xs border border-neutral-300">+</button>
                  <button data-idx="${idx}" class="delete-item px-2 py-1 text-xs text-red-700 border border-red-300 hover:bg-red-50" data-original="Delete" aria-label="Delete ${item.name}">Delete</button>
                  <div class="w-16 text-right font-semibold">$${(item.price * item.quantity).toFixed(2)}</div>
                </div>
              </div>`;
            }
          }).join('');
        }
        // persist cart
        saveCart(cart);
      }

      function openCartDrawer() {
        document.getElementById('cart-drawer').classList.remove('translate-x-full');
        document.getElementById('cart-drawer-backdrop').classList.remove('hidden');
      }

      function closeCartDrawer() {
        document.getElementById('cart-drawer').classList.add('translate-x-full');
        document.getElementById('cart-drawer-backdrop').classList.add('hidden');
      }

      // Info modal functions
      const infoModal = document.getElementById('item-info-modal');
      const infoModalItemName = document.getElementById('info-item-name');
      const infoModalAllergens = document.getElementById('info-allergens');
      const infoModalCalories = document.getElementById('info-calories');
      const infoModalProtein = document.getElementById('info-protein');
      const infoModalFat = document.getElementById('info-fat');
      const infoModalCarbs = document.getElementById('info-carbs');
      const infoModalClose = document.getElementById('info-modal-close');

      function openInfoModal(itemName, allergens, nutrition = null) {
        infoModalItemName.textContent = itemName;
        infoModalAllergens.textContent = allergens || 'None';

        // Display nutrition data if available
        if (nutrition && typeof nutrition === 'object') {
          infoModalCalories.textContent = nutrition.calories || '--';
          infoModalProtein.textContent = nutrition.protein ? `${nutrition.protein}g` : '--';
          infoModalFat.textContent = nutrition.fat ? `${nutrition.fat}g` : '--';
          infoModalCarbs.textContent = nutrition.carbs ? `${nutrition.carbs}g` : '--';
        } else {
          infoModalCalories.textContent = '--';
          infoModalProtein.textContent = '--';
          infoModalFat.textContent = '--';
          infoModalCarbs.textContent = '--';
        }
        
        infoModal.classList.remove('hidden');
        infoModal.classList.add('flex');

        const lang = localStorage.getItem('kiosk_lang') || 'en';
        const vocab = ttsLexicon[lang] || ttsLexicon['en'];

        const speakDetails = (nameToSpeak, finalAllergens) => {
            if (!ttsEnabled) return;
            
            let text = `${vocab.info} ${nameToSpeak}. `;
            
            if (finalAllergens && finalAllergens !== 'None' && finalAllergens.trim() !== '') {
                text += `${vocab.allergens}: ${finalAllergens}. `;
            } else {
                text += `${vocab.none}. `;
            }
            
            if (nutrition && typeof nutrition === 'object') {
                text += `${vocab.nutrition}: `;
                if (nutrition.calories) text += `${nutrition.calories} ${vocab.cal}, `;
                if (nutrition.protein) text += `${nutrition.protein} ${vocab.pro}, `;
                if (nutrition.fat) text += `${nutrition.fat} ${vocab.fat}, `;
                if (nutrition.carbs) text += `${nutrition.carbs} ${vocab.carb}.`;
            }
            speak(text);
        };

        if (lang === 'en') {
            speakDetails(itemName, allergens);
            return;
        }

        const textsToTranslate = [itemName];
        if (allergens && allergens !== 'None') {
            textsToTranslate.push(allergens);
        }

        fetch('/api/translate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ text: textsToTranslate, target: lang })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success && Array.isArray(data.translatedText) && data.translatedText.length > 0) {
                const translatedTitle = data.translatedText[0];
                infoModalItemName.textContent = translatedTitle;

                let translatedAllergens = null;
                if (textsToTranslate.length > 1) {
                     translatedAllergens = data.translatedText[1];
                     infoModalAllergens.textContent = translatedAllergens;
                }

                speakDetails(translatedTitle, translatedAllergens || allergens);
            } else {
                speakDetails(itemName, allergens);
            }
        })
        .catch(e => {
            console.error(e);
            speakDetails(itemName, allergens);
        });
      }

      

      function closeInfoModal() {
        infoModal.classList.add('hidden');
        infoModal.classList.remove('flex');
      }

      infoModalClose.addEventListener('click', closeInfoModal);
      infoModal.addEventListener('click', (e) => {
        if (e.target === infoModal) closeInfoModal();
      });

      // Add click handlers to all item cards
      document.addEventListener('click', (e) => {
        // Check if info badge was clicked
        const infoBadge = e.target.closest('.info-badge');
        if (infoBadge) {
          e.stopPropagation();
          const itemName = infoBadge.getAttribute('data-item-name');
          const allergens = infoBadge.getAttribute('data-allergens');
          const nutritionStr = infoBadge.getAttribute('data-nutrition');
          let nutrition = null;
          try {
            nutrition = nutritionStr ? JSON.parse(nutritionStr) : null;
          } catch (e) {
            console.error('Failed to parse nutrition data:', e);
          }

          if (ttsEnabled) {
          let speakText = `Information for ${itemName}. `;
          
          // Add Allergens
          if (allergens && allergens !== 'None' && allergens.trim() !== '') {
            speakText += `Allergens: ${allergens}. `;
          } else {
            speakText += `No allergens listed. `;
          }

          // Add Nutrition
          if (nutrition) {
            speakText += `Nutrition facts: `;
            if (nutrition.calories) speakText += `${nutrition.calories} calories, `;
            if (nutrition.protein) speakText += `${nutrition.protein} grams of protein, `;
            if (nutrition.fat) speakText += `${nutrition.fat} grams of fat, `;
            if (nutrition.carbs) speakText += `${nutrition.carbs} grams of carbs.`;
          }
          speak(speakText);
          }

          openInfoModal(itemName, allergens, nutrition);
          return;
        }
        
        const card = e.target.closest('.item-card');
        if (card) {
          const name = card.dataset.name;
          const price = card.dataset.price;
          const category = card.dataset.category;
          // If selection is a meal type, open meal builder instead of item modal
          const mealNames = new Set(['Bowl','Plate','Bigger Plate']);
          if (mealNames.has(name)) {
            const slug = name === 'Bowl' ? 'bowl' : (name === 'Bigger Plate' ? 'bigger-plate' : 'plate');
            localStorage.setItem('kiosk_from_builder', 'true');
            window.location.href = `/builder/${slug}`;
            return;
          }
          const allergens = (card.dataset.allergens || '')
            .split(',')
            .map(t => t.trim())
            .filter(Boolean);
          const sizePricing = card.dataset.sizePricing ? JSON.parse(card.dataset.sizePricing) : {};
          openItemModal(name, price, allergens, category, sizePricing);
        }
      });

      // Item details modal logic
      const itemModal = document.getElementById('item-modal');
      const itemModalTitle = document.getElementById('item-modal-title');
      const itemModalPrice = document.getElementById('item-modal-price');
      const itemModalAllergens = document.getElementById('item-modal-allergens');
      const itemQtyEl = document.getElementById('item-qty');
      const itemQtyMinus = document.getElementById('item-qty-minus');
      const itemQtyPlus = document.getElementById('item-qty-plus');
      const itemModalClose = document.getElementById('item-modal-close');
      const itemModalCancel = document.getElementById('item-modal-cancel');
      const itemAddBtn = document.getElementById('item-add');

      let selectedItemName = '';
      let selectedItemPrice = 0;
      let selectedQty = 1;
      let selectedAllergens = [];
      let selectedSize = 'medium'; // default
      let selectedMultiplier = 2; // default medium = x2
      let selectedCategory = '';
      let selectedSizePricing = {}; // size pricing from database
      let selectedBaseName = ''; // for checking premium status

      async function openItemModal(name, price, allergens = [], category = '', sizePricing = {}) {
        selectedItemName = name;
        selectedItemPrice = parseFloat(price);
        selectedQty = 1;
        selectedCategory = category;
        selectedSize = 'medium';
        selectedMultiplier = 2;
        selectedSizePricing = sizePricing;
        selectedBaseName = name;
        
        itemModalTitle.textContent = name;
        itemModalPrice.textContent = selectedItemPrice.toFixed(2);
        itemQtyEl.textContent = String(selectedQty);
        
        // Show size selection for a la carte items (entrees and sides)
        const sizeSelection = document.getElementById('size-selection');
        const isPremium = name.toLowerCase().includes('honey walnut') || 
                         name.toLowerCase().includes('black pepper sirloin');
        
        // Check if this item has any size pricing
        const hasSizePricing = sizePricing && Object.keys(sizePricing).length > 0;
        
        if ((category === 'a_la_carte' || category === 'sides') && hasSizePricing) {
          sizeSelection.classList.remove('hidden');
          
          // Add premium badge if applicable
          if (isPremium && !itemModalTitle.querySelector('.premium-badge')) {
            const badge = document.createElement('span');
            badge.className = 'premium-badge text-xs bg-yellow-500 text-black px-2 py-0.5 rounded ml-2 font-bold';
            badge.textContent = 'PREMIUM';
            itemModalTitle.appendChild(badge);
          }
          
          // Update size button prices and visibility
          document.querySelectorAll('.size-btn').forEach(btn => {
            const size = btn.dataset.size.toLowerCase();
            // Check both regular and premium (capitalized) keys
            let sizePrice = null;
            if (size === 'medium') {
              // For medium, use base price
              sizePrice = parseFloat(price);
            } else if (isPremium) {
              // For premium items, use capitalized keys for small/large
              const capitalizedSize = size.charAt(0).toUpperCase() + size.slice(1);
              sizePrice = sizePricing[capitalizedSize];
            } else {
              // For regular items, use lowercase keys
              sizePrice = sizePricing[size];
            }
            
            // Hide buttons without pricing
            if (!sizePrice) {
              btn.classList.add('hidden');
            } else {
              btn.classList.remove('hidden');
              // Update button text with price
              const sizeLabel = size.charAt(0).toUpperCase() + size.slice(1);
              btn.innerHTML = `${sizeLabel}<br><span class="text-xs">$${sizePrice.toFixed(2)}</span>`;
            }
            
            // Reset styles
            btn.classList.remove('bg-red-600', 'text-white', 'border-red-600');
            btn.classList.add('border-neutral-300');
            if (size === 'medium') {
              btn.classList.add('bg-red-600', 'text-white', 'border-red-600');
            }
          });
        } else {
          sizeSelection.classList.add('hidden');
          // Remove premium badge if present
          const badge = itemModalTitle.querySelector('.premium-badge');
          if (badge) badge.remove();
        }
        
        const allergenText = allergens.length ? allergens.join(', ') : 'None';
        itemModalAllergens.textContent = allergenText;
        
        itemModal.classList.remove('hidden'); 
        itemModal.classList.add('flex');

        const lang = localStorage.getItem('kiosk_lang') || 'en';
        
        if (lang !== 'en') {
          try {
            const inputs = [name, allergenText];
            
            const res = await fetch('/api/translate', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ text: inputs, target: lang })
            });
            
            const data = await res.json();
            if (data.success && Array.isArray(data.translatedText)) {
              itemModalTitle.textContent = data.translatedText[0];
              itemModalAllergens.textContent = data.translatedText[1];
            }
          } catch (e) { 
            console.error("Modal translation error", e); 
          }
        }
      }

      function closeItemModal() {
        itemModal.classList.add('hidden');
        itemModal.classList.remove('flex');
      }

      itemQtyMinus.addEventListener('click', (e) => {
        e.stopPropagation();
        if (selectedQty > 1) {
          selectedQty -= 1;
          itemQtyEl.textContent = String(selectedQty);
        }
      });

      itemQtyPlus.addEventListener('click', (e) => {
        e.stopPropagation();
        selectedQty += 1;
        itemQtyEl.textContent = String(selectedQty);
      });

      itemModalClose.addEventListener('click', () => closeItemModal());
      itemModalCancel.addEventListener('click', () => closeItemModal());
      itemModal.addEventListener('click', (e) => {
        if (e.target === itemModal) closeItemModal();
      });
      
      // Size button handlers
      document.querySelectorAll('.size-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const size = btn.dataset.size;
          selectedSize = size;
          selectedMultiplier = parseInt(btn.dataset.multiplier);
          
          // Update price based on size
          const isPremium = selectedBaseName.toLowerCase().includes('honey walnut') || 
                           selectedBaseName.toLowerCase().includes('black pepper sirloin');
          
          let sizePrice = null;
          if (size === 'medium') {
            // Medium uses the base price from menu_item
            const basePrice = parseFloat(document.querySelector('.item-card[data-name="' + selectedBaseName + '"]')?.dataset.price || selectedItemPrice);
            sizePrice = basePrice;
          } else if (isPremium) {
            // For premium items, use capitalized keys for small/large
            const capitalizedSize = size.charAt(0).toUpperCase() + size.slice(1);
            sizePrice = selectedSizePricing[capitalizedSize];
          } else {
            // For regular items, use lowercase keys
            sizePrice = selectedSizePricing[size];
          }
          
          if (sizePrice) {
            selectedItemPrice = sizePrice;
            itemModalPrice.textContent = selectedItemPrice.toFixed(2);
          }
          
          // Update button styles
          document.querySelectorAll('.size-btn').forEach(b => {
            b.classList.remove('bg-red-600', 'text-white', 'border-red-600');
            b.classList.add('border-neutral-300');
          });
          btn.classList.remove('border-neutral-300');
          btn.classList.add('bg-red-600', 'text-white', 'border-red-600');
        });
      });

      itemAddBtn.addEventListener('click', () => {
        if (selectedItemName) {
          if ((selectedCategory === 'a_la_carte' || selectedCategory === 'sides') && selectedSizePricing && Object.keys(selectedSizePricing).length > 0) {
            // Add with size info
            const itemWithSize = `${selectedItemName} (${selectedSize.charAt(0).toUpperCase() + selectedSize.slice(1)})`;
            const itemData = {
              name: itemWithSize,
              baseName: selectedItemName,
              price: selectedItemPrice,
              quantity: selectedQty,
              size: selectedSize,
              multiplier: selectedMultiplier
            };
            addToCartWithSize(itemData);
          } else {
            addToCart(selectedItemName, selectedItemPrice, selectedQty);
          }
        }
        closeItemModal();
      });

      // -------- Meal builder logic ---------
      const mealModal = document.getElementById('meal-modal');
      const mealTitle = document.getElementById('meal-modal-title');
      const mealPriceEl = document.getElementById('meal-modal-price');
      const mealSidesEl = document.getElementById('meal-sides');
      const mealEntreesEl = document.getElementById('meal-entrees');
      const mealSideCountEl = document.getElementById('meal-side-count');
      const mealEntreeCountEl = document.getElementById('meal-entree-count');
      const mealEntreeMaxEl = document.getElementById('meal-entree-max');
      const mealEntreeMax2El = document.getElementById('meal-entree-max-2');
      const mealSideHint = document.getElementById('meal-side-hint');
      const mealAddBtn = document.getElementById('meal-add');
      const mealClose = document.getElementById('meal-modal-close');
      const mealCancel = document.getElementById('meal-modal-cancel');

      let mealConfig = null; // {type, price, entreeSlots, allowHalfSide}
      let sideCounts = {};   // name -> 0, 0.5, 1
      let entreeCounts = {}; // name -> int
      let editingMealIndex = null; // if editing existing cart item

      const proteins = (menuData.entrees || []).filter(i => !['Bowl','Plate','Bigger Plate'].includes(i.name));
      const sides = (menuData.sides || []);

      function openMealModal(typeName, price, existing = null, editIndex = null) {
        editingMealIndex = editIndex;
        const type = typeName.toLowerCase();
        const cfg = { type: type, price: Number(price), entreeSlots: 1, allowHalfSide: false };
        if (type.includes('plate') && !type.includes('bigger')) { cfg.entreeSlots = 2; cfg.allowHalfSide = true; }
        if (type.includes('bigger')) { cfg.entreeSlots = 3; cfg.allowHalfSide = true; }
        if (type.includes('bowl')) { cfg.entreeSlots = 1; cfg.allowHalfSide = false; }
        mealConfig = cfg;

        mealTitle.textContent = `${typeName}`;
        mealPriceEl.textContent = cfg.price.toFixed(2);
        mealEntreeMaxEl.textContent = String(cfg.entreeSlots);
        mealEntreeMax2El.textContent = String(cfg.entreeSlots);
        mealSideHint.textContent = cfg.allowHalfSide ? 'Select sides up to a total of 1 (halves allowed).' : 'Select one full side.';

        // Reset counts
        sideCounts = {};
        entreeCounts = {};
        sides.forEach(s => sideCounts[s.name] = 0);
        proteins.forEach(p => entreeCounts[p.name] = 0);

        // If editing, preload existing selections
        if (existing && existing.details) {
          const d = existing.details;
          if (d.sides) {
            if (d.sides.type === 'full' && d.sides.name) {
              sideCounts[d.sides.name] = 1;
            } else if (d.sides.type === 'halves' && Array.isArray(d.sides.items)) {
              d.sides.items.forEach(n => { if (n && n in sideCounts) sideCounts[n] = Math.min(1, sideCounts[n] + 0.5); });
            }
          }
          if (Array.isArray(d.entrees)) {
            d.entrees.forEach(e => { if (e.name in entreeCounts) entreeCounts[e.name] = e.count; });
          }
        }

        renderMealSides();
        renderMealEntrees();
        updateMealValidity();

        mealModal.classList.remove('hidden');
        mealModal.classList.add('flex');
      }

      function closeMealModal() {
        mealModal.classList.add('hidden');
        mealModal.classList.remove('flex');
        editingMealIndex = null;
      }

      function totalSide() { return Object.values(sideCounts).reduce((s,v)=>s+v,0); }
      function totalEntrees() { return Object.values(entreeCounts).reduce((s,v)=>s+v,0); }

      function renderMealSides() {
        mealSidesEl.innerHTML = '';
        sides.forEach(s => {
          const val = sideCounts[s.name] || 0;
          const btn = document.createElement('button');
          btn.className = 'w-full text-left border border-neutral-300 px-3 py-2 flex items-center justify-between hover:bg-neutral-50';
          btn.innerHTML = `
            <span>${s.name}</span>
            <span class="text-xs text-neutral-700">${val === 1 ? 'Full' : val === 0.5 ? 'Half' : ''}</span>
          `;
          btn.addEventListener('click', () => {
            if (!mealConfig.allowHalfSide) {
              // set this side to 1 and others to 0
              Object.keys(sideCounts).forEach(k => sideCounts[k] = 0);
              sideCounts[s.name] = 1;
            } else {
              // cycle 0 -> 0.5 -> 1 -> 0 constrained by total ‚â§ 1
              const next = val === 0 ? 0.5 : (val === 0.5 ? 1 : 0);
              const newTotal = totalSide() - val + next;
              if (newTotal <= 1) sideCounts[s.name] = next;
            }
            mealSideCountEl.textContent = String(totalSide());
            renderMealSides();
            updateMealValidity();
          });
          mealSidesEl.appendChild(btn);
        });
        mealSideCountEl.textContent = String(totalSide());
      }

      function renderMealEntrees() {
        mealEntreesEl.innerHTML = '';
        proteins.forEach(p => {
          const count = entreeCounts[p.name] || 0;
          const row = document.createElement('div');
          row.className = 'border border-neutral-300 px-3 py-2 flex items-center justify-between';
          row.innerHTML = `
            <div class="font-medium">${p.name}</div>
            <div class="flex items-center gap-2">
              <button class="dec px-2 py-1 border border-neutral-300">-</button>
              <div class="w-6 text-center">${count}</div>
              <button class="inc px-2 py-1 border border-neutral-300">+</button>
            </div>
          `;
          row.querySelector('.inc').addEventListener('click', () => {
            const current = entreeCounts[p.name] || 0;
            if (totalEntrees() < mealConfig.entreeSlots) {
              entreeCounts[p.name] = current + 1;
              renderMealEntrees();
              updateMealValidity();
            }
          });
          row.querySelector('.dec').addEventListener('click', () => {
            const current = entreeCounts[p.name] || 0;
            if (current > 0) {
              entreeCounts[p.name] = current - 1;
              renderMealEntrees();
              updateMealValidity();
            }
          });
          mealEntreesEl.appendChild(row);
        });
        mealEntreeCountEl.textContent = String(totalEntrees());
        mealEntreeMax2El.textContent = String(mealConfig.entreeSlots);
      }

      function updateMealValidity() {
        const okSides = Math.abs(totalSide() - 1) < 1e-6;
        const okEntrees = totalEntrees() === mealConfig.entreeSlots;
        mealAddBtn.disabled = !(okSides && okEntrees);
      }

      function buildMealDetails() {
        // sides
        const entries = Object.entries(sideCounts).filter(([_,v]) => v>0).sort((a,b)=>b[1]-a[1]);
        let sidesDetail = null;
        if (entries.length === 1 && entries[0][1] === 1) {
          sidesDetail = { type: 'full', name: entries[0][0] };
        } else {
          const items = [];
          entries.forEach(([n,v]) => {
            if (v === 1) { items.push(n, n); }
            else if (v === 0.5) { items.push(n); }
          });
          sidesDetail = { type: 'halves', items };
        }
        // entrees
        const entreesDetail = Object.entries(entreeCounts)
          .filter(([_,c]) => c>0)
          .map(([name,count]) => ({ name, count }));
        return { sides: sidesDetail, entrees: entreesDetail };
      }

      mealAddBtn.addEventListener('click', () => {
        const details = buildMealDetails();
        const mealName = mealTitle.textContent;
        const price = Number(mealPriceEl.textContent);
        const itemObj = { name: mealName, price, quantity: 1, type: 'meal', details };
        if (editingMealIndex !== null && cart[editingMealIndex]) {
          cart[editingMealIndex] = { ...cart[editingMealIndex], name: mealName, price, details };
        } else {
          cart.push(itemObj);
        }
        renderCartDrawer();
        openCartDrawer();
        closeMealModal();
      });

      mealClose.addEventListener('click', closeMealModal);
      mealCancel.addEventListener('click', closeMealModal);
      mealModal.addEventListener('click', (e) => { if (e.target === mealModal) closeMealModal(); });


      // Drawer events
      document.getElementById('cart-open-drawer').addEventListener('click', openCartDrawer);
      document.getElementById('cart-drawer-close').addEventListener('click', closeCartDrawer);
      document.getElementById('cart-drawer-backdrop').addEventListener('click', closeCartDrawer);

      // Delegate quantity buttons in drawer
      document.getElementById('cart-drawer-items').addEventListener('click', (e) => {
        const target = e.target;
        if (!(target instanceof Element)) return;
        const idxAttr = target.getAttribute('data-idx');
        const idx = Number(idxAttr);
        if (target.classList.contains('edit-meal')) {
          const i = Number(idxAttr);
          const it = cart[i];
          if (it && it.type === 'meal') {
            // Determine the correct slug based on cart item name
            let slug = 'plate';
            if (it.name === 'Bowl') slug = 'bowl';
            else if (it.name === 'Bigger Plate') slug = 'bigger-plate';
            else if (it.name === 'Plate') slug = 'plate';
            localStorage.setItem('kiosk_from_builder', 'true');
            window.location.href = `/builder/edit?idx=${i}&type=${slug}`;
          }
          return;
        }

        if (!Number.isFinite(idx) || !cart[idx]) return;

        if (target.classList.contains('qty-minus')) {
          cart[idx].quantity -= 1;
          if (cart[idx].quantity <= 0) cart.splice(idx, 1);
          renderCartDrawer();
        } else if (target.classList.contains('qty-plus')) {
          cart[idx].quantity += 1;
          renderCartDrawer();
        } else if (target.classList.contains('delete-item')) {
          cart.splice(idx, 1);
          renderCartDrawer();
        }
      });

      // Optional: go to checkout from drawer
      let selectedDineOption = null; // Store the user's dine option choice
      
      document.getElementById('cart-go-checkout').addEventListener('click', () => {
        if (cart.length === 0) {
          alert("Please add items to your cart first");
          return;
        }
        // Show dine option modal
        document.getElementById('dine-option-modal').classList.remove('hidden');
        document.getElementById('dine-option-modal').classList.add('flex');
        closeCartDrawer();
      });

      // Dine option modal handlers
      const dineOptionModal = document.getElementById('dine-option-modal');
      
      document.getElementById('dine-option-cancel').addEventListener('click', () => {
        dineOptionModal.classList.add('hidden');
        dineOptionModal.classList.remove('flex');
        openCartDrawer();
      });

      document.querySelectorAll('.dine-option-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          selectedDineOption = btn.getAttribute('data-dine-option');
          
          // Hide dine option modal and show payment modal
          dineOptionModal.classList.add('hidden');
          dineOptionModal.classList.remove('flex');
          
          const subtotal = cart.reduce((s, i) => s + (i.price * i.quantity), 0);
          const tax = subtotal * 0.08;
          const grandTotal = subtotal + tax;
          document.getElementById('payment-total').textContent = grandTotal.toFixed(2);
          document.getElementById('payment-modal').classList.remove('hidden');
          document.getElementById('payment-modal').classList.add('flex');
        });
      });

      // Payment modal handlers
      const paymentModal = document.getElementById('payment-modal');
      
      let orderInProgress = false; // Prevent spam orders
      
      document.getElementById('payment-cancel').addEventListener('click', () => {
        if (orderInProgress) return; // Don't allow canceling during order
        paymentModal.classList.add('hidden');
        paymentModal.classList.remove('flex');
        // Go back to dine option modal
        selectedDineOption = null;
        dineOptionModal.classList.remove('hidden');
        dineOptionModal.classList.add('flex');
      });

      document.querySelectorAll('.payment-method-btn').forEach((btn) => {
        btn.addEventListener('click', async () => {
          // Prevent spam clicks
          if (orderInProgress) {
            console.log('Order already in progress, ignoring click');
            return;
          }
          
          const method = btn.getAttribute('data-method');
          orderInProgress = true;
          
          // Disable all payment buttons
          document.querySelectorAll('.payment-method-btn').forEach(b => {
            b.disabled = true;
            b.style.opacity = '0.5';
            b.style.cursor = 'not-allowed';
          });

          const checkoutCart = cart.map((item) => {
            if (item.type === 'meal' && item.details) {
              const options = extractOptionsForItem(item);
              return { ...item, options };
            }
            return item;
          });

          if (!checkoutCart.length) {
            alert('Cart is empty.');
            orderInProgress = false;
            document.querySelectorAll('.payment-method-btn').forEach(b => {
              b.disabled = false;
              b.style.opacity = '1';
              b.style.cursor = 'pointer';
            });
            return;
          }

          try {
            const response = await fetch('/api/checkout', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ cart: checkoutCart, paymentMethod: method, dineOption: selectedDineOption }),
            });

            const data = await response.json();

            if (data.success) {

              // Fill success modal
              document.getElementById('success-order-number').textContent = `#${data.order_id}`;
              const subtotal = checkoutCart.reduce((s, i) => s + i.price * i.quantity, 0);
              const tax = subtotal * 0.08;
              const grandTotal = subtotal + tax;
              // ‚Üí Used for success screen
              document.getElementById('success-total').textContent = `$${grandTotal.toFixed(2)}`;
              document.getElementById('success-dine-option').textContent = 
                selectedDineOption === 'dine_in' ? 'Dine In' : 'Takeout';

              // Clear cart and reset state
              cart = [];
              renderCartDrawer();
              saveCart(cart);
              selectedDineOption = null;

              // Hide payment modal
              paymentModal.classList.add('hidden');
              paymentModal.classList.remove('flex');

              // Show success modal
              document.getElementById('order-success-modal').classList.remove('hidden');
              document.getElementById('order-success-modal').classList.add('flex');
              
              // Reset order flag after success
              orderInProgress = false;
              document.querySelectorAll('.payment-method-btn').forEach(b => {
                b.disabled = false;
                b.style.opacity = '1';
                b.style.cursor = 'pointer';
              });
            } else {
              alert('Failed to place order: ' + (data.error || 'Unknown error'));
              orderInProgress = false;
              document.querySelectorAll('.payment-method-btn').forEach(b => {
                b.disabled = false;
                b.style.opacity = '1';
                b.style.cursor = 'pointer';
              });
              paymentModal.classList.add('hidden');
              paymentModal.classList.remove('flex');
              openCartDrawer();
            }
          } catch (err) {
            console.error('Checkout error:', err);
            alert('Failed to place order. Please try again.');
            orderInProgress = false;
            document.querySelectorAll('.payment-method-btn').forEach(b => {
              b.disabled = false;
              b.style.opacity = '1';
              b.style.cursor = 'pointer';
            });
            paymentModal.classList.add('hidden');
            paymentModal.classList.remove('flex');
            openCartDrawer();
          }
        });
      });

      // Close success modal and show landing page after 3 seconds
      document.getElementById('success-done-btn').addEventListener('click', () => {
        document.getElementById('order-success-modal').classList.add('hidden');
        document.getElementById('order-success-modal').classList.remove('flex');
        setTimeout(() => {
          showLandingPage();
          // Clear cart and reset after returning to landing page
          cart = [];
          renderCartDrawer();
          saveCart(cart);
        }, 3000);
      });
      

      const clearCartModal = document.getElementById("clear-cart-modal");
      const confirmClearCart = document.getElementById("confirm-clear-cart");
      const cancelClearCart = document.getElementById("cancel-clear-cart");

      document.getElementById("cart-clear").addEventListener("click", () => {
        if (cart.length === 0) return;

        clearCartModal.classList.remove("hidden");
        clearCartModal.classList.add("flex");
      });

      // Confirm
      confirmClearCart.addEventListener("click", () => {
        cart = [];
        renderCartDrawer();
        saveCart(cart);

        clearCartModal.classList.add("hidden");
        clearCartModal.classList.remove("flex");
      });

      // Cancel
      cancelClearCart.addEventListener("click", () => {
        clearCartModal.classList.add("hidden");
        clearCartModal.classList.remove("flex");
      });

      // Clicking the background closes it too
      clearCartModal.addEventListener("click", (e) => {
        if (e.target === clearCartModal) {
          clearCartModal.classList.add("hidden");
          clearCartModal.classList.remove("flex");
        }
      });

      // Initialize cart display
      renderCartDrawer();
    
    // Weather Logic
    async function loadWeather() {
      try {
        const res = await fetch('/api/weather');
        const data = await res.json();
        if (data.success) {
          const descEl = document.getElementById('weather-desc');
          
          document.getElementById('weather-temp').textContent = `${data.temp}¬∞F`;
          descEl.textContent = data.desc;
          document.getElementById('weather-icon').src = data.icon;
          
          descEl.setAttribute('data-original', data.desc);

          const widget = document.getElementById('weather-widget');
          widget.classList.remove('hidden');
          widget.classList.add('flex');

          const currentLang = localStorage.getItem('kiosk_lang') || 'en';
          if (currentLang !== 'en') {
            translateTextSingle(data.desc, currentLang).then(translated => {
              if (translated) descEl.textContent = translated;
            });
          }
        }
      } catch (e) {
        console.error("Failed to load weather", e);
      }
    }
    loadWeather();

    async function translateTextSingle(text, targetLang) {
      try {
        const res = await fetch('/api/translate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: text, target: targetLang })
        });
        const data = await res.json();
        return data.success ? data.translatedText : null;
      } catch (e) {
        return null;
      }
    }

      // Translation Logic
      const originalTexts = new Map();

      // Text Size Logic
      function changeTextSize(size) {
        // Remove all text size classes
        document.documentElement.classList.remove('text-size-small', 'text-size-medium', 'text-size-large');
        // Add the selected size class
        document.documentElement.classList.add(`text-size-${size}`);
        // Save preference
        localStorage.setItem('kiosk_text_size', size);
        
        // Update button states
        document.querySelectorAll('.text-size-btn').forEach(btn => {
          if (btn.getAttribute('data-size') === size) {
            btn.classList.remove('bg-neutral-800');
            btn.classList.add('bg-red-700');
          } else {
            btn.classList.remove('bg-red-700');
            btn.classList.add('bg-neutral-800');
          }
        });
      }

      // Initialize text size on page load
      function initTextSize() {
        const savedSize = localStorage.getItem('kiosk_text_size') || 'large';
        changeTextSize(savedSize);
      }

      // Text-to-Speech Logic
      const ttsLexicon = {
      'en': { info: "Information for", allergens: "Allergens", none: "No allergens listed", nutrition: "Nutrition facts", cal: "calories", pro: "grams of protein", fat: "grams of fat", carb: "grams of carbs" },
      'es': { info: "Informaci√≥n para", allergens: "Al√©rgenos", none: "No hay al√©rgenos listados", nutrition: "Informaci√≥n nutricional", cal: "calor√≠as", pro: "gramos de prote√≠na", fat: "gramos de grasa", carb: "gramos de carbohidratos" },
      'zh': { info: "‰ø°ÊÅØ", allergens: "ËøáÊïèÂéü", none: "Êú™ÂàóÂá∫ËøáÊïèÂéü", nutrition: "Ëê•ÂÖªÊàêÂàÜ", cal: "Âç°Ë∑ØÈáå", pro: "ÂÖãËõãÁôΩË¥®", fat: "ÂÖãËÑÇËÇ™", carb: "ÂÖãÁ¢≥Ê∞¥ÂåñÂêàÁâ©" },
      'zh-CN': { info: "‰ø°ÊÅØ", allergens: "ËøáÊïèÂéü", none: "Êú™ÂàóÂá∫ËøáÊïèÂéü", nutrition: "Ëê•ÂÖªÊàêÂàÜ", cal: "Âç°Ë∑ØÈáå", pro: "ÂÖãËõãÁôΩË¥®", fat: "ÂÖãËÑÇËÇ™", carb: "ÂÖãÁ¢≥Ê∞¥ÂåñÂêàÁâ©" },
      'fr': { info: "Informations pour", allergens: "Allerg√®nes", none: "Aucun allerg√®ne r√©pertori√©", nutrition: "Valeurs nutritionnelles", cal: "calories", pro: "grammes de prot√©ines", fat: "grammes de lipides", carb: "grammes de glucides" },
      'de': { info: "Informationen f√ºr", allergens: "Allergene", none: "Keine Allergene aufgef√ºhrt", nutrition: "N√§hrwerte", cal: "Kalorien", pro: "Gramm Protein", fat: "Gramm Fett", carb: "Gramm Kohlenhydrate" }
      };

      let ttsEnabled = false;
      let currentUtterance = null;
      const synth = window.speechSynthesis;

      function initTTS() {
        const savedTTS = localStorage.getItem('kiosk_tts_enabled');
        if (savedTTS === 'true') {
          ttsEnabled = true;
        }
        updateTTSUI();
      }

      function updateTTSUI() {
        const icon = document.getElementById('tts-icon');
        const status = document.getElementById('tts-status');
        const toggle = document.getElementById('tts-toggle');
        
        if (ttsEnabled) {
          icon.textContent = 'üîä';
          status.textContent = 'On';
          status.setAttribute('data-original', 'On');
          toggle.classList.remove('bg-neutral-800');
          toggle.classList.add('bg-green-700');
        } else {
          icon.textContent = 'üîá';
          status.textContent = 'Off';
          status.setAttribute('data-original', 'Off');
          toggle.classList.remove('bg-green-700');
          toggle.classList.add('bg-neutral-800');
        }
      }

      function speak(text) {
        if (!ttsEnabled || !text) return;
        
        // Cancel any ongoing speech
        synth.cancel();
        
        const utterance = new SpeechSynthesisUtterance(text);
        const lang = localStorage.getItem('kiosk_lang') || 'en';
        
        // Map language codes to speech synthesis language codes
        const langMap = {
          'en': 'en-US',
          'es': 'es-ES',
          'zh': 'zh-CN',
          'fr': 'fr-FR',
          'de': 'de-DE'
        };
        
        utterance.lang = langMap[lang] || 'en-US';
        utterance.rate = 1.0;
        utterance.pitch = 1.0;
        utterance.volume = 1.0;
        
        currentUtterance = utterance;
        synth.speak(utterance);
      }

      document.getElementById('tts-toggle')?.addEventListener('click', () => {
        ttsEnabled = !ttsEnabled;
        localStorage.setItem('kiosk_tts_enabled', ttsEnabled.toString());
        updateTTSUI();
        
        if (ttsEnabled) {
          speak('Text to speech enabled');
        } else {
          synth.cancel();
        }
      });

      // Add TTS to navigation buttons
      document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('mouseenter', () => speak(link.textContent.trim()));
      });

      document.addEventListener('mouseenter', (e) => {
        if (!ttsEnabled) return;
        const target = e.target;

        // Cart Total Display
        const totalDisplay = target.closest('#cart-total-display');
        if (totalDisplay) {
            speak(totalDisplay.textContent.trim());
            return;
        }

        // Item Cards
        if (target.closest('.item-card')) {
          const card = target.closest('.item-card');
          const name = card.querySelector('[data-translate-type="item-name"]')?.textContent || card.dataset.name;
          if (name) speak(name);
          return;
        }

        // Cart Items
        if (target.closest('#cart-drawer-items > div')) {
          const name = target.querySelector('.font-medium')?.textContent;
          if (name) speak(name);
          return;
        }

        // Generic Buttons
        if (target.tagName === 'BUTTON' && target.id !== 'tts-toggle') {
          const text = target.getAttribute('aria-label') || target.textContent.trim();
          if (text && text.length < 50) speak(text);
        }
      }, true);

      // Accessibility panel toggle
      document.getElementById('accessibility-toggle')?.addEventListener('click', () => {
        const panel = document.getElementById('accessibility-panel');
        const arrow = document.getElementById('accessibility-arrow');
        if (panel.classList.contains('hidden')) {
          panel.classList.remove('hidden');
          arrow.style.transform = 'rotate(180deg)';
        } else {
          panel.classList.add('hidden');
          arrow.style.transform = 'rotate(0deg)';
        }
      });

      // Landing page / Screensaver functionality
      let inactivityTimer = null;
      let warningTimer = null;
      let countdownTimer = null;
      const INACTIVITY_WARNING_TIMEOUT = 45000; // 45 seconds before warning
      const WARNING_COUNTDOWN = 10; // 10 seconds countdown
      const landingPage = document.getElementById('landing-page');
      const stillThereModal = document.getElementById('still-there-modal');
      const stillThereCountdown = document.getElementById('still-there-countdown');
      let countdownValue = WARNING_COUNTDOWN;

      function showLandingPage() {
        landingPage.style.display = 'flex';
      }

      function hideLandingPage() {
        landingPage.style.display = 'none';
        resetInactivityTimer();
      }

      function showStillThereModal() {
        stillThereModal.classList.remove('hidden');
        stillThereModal.classList.add('flex');
        countdownValue = WARNING_COUNTDOWN;
        stillThereCountdown.textContent = countdownValue;
        startCountdown();
      }

      function hideStillThereModal() {
        stillThereModal.classList.add('hidden');
        stillThereModal.classList.remove('flex');
        clearInterval(countdownTimer);
        clearTimeout(warningTimer);
        resetInactivityTimer();
      }

      function startCountdown() {
        const circle = document.getElementById('countdown-circle');
        const circumference = 2 * Math.PI * 72; // radius is 72
        
        countdownTimer = setInterval(() => {
          countdownValue--;
          stillThereCountdown.textContent = countdownValue;
          
          // Animate the circle
          const progress = countdownValue / WARNING_COUNTDOWN;
          const offset = circumference * (1 - progress);
          if (circle) {
            circle.style.strokeDashoffset = offset;
          }
          
          if (countdownValue <= 0) {
            clearInterval(countdownTimer);
            hideStillThereModal();
            clearCartAndReturnToLanding();
          }
        }, 1000);
      }

      function clearCartAndReturnToLanding() {
        // Clear the cart
        cart = [];
        renderCartDrawer();
        saveCart(cart);
        // Close any open modals
        document.getElementById('item-modal')?.classList.add('hidden');
        document.getElementById('meal-modal')?.classList.add('hidden');
        document.getElementById('item-info-modal')?.classList.add('hidden');
        closeCartDrawer();
        // Show landing page
        showLandingPage();
      }

      function resetInactivityTimer() {
        clearTimeout(inactivityTimer);
        clearTimeout(warningTimer);
        clearInterval(countdownTimer);
        inactivityTimer = setTimeout(() => {
          showStillThereModal();
        }, INACTIVITY_WARNING_TIMEOUT);
      }

      // Hide landing page on tap/click
      landingPage.addEventListener('click', hideLandingPage);

      // Continue button in still there modal
      document.getElementById('still-there-continue').addEventListener('click', hideStillThereModal);
      stillThereModal.addEventListener('click', (e) => {
        if (e.target === stillThereModal) {
          hideStillThereModal();
        }
      });

      // Track user activity to reset timer
      ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'].forEach(event => {
        document.addEventListener(event, () => {
          if (landingPage.style.display === 'none' && stillThereModal.classList.contains('hidden')) {
            resetInactivityTimer();
          }
        }, true);
      });

      document.addEventListener('DOMContentLoaded', () => {
        const savedLang = localStorage.getItem('kiosk_lang');
        if (savedLang && savedLang !== 'en') {
          setTimeout(() => changeLanguage(savedLang), 100);
        }
        loadWeather(); // Load weather on startup
        initTextSize(); // Initialize text size
        initTTS(); // Initialize text-to-speech
        
        // Check if returning from builder - if so, don't show landing page
        const fromBuilder = localStorage.getItem('kiosk_from_builder');
        if (fromBuilder === 'true') {
          localStorage.removeItem('kiosk_from_builder');
          hideLandingPage();
        } else {
          // Start with landing page visible
          showLandingPage();
        }
      });

    async function changeLanguage(lang) {
      localStorage.setItem('kiosk_lang', lang);

      const elementsToTranslate = document.querySelectorAll('[data-original]');
      if (elementsToTranslate.length === 0) return;

      if (lang === 'en') {
        elementsToTranslate.forEach(el => {
          if (!el.classList.contains('no-translate')) {
            el.textContent = el.getAttribute('data-original');
          }
        });
        return;
      }

      const uniqueTexts = new Set();
      elementsToTranslate.forEach(el => {
        if (!el.classList.contains('no-translate')) {
           const text = el.getAttribute('data-original');
           if (text) uniqueTexts.add(text.trim());
        }
      });
      
      const textArray = Array.from(uniqueTexts).filter(Boolean);
      if (textArray.length === 0) return;

      try {
        const res = await fetch('/api/translate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ text: textArray, target: lang })
        });
        const data = await res.json();
        
        if (data.success && Array.isArray(data.translatedText)) {
            const translationMap = {};
            textArray.forEach((original, index) => {
                translationMap[original] = data.translatedText[index];
            });

            elementsToTranslate.forEach(el => {
                const original = el.getAttribute('data-original').trim();
                if (translationMap[original]) {
                    el.textContent = translationMap[original];
                }
            });
        }
      } catch(e) { console.error("Translation failed", e); }
    }

    const callStaffBtn = document.getElementById('call-staff-btn');

    callStaffBtn.addEventListener('click', async () => {
      // Disable button for 15 seconds to prevent spam
      callStaffBtn.disabled = true;
      callStaffBtn.textContent = 'Help Requested‚Ä¶';

      try {
        await fetch('/api/call-staff', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
        });
      } catch (e) {
        console.error('Failed to call staff', e);
      }

      // Re-enable after 15 seconds
      setTimeout(() => {
        callStaffBtn.disabled = false;
        callStaffBtn.textContent = 'Call Staff for Help';
      }, 15_000);
    });
    </script>
  </body>
</html>