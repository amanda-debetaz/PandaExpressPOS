<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Build Your Plate â€“ Panda Express</title>
    <style>
      * { box-sizing: border-box; }
      body {
        font-family: "Arial", sans-serif;
        margin: 0;
        padding: 0;
        background: #f4f4f4;
        color: #333;
      }
      .container {
        max-width: 700px;
        margin: 40px auto;
        padding: 30px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        position: relative;
        padding-bottom: 100px;
      }
      h1 { text-align: center; color: #d32f2f; margin-bottom: 30px; font-size: 2em; }
      .section { margin-bottom: 40px; }
      .section h2 {
        color: #d32f2f;
        border-bottom: 2px solid #ffebee;
        padding-bottom: 10px;
        margin-bottom: 20px;
        font-size: 1.4em;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .clear-btn {
        background: #ddd;
        color: #555;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 0.85em;
        cursor: pointer;
        transition: background 0.2s;
      }
      .clear-btn:hover { background: #ccc; }

      .menu-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 20px;
      }
      .cube-btn {
        background: #fff;
        border: 1px solid #eee;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        transition: all 0.2s;
        cursor: pointer;
        text-align: center;
        display: flex;
        flex-direction: column;
        height: 100%;
        position: relative;
      }
      .cube-btn:hover {
        transform: translateY(-4px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.15);
      }
      .cube-btn.selected {
        outline: 3px solid #d32f2f;
      }
      .cube-img {
        width: 100%;
        height: 120px;
        object-fit: cover;
        background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Crect width='120' height='120' fill='%23f0f0f0'/%3E%3Ctext x='60' y='70' font-family='Arial' font-size='16' text-anchor='middle' fill='%23999'%3ENo Image%3C/text%3E%3C/svg%3E") center / contain no-repeat;
      }
      .cube-info {
        padding: 12px 8px;
        flex-grow: 1;
      }
      .cube-name {
        font-weight: bold;
        font-size: 1em;
        color: #333;
      }

      .btn {
        display: block;
        width: 100%;
        padding: 14px;
        margin: 20px 0;
        background: #d32f2f;
        color: white;
        font-weight: bold;
        font-size: 1.1em;
        text-align: center;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.2s;
      }
      .btn:hover { background: #b71c1c; }
      .btn:disabled { background: #ccc; cursor: not-allowed; }

      .back-link {
        display: block;
        text-align: center;
        margin-top: 20px;
        color: #666;
        text-decoration: none;
        font-size: 0.95em;
      }
      .back-link:hover { color: #d32f2f; text-decoration: underline; }

      .badge {
        position: absolute;
        top: 6px;
        right: 6px;
        background: #d32f2f;
        color: white;
        font-weight: bold;
        font-size: 0.75rem;
        width: 1.4rem;
        height: 1.4rem;
        line-height: 1.4rem;
        border-radius: 50%;
        text-align: center;
        pointer-events: none;
        z-index: 10;
      }

      /* === STICKY ACTION BAR === */
      #sticky-actions {
        position: fixed;
        bottom: 20px;
        right: 20px;
        display: flex;
        gap: 18px;
        align-items: center;
        background: rgba(255, 255, 255, 0.95);
        padding: 16px 20px;
        border-radius: 16px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        backdrop-filter: blur(8px);
        z-index: 1000;
        transition: all 0.3s ease;
      }
      #sticky-actions:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
      }
      #sticky-actions .btn {
        margin: 0;
        padding: 12px 28px;
        font-size: 1.1em;
        min-width: 150px;
      }
      #half-btn,
      #undo-btn {
        background: #607d8b;
        color: white;
        border: none;
        padding: 11px 18px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        font-size: 1.05em;
        min-width: 56px;
        transition: background 0.2s;
      }
      #half-btn {
        background: #ffeb3b;
        color: #333;
      }
      #half-btn.active { background: #fbc02d; }
      #half-btn:hover { background: #fdd835; }
      #undo-btn:hover { background: #546e7a; }

      @media (max-width: 480px) {
        .container { margin: 20px; padding: 20px; padding-bottom: 120px; }
        h1 { font-size: 1.6em; }
        #sticky-actions {
          bottom: 15px;
          right: 15px;
          padding: 12px 14px;
          gap: 10px;
          flex-wrap: wrap;
          justify-content: center;
        }
        #sticky-actions .btn { padding: 10px 16px; font-size: 1em; min-width: 120px; }
        #half-btn, #undo-btn { padding: 8px 14px; font-size: 0.95em; }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Build Your Plate</h1>

      <!-- Selected Entree Display -->
      <div id="selected-entree" style="margin-bottom: 30px; padding: 15px; background: #fff8e1; border-radius: 8px; text-align: center; font-weight: bold; color: #d32f2f;">
        Selected: <span id="entree-name">None</span>
      </div>

      <form id="plate-form" action="/summary" method="POST" onsubmit="sessionStorage.removeItem('selectedEntree')">
        <input type="hidden" name="orderData" id="order-data" />

        <!-- SIDES -->
        <div class="section">
          <h2>
            Pick 1 side
            <button type="button" class="clear-btn" onclick="clearSection('side')">Clear</button>
          </h2>
          <div class="menu-grid">
            <% menu.sides.forEach(item => { %>
              <button type="button" class="cube-btn" data-name="<%= item.name %>" onclick="selectSide(this)">
                <img 
                  src="/images/<%= item.name.toLowerCase().replace(/ /g,'-') %>.jpg" 
                  onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27120%27 height=%27120%27%3E%3Crect width=%27120%27 height=%27120%27 fill=%27%23f0f0f0%27/%3E%3Ctext x=%2760%27 y=%2770%27 font-family=%27Arial%27 font-size=%2716%27 text-anchor=%27middle%27 fill=%27%23999%27%3ENo Image%3C/text%3E%3C/svg%3E'" 
                  alt="<%= item.name %>" 
                  class="cube-img" 
                />
                <div class="cube-info">
                  <div class="cube-name"><%= item.name %></div>
                </div>
              </button>
            <% }); %>
          </div>
        </div>

        <!-- MAIN ITEMS (A LA CARTE) -->
        <div class="section">
          <h2 id="ala-label">
            Pick main items
            <button type="button" class="clear-btn" onclick="clearSection('ala')">Clear</button>
          </h2>
          <div class="menu-grid">
            <% menu.a_la_carte.forEach(item => { %>
              <button type="button" class="cube-btn" data-name="<%= item.name %>" onclick="selectAlaCarte(this)">
                <img 
                  src="/images/<%= item.name.toLowerCase().replace(/ /g,'-') %>.jpg" 
                  onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 width=%27120%27 height=%27120%27%3E%3Crect width=%27120%27 height=%27120%27 fill=%27%23f0f0f0%27/%3E%3Ctext x=%2760%27 y=%2770%27 font-family=%27Arial%27 font-size=%2716%27 text-anchor=%27middle%27 fill=%27%23999%27%3ENo Image%3C/text%3E%3C/svg%3E'" 
                  alt="<%= item.name %>" 
                  class="cube-img" 
                />
                <div class="cube-info">
                  <div class="cube-name"><%= item.name %></div>
                </div>
              </button>
            <% }); %>
          </div>
        </div>

        <!-- DRINKS -->
        <div class="section">
          <h2>
            Add a Drink (Optional)
            <button type="button" class="clear-btn" onclick="clearSection('drink')">Clear</button>
          </h2>
          <div class="menu-grid">
            <button type="button" class="cube-btn" data-name="Medium Fountain Drink" onclick="selectDrink(this)">
              <div class="cube-img" style="background: url('/images/drink.jpg') center/cover no-repeat;"></div>
              <div class="cube-info">
                <div class="cube-name">Medium Fountain Drink</div>
              </div>
            </button>
          </div>
        </div>

        <!-- STICKY ACTION BAR -->
        <div id="sticky-actions">
          <button type="button" id="half-btn">Half</button>
          <button type="button" id="undo-btn">Undo</button>
          <button type="submit" class="btn" id="submit-btn" disabled>Add to Order</button>
        </div>
      </form>

      <a href="/kiosk" class="back-link">Back to Menu</a>
    </div>

    <script>
      /* --------------------------------------------------------------
         STATE
      -------------------------------------------------------------- */
      let selected = {
        entree: null,
        side:   null,
        ala:    [],
        drink:  null
      };

      let halfMode = false;
      let halfClicksLeft = 0;
      const undoStack = [];
      const MAX_UNDO = 20;

      /* --------------------------------------------------------------
         HELPERS
      -------------------------------------------------------------- */
      function pushUndo() {
        undoStack.push(JSON.parse(JSON.stringify(selected)));
        if (undoStack.length > MAX_UNDO) undoStack.shift();
      }

      function popUndo() {
        if (undoStack.length === 0) return;
        selected = undoStack.pop();
        renderAll();
        checkReady();
      }

      function renderAll() {
        // ENTREE
        const entreeNameEl = document.getElementById('entree-name');
        if (selected.entree) {
          entreeNameEl.textContent = selected.entree.name;
          updateAlaLabel(selected.entree.mealType);
        } else {
          entreeNameEl.textContent = 'None';
          updateAlaLabel(null);
        }

        // SIDE
        document.querySelectorAll('[onclick^="selectSide"]').forEach(b => b.classList.remove('selected'));
        if (selected.side) {
          const btn = document.querySelector(`[data-name="${selected.side.name}"]`);
          if (btn) btn.classList.add('selected');
        }

        // ALA
        document.querySelectorAll('[onclick^="selectAlaCarte"]').forEach(b => {
          b.classList.remove('selected');
          const badge = b.querySelector('.badge');
          if (badge) badge.remove();
        });
        selected.ala.forEach(it => {
          const btn = document.querySelector(`[data-name="${it.name}"]`);
          if (btn) {
            btn.classList.add('selected');
            addBadge(btn, it.qty);
          }
        });

        // DRINK
        document.querySelectorAll('[onclick^="selectDrink"]').forEach(b => b.classList.remove('selected'));
        if (selected.drink) {
          const btn = document.querySelector(`[data-name="${selected.drink.name}"]`);
          if (btn) btn.classList.add('selected');
        }

        // HALF BUTTON
        const halfBtn = document.getElementById('half-btn');
        halfBtn.textContent = halfClicksLeft ? `Half (${halfClicksLeft})` : 'Half';
        halfBtn.classList.toggle('active', halfMode);

        checkReady();
      }

      function addBadge(btn, qty) {
        let badge = btn.querySelector('.badge');
        if (!badge) {
          badge = document.createElement('div');
          badge.className = 'badge';
          btn.appendChild(badge);
        }
        badge.textContent = qty === 0.5 ? 'Half' : qty;
      }

      function maxAla() {
        const t = selected.entree?.mealType;
        return t === 'bowl' ? 1 : t === 'plate' ? 2 : 3;
      }

      function checkReady() {
        const totalAla = selected.ala.reduce((s, i) => s + i.qty, 0);
        const max = maxAla();
        const ready = selected.entree && selected.side && Math.abs(totalAla - max) < 0.01;

        const submitBtn = document.getElementById('submit-btn');
        submitBtn.disabled = !ready;

        if (ready) {
          const order = {
            entree: selected.entree ? { name: selected.entree.name, mealType: selected.entree.mealType } : null,
            side: selected.side ? { name: selected.side.name } : null,
            ala: selected.ala.map(i => ({ name: i.name, qty: i.qty })),
            drink: selected.drink ? { name: selected.drink.name } : null
          };
          document.getElementById('order-data').value = JSON.stringify(order);
        } else {
          document.getElementById('order-data').value = '';
        }
      }

      function updateAlaLabel(mealType) {
        const label = document.getElementById('ala-label');
        if (!mealType || !selected.entree) {
          label.innerHTML = 'Pick main items <button type="button" class="clear-btn" onclick="clearSection(\'ala\')">Clear</button>';
          return;
        }
        const count = mealType === 'bowl' ? 1 : mealType === 'plate' ? 2 : 3;
        label.innerHTML = `Pick ${count} main item${count > 1 ? 's' : ''} <button type="button" class="clear-btn" onclick="clearSection(\'ala\')">Clear</button>`;
      }

      /* --------------------------------------------------------------
         INIT
      -------------------------------------------------------------- */
      window.addEventListener('load', () => {
        const saved = sessionStorage.getItem('selectedEntree');
        if (saved) {
          try {
            selected.entree = JSON.parse(saved);
          } catch (e) {
            console.error("Failed to parse selectedEntree", e);
          }
        }
        renderAll();
        checkReady();
      });

      /* --------------------------------------------------------------
         SELECTION
      -------------------------------------------------------------- */
      function selectSide(btn) {
        pushUndo();
        const name = btn.dataset.name;
        selected.side = { name, qty: 1 };
        renderAll();
      }

      function selectAlaCarte(btn) {
        pushUndo();
        const name = btn.dataset.name;
        const inc = halfMode ? 0.5 : 1;

        const existing = selected.ala.find(i => i.name === name);
        if (existing) {
          existing.qty += inc;
        } else {
          selected.ala.push({ name, qty: inc });
        }

        // Trim excess
        let total = selected.ala.reduce((s, i) => s + i.qty, 0);
        const max = maxAla();
        if (total > max) {
          selected.ala.sort((a, b) => a.qty - b.qty);
          let excess = total - max;
          while (excess > 0 && selected.ala.length) {
            const first = selected.ala[0];
            if (first.qty <= excess) {
              excess -= first.qty;
              selected.ala.shift();
            } else {
              first.qty -= excess;
              excess = 0;
            }
          }
        }

        if (halfMode) {
          halfClicksLeft--;
          if (halfClicksLeft === 0) halfMode = false;
        }

        renderAll();
      }

      function selectDrink(btn) {
        pushUndo();
        const name = btn.dataset.name;
        if (selected.drink && selected.drink.name === name) {
          selected.drink = null;
        } else {
          selected.drink = { name, qty: 1 };
        }
        renderAll();
      }

      /* --------------------------------------------------------------
         HALF & UNDO
      -------------------------------------------------------------- */
      document.getElementById('half-btn').addEventListener('click', () => {
        if (halfMode && halfClicksLeft === 0) {
          halfMode = false;
        } else {
          halfMode = true;
          halfClicksLeft = 2;
        }
        renderAll();
      });

      document.getElementById('undo-btn').addEventListener('click', popUndo);

      function clearSection(type) {
        pushUndo();
        if (type === 'side') selected.side = null;
        else if (type === 'ala') selected.ala = [];
        else if (type === 'drink') selected.drink = null;
        renderAll();
      }

      // Prevent Enter key from submitting
      document.getElementById('plate-form').addEventListener('keydown', e => {
        if (e.key === 'Enter') e.preventDefault();
      });
    </script>
  </body>
</html>